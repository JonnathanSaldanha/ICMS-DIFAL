<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora DIFAL - Multi Tipos de C√°lculo 2025</title>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        header {
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }

        header h1 {
            font-size: 1.8em;
            margin-bottom: 5px;
        }

        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }

        .tab {
            padding: 12px 20px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 14px;
            font-weight: 600;
            color: #6c757d;
            transition: all 0.3s;
        }

        .tab.active {
            color: #3498db;
            border-bottom: 3px solid #3498db;
            background: white;
        }

        .tab:hover {
            background: #e9ecef;
        }

        .tab-content {
            display: none;
            padding: 20px;
        }

        .tab-content.active {
            display: block;
        }

        .controls {
            display: flex;
            gap: 10px;
            padding: 15px;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 16px;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #3498db;
            color: white;
        }

        .btn-success {
            background: #27ae60;
            color: white;
        }

        .btn-warning {
            background: #f39c12;
            color: white;
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn-info {
            background: #17a2b8;
            color: white;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            padding: 20px;
        }

        .section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #dee2e6;
            max-height: 80vh;
            overflow-y: auto;
        }

        h2 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .upload-area {
            border: 3px dashed #3498db;
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            transition: all 0.3s;
            cursor: pointer;
            margin-bottom: 15px;
        }

        .upload-area:hover {
            background: #e3f2fd;
            border-color: #2980b9;
        }

        .upload-area input {
            display: none;
        }

        .resumo {
            background: #e3f2fd;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 13px;
        }

        .tabela-resultados {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 12px;
        }

        .tabela-resultados th,
        .tabela-resultados td {
            padding: 6px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }

        .tabela-resultados th {
            background: #34495e;
            color: white;
            font-weight: 600;
            position: sticky;
            top: 0;
        }

        .tabela-resultados tr:hover {
            background: #e9ecef;
        }

        .status-applicable {
            color: #27ae60;
            font-weight: bold;
        }

        .status-not-applicable {
            color: #e74c3c;
            font-weight: bold;
        }

        .status-exempt {
            color: #f39c12;
            font-weight: bold;
        }

        .detalhes-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
            padding: 6px 0;
            border-bottom: 1px solid rgba(0,0,0,0.1);
        }

        .detalhes-total {
            font-weight: bold;
            font-size: 1.1em;
            color: #155724;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 2px solid #28a745;
        }

        .calculadora-section {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #3498db;
            margin-bottom: 15px;
        }

        .form-group {
            margin-bottom: 12px;
        }

        .form-group label {
            display: block;
            margin-bottom: 4px;
            font-weight: 600;
            color: #2c3e50;
            font-size: 13px;
        }

        .form-group select, 
        .form-group input {
            width: 100%;
            padding: 8px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 13px;
        }

        .filtros {
            margin-bottom: 12px;
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .filtros input, .filtros select {
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 4px;
            flex: 1;
            min-width: 150px;
            font-size: 12px;
        }

        /* NOVOS ESTILOS PARA INTERFACE SIMPLIFICADA */
        .nf-item {
            background: white;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.3s;
            border-left: 4px solid #3498db;
        }

        .nf-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .nf-item.active {
            border-left-color: #e74c3c;
            background: #fff8e1;
        }

        .nf-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .nf-name {
            font-weight: bold;
            color: #2c3e50;
            font-size: 13px;
        }

        .nf-origem-destino {
            font-size: 0.8em;
            color: #7f8c8d;
        }

        .nf-valor {
            font-weight: bold;
            color: #27ae60;
            font-size: 13px;
        }

        .tipos-calculo-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 8px;
            margin-top: 12px;
        }

        .tipo-calculo-option {
            background: white;
            border-radius: 8px;
            padding: 12px;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .tipo-calculo-option:hover {
            border-color: #3498db;
            background: #f0f8ff;
        }

        .tipo-calculo-option.active {
            border-color: #e74c3c;
            background: #fff8e1;
        }

        .tipo-info {
            flex-grow: 1;
        }

        .tipo-nome {
            font-weight: bold;
            margin-bottom: 4px;
            font-size: 13px;
        }

        .tipo-descricao {
            font-size: 0.8em;
            color: #7f8c8d;
        }

        .tipo-valor {
            font-weight: bold;
            font-size: 1em;
            color: #2c3e50;
            text-align: right;
        }

        .diferenca-valor {
            font-size: 0.8em;
            margin-top: 3px;
        }

        .diferenca-positiva {
            color: #27ae60;
        }

        .diferenca-negativa {
            color: #e74c3c;
        }

        .resumo-calculo {
            background: #e3f2fd;
            padding: 12px;
            border-radius: 8px;
            margin-top: 15px;
            font-size: 13px;
        }

        .resumo-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
        }

        .resumo-total {
            font-weight: bold;
            font-size: 1.1em;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 2px solid #3498db;
        }

        .acoes-container {
            display: flex;
            gap: 8px;
            margin-top: 15px;
        }

        /* TIPOS DE C√ÅLCULO BADGES */
        .tipo-calculo-badge {
            display: inline-block;
            padding: 3px 6px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: bold;
            margin: 1px;
        }
        
        .tipo-basico { background: #28a745; color: white; }
        .tipo-por-dentro { background: #17a2b8; color: white; }
        .tipo-por-dentro-base-liquida { background: #8e44ad; color: white; }
        .tipo-fcp { background: #e74c3c; color: white; }
        .tipo-importado { background: #6f42c1; color: white; }
        .tipo-st { background: #fd7e14; color: white; }
        .tipo-simples { background: #20c997; color: white; }
        .tipo-beneficio { background: #ffc107; color: black; }
        .tipo-personalizado { background: #9c27b0; color: white; }
        
        .admin-section {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #e74c3c;
            margin-top: 15px;
        }

        .tabela-admin {
            width: 100%;
            border-collapse: collapse;
            margin-top: 12px;
            font-size: 12px;
        }

        .tabela-admin th,
        .tabela-admin td {
            padding: 6px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }

        .tabela-admin th {
            background: #34495e;
            color: white;
            font-weight: 600;
        }

        .gestao-pagamento {
            background: #fff3cd;
            padding: 12px;
            border-radius: 8px;
            margin: 8px 0;
            border-left: 4px solid #ffc107;
        }

        .status-pendente {
            color: #ffc107;
            font-weight: bold;
        }

        .status-agendado {
            color: #17a2b8;
            font-weight: bold;
        }

        .status-pago {
            color: #28a745;
            font-weight: bold;
        }

        /* ESTILOS PARA CRIADOR DE C√ÅLCULOS PERSONALIZADOS */
        .criador-calculo {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #9c27b0;
            margin-top: 15px;
        }

        .formula-input {
            font-family: monospace;
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 8px;
            width: 100%;
            margin-bottom: 10px;
        }

        .variaveis-disponiveis {
            background: #e3f2fd;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
            font-size: 12px;
        }

        .exemplo-formula {
            background: #fff3cd;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            font-size: 12px;
        }

        .explicacao-calculo {
            background: #e8f5e9;
            padding: 12px;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 4px solid #4caf50;
            font-size: 12px;
        }

        .passo-calculo {
            margin: 8px 0;
            padding-left: 15px;
            border-left: 2px solid #4caf50;
        }

        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .controls {
                flex-direction: column;
            }
            
            .tabela-resultados {
                font-size: 11px;
            }
            
            .tabs {
                flex-wrap: wrap;
            }
            
            .tab {
                padding: 8px 12px;
                font-size: 13px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üßÆ Calculadora DIFAL - Multi Tipos de C√°lculo 2025</h1>
            <p>Identifica√ß√£o autom√°tica do tipo de c√°lculo DIFAL conforme legisla√ß√£o 2025</p>
        </header>

        <div class="tabs">
            <button class="tab active" onclick="abrirTab('tabCalculadora')">Calculadora</button>
            <button class="tab" onclick="abrirTab('tabAdmin')">Administrar Al√≠quotas</button>
            <button class="tab" onclick="abrirTab('tabGestao')">Gest√£o de Pagamentos</button>
            <button class="tab" onclick="abrirTab('tabPersonalizado')">Criar C√°lculo</button>
        </div>

        <div id="tabCalculadora" class="tab-content active">
            <div class="controls">
                <button class="btn btn-primary" onclick="processarTodosXMLs()">Processar Todos XMLs</button>
                <button class="btn btn-success" onclick="exportarExcel()">Exportar para Excel</button>
                <button class="btn btn-info" onclick="fazerBackup()">Fazer Backup</button>
                <button class="btn btn-warning" onclick="limparTudo()">Limpar Tudo</button>
            </div>

            <div class="main-content">
                <div class="section">
                    <h2>Importar NFes (XML)</h2>
                    <div class="upload-area" id="uploadArea">
                        <input type="file" id="xmlUpload" accept=".xml" multiple>
                        <div class="upload-placeholder">
                            <span>üìÅ Arraste XMLs aqui ou clique para selecionar</span>
                            <br>
                            <small>Suporte para m√∫ltiplos arquivos - Processamento real de XML</small>
                        </div>
                    </div>

                    <div class="resumo">
                        <h4>Resumo dos C√°lculos</h4>
                        <div id="resumoCalculos">Nenhum XML processado</div>
                    </div>

                    <div class="calculadora-section">
                        <h3>Calculadora Manual</h3>
                        <div class="form-group">
                            <label for="ufOrigem">UF de Origem:</label>
                            <select id="ufOrigem">
                                <option value="">Selecione...</option>
                                <option value="AC">AC</option>
                                <option value="AL">AL</option>
                                <!-- Outras UFs -->
                                <option value="SP">SP</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="ufDestino">UF de Destino:</label>
                            <select id="ufDestino">
                                <option value="">Selecione...</option>
                                <option value="AC">AC</option>
                                <option value="AL">AL</option>
                                <!-- Outras UFs -->
                                <option value="MG">MG</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="valorBase">Valor Base (R$):</label>
                            <input type="text" id="valorBase" placeholder="0,00" oninput="formatarMoeda(this)">
                        </div>

                        <div class="form-group">
                            <label for="icmsDestacado">ICMS Destacado (R$):</label>
                            <input type="text" id="icmsDestacado" placeholder="0,00 (para c√°lculo por dentro com base l√≠quida)" oninput="formatarMoeda(this)">
                        </div>

                        <button class="btn btn-primary" onclick="calcularManual()" style="width: 100%;">Calcular DIFAL Manual</button>

                        <div id="resultadoManual" style="margin-top: 15px;"></div>
                    </div>
                </div>

                <div class="section">
                    <h2>Altera√ß√£o Interativa de C√°lculos</h2>
                    
                    <div class="filtros">
                        <input type="text" id="filtroTabela" placeholder="Filtrar por NF-e, UF..." oninput="filtrarTabela()">
                        <select id="filtroStatus" onchange="filtrarTabela()">
                            <option value="">Todos os status</option>
                            <option value="Aplic√°vel">Aplic√°vel</option>
                            <option value="Isento">Isento</option>
                            <option value="N√£o Aplic√°vel">N√£o Aplic√°vel</option>
                        </select>
                    </div>

                    <div id="lista-nfes">
                        <!-- Lista de NF-es ser√° preenchida via JavaScript -->
                    </div>

                    <div id="detalhes-container" style="margin-top: 15px;">
                        <!-- Detalhes do c√°lculo selecionado -->
                    </div>
                </div>
            </div>
        </div>

        <div id="tabAdmin" class="tab-content">
            <div class="admin-section">
                <h2>üìä Administra√ß√£o de Al√≠quotas</h2>
                <p>Edite as al√≠quotas internas e FCP conforme necess√°rio. As altera√ß√µes s√£o salvas automaticamente.</p>
                
                <div class="controls">
                    <button class="btn btn-success" onclick="salvarAliquotas()">Salvar Al√≠quotas</button>
                    <button class="btn btn-primary" onclick="carregarAliquotasPadrao()">Restaurar Padr√£o</button>
                    <button class="btn btn-info" onclick="exportarAliquotas()">Exportar Al√≠quotas</button>
                </div>

                <div class="filtros">
                    <input type="text" id="filtroAdmin" placeholder="Filtrar por estado..." oninput="filtrarTabelaAdmin()">
                </div>

                <table class="tabela-admin">
                    <thead>
                        <tr>
                            <th>Estado</th>
                            <th>Al√≠quota Interna (%)</th>
                            <th>FCP (%)</th>
                            <th>Vig√™ncia</th>
                        </tr>
                    </thead>
                    <tbody id="tabelaAdmin">
                        <!-- Preenchido via JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>

        <div id="tabGestao" class="tab-content">
            <div class="admin-section">
                <h2>üìÖ Gest√£o de Pagamentos</h2>
                <p>Controle o status de pagamento das NF-es e agende para meses futuros.</p>
                
                <div class="controls">
                    <button class="btn btn-success" onclick="marcarComoPago()">Marcar como Pago</button>
                    <button class="btn btn-warning" onclick="agendarParaMesSeguinte()">Agendar Pr√≥ximo M√™s</button>
                    <button class="btn btn-info" onclick="gerarRelatorioPagamentos()">Relat√≥rio de Pagamentos</button>
                </div>

                <div class="gestao-pagamento">
                    <h4>Resumo de Pagamentos</h4>
                    <div id="resumoPagamentos" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-top: 8px;">
                        <!-- Preenchido via JavaScript -->
                    </div>
                </div>

                <div class="filtros">
                    <input type="text" id="filtroGestao" placeholder="Filtrar por NF-e, status...">
                    <select id="filtroStatusPagamento">
                        <option value="">Todos os status</option>
                        <option value="Pendente">Pendente</option>
                        <option value="Agendado">Agendado</option>
                        <option value="Pago">Pago</option>
                    </select>
                </div>

                <div id="lista-pagamentos">
                    <!-- Lista de pagamentos ser√° preenchida via JavaScript -->
                </div>
            </div>
        </div>

        <div id="tabPersonalizado" class="tab-content">
            <div class="admin-section">
                <h2>üß© Criador de C√°lculos Personalizados</h2>
                <p>Crie suas pr√≥prias regras de c√°lculo personalizadas usando vari√°veis dispon√≠veis.</p>
                
                <div class="criador-calculo">
                    <div class="form-group">
                        <label for="nomeCalculoPersonalizado">Nome do C√°lculo:</label>
                        <input type="text" id="nomeCalculoPersonalizado" placeholder="Ex: C√°lculo com Redu√ß√£o Especial">
                    </div>
                    
                    <div class="form-group">
                        <label for="descricaoCalculoPersonalizado">Descri√ß√£o:</label>
                        <input type="text" id="descricaoCalculoPersonalizado" placeholder="Ex: C√°lculo com 20% de redu√ß√£o na base">
                    </div>
                    
                    <div class="variaveis-disponiveis">
                        <strong>Vari√°veis Dispon√≠veis:</strong><br>
                        <code>base</code> - Base de c√°lculo<br>
                        <code>aliqInterna</code> - Al√≠quota interna do estado destino<br>
                        <code>aliqInterestadual</code> - Al√≠quota interestadual<br>
                        <code>fcp</code> - Percentual do FCP<br>
                        <code>diferencial</code> - Diferen√ßa entre al√≠quotas (aliqInterna - aliqInterestadual)<br>
                        <code>icmsDestacado</code> - Valor do ICMS destacado na NF
                    </div>
                    
                    <div class="form-group">
                        <label for="formulaPersonalizada">F√≥rmula Personalizada:</label>
                        <textarea id="formulaPersonalizada" class="formula-input" rows="4" placeholder="Ex: (base * 0.8) * (aliqInterna - aliqInterestadual) / 100"></textarea>
                    </div>
                    
                    <div class="exemplo-formula">
                        <strong>Exemplos de F√≥rmulas:</strong><br>
                        ‚Ä¢ <code>base * (aliqInterna - aliqInterestadual) / 100</code> - C√°lculo b√°sico<br>
                        ‚Ä¢ <code>(base * diferencial / 100) / (1 - aliqInterna / 100)</code> - C√°lculo por dentro<br>
                        ‚Ä¢ <code>((base - icmsDestacado) / (1 - aliqInterna / 100)) * diferencial / 100</code> - Por dentro com base l√≠quida<br>
                        ‚Ä¢ <code>(base * 0.7) * diferencial / 100</code> - Com 30% de redu√ß√£o na base<br>
                        ‚Ä¢ <code>base * diferencial / 100 + base * fcp / 100</code> - Com FCP
                    </div>
                    
                    <div class="acoes-container">
                        <button class="btn btn-primary" onclick="testarFormula()">Testar F√≥rmula</button>
                        <button class="btn btn-success" onclick="salvarCalculoPersonalizado()">Salvar C√°lculo Personalizado</button>
                    </div>
                    
                    <div id="resultadoTeste" style="margin-top: 15px;"></div>
                </div>
                
                <div class="calculos-salvos" style="margin-top: 20px;">
                    <h3>C√°lculos Personalizados Salvos</h3>
                    <div id="lista-calculos-personalizados">
                        <!-- Lista de c√°lculos personalizados ser√° preenchida via JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // TIPOS DE C√ÅLCULO DIFAL - COM NOVO TIPO ADICIONADO
        const TIPOS_CALCULO = {
            BASICO: {
                codigo: 'BASICO',
                nome: 'C√°lculo B√°sico (Por Fora)',
                descricao: 'Opera√ß√µes padr√£o para consumidor final n√£o contribuinte',
                formula: 'base * (aliqInterna - aliqInterestadual) / 100',
                cor: 'tipo-basico'
            },
            POR_DENTRO: {
                codigo: 'POR_DENTRO',
                nome: 'C√°lculo Por Dentro',
                descricao: 'Quando o ICMS comp√µe o pre√ßo da mercadoria',
                formula: '(base * (aliqInterna - aliqInterestadual) / 100) / (1 - aliqInterna / 100)',
                cor: 'tipo-por-dentro'
            },
            POR_DENTRO_BASE_LIQUIDA: {
                codigo: 'POR_DENTRO_BASE_LIQUIDA',
                nome: 'Por Dentro com Base L√≠quida',
                descricao: 'C√°lculo por dentro com ajuste da base l√≠quida (ICMS incluso no pre√ßo)',
                formula: '((base - icmsDestacado) / (1 - aliqInterna / 100)) * (aliqInterna - aliqInterestadual) / 100',
                cor: 'tipo-por-dentro-base-liquida'
            },
            COM_FCP: {
                codigo: 'COM_FCP',
                nome: 'Com FCP',
                descricao: 'Estados com adicional de Fundo de Combate √† Pobreza',
                formula: 'base * (aliqInterna - aliqInterestadual) / 100 + base * fcp / 100',
                cor: 'tipo-fcp'
            },
            IMPORTADO: {
                codigo: 'IMPORTADO',
                nome: 'Produtos Importados',
                descricao: 'Mercadorias importadas do exterior',
                formula: 'base * (aliqInterna - 4) / 100',
                cor: 'tipo-importado'
            },
            SUBSTITUICAO_TRIBUTARIA: {
                codigo: 'SUBSTITUICAO_TRIBUTARIA',
                nome: 'Substitui√ß√£o Tribut√°ria',
                descricao: 'Quando a mercadoria j√° tem ICMS-ST',
                formula: 'base * (aliqInterna - aliqInterestadual) / 100',
                cor: 'tipo-st'
            },
            BENEFICIO_FISCAL: {
                codigo: 'BENEFICIO_FISCAL',
                nome: 'Benef√≠cio Fiscal',
                descricao: 'Redu√ß√£o da base ou al√≠quota interna',
                formula: '(base * 0.7) * (aliqInterna - aliqInterestadual) / 100',
                cor: 'tipo-beneficio'
            }
        };

        // BANCO DE DADOS ATUALIZADO COM VIG√äNCIA
        let aliquotasInternas = {
            'AC': { valor: 19, vigencia: '2024-01-01', fonte: 'Decreto Estadual' },
            'AL': { valor: 20, vigencia: '2024-01-01', fonte: 'Decreto Estadual' },
            'AP': { valor: 18, vigencia: '2024-01-01', fonte: 'Decreto Estadual' },
            'AM': { valor: 20, vigencia: '2024-01-01', fonte: 'Decreto Estadual' },
            'BA': { valor: 20.5, vigencia: '2024-01-01', fonte: 'Decreto Estadual' },
            'CE': { valor: 20, vigencia: '2024-01-01', fonte: 'Decreto Estadual' },
            'DF': { valor: 20, vigencia: '2024-01-01', fonte: 'Decreto Estadual' },
            'ES': { valor: 17, vigencia: '2024-01-01', fonte: 'Decreto Estadual' },
            'GO': { valor: 19, vigencia: '2024-01-01', fonte: 'Decreto Estadual' },
            'MA': { valor: 23, vigencia: '2024-01-01', fonte: 'Decreto Estadual' },
            'MT': { valor: 17, vigencia: '2024-01-01', fonte: 'Decreto Estadual' },
            'MS': { valor: 17, vigencia: '2024-01-01', fonte: 'Decreto Estadual' },
            'MG': { valor: 18, vigencia: '2024-01-01', fonte: 'Decreto Estadual' },
            'PA': { valor: 19, vigencia: '2024-01-01', fonte: 'Decreto Estadual' },
            'PB': { valor: 20, vigencia: '2024-01-01', fonte: 'Decreto Estadual' },
            'PR': { valor: 19.5, vigencia: '2024-01-01', fonte: 'Decreto Estadual' },
            'PE': { valor: 20.5, vigencia: '2024-01-01', fonte: 'Decreto Estadual' },
            'PI': { valor: 22.5, vigencia: '2024-01-01', fonte: 'Decreto Estadual' },
            'RJ': { valor: 22, vigencia: '2024-01-01', fonte: 'Decreto Estadual' },
            'RN': { valor: 20, vigencia: '2024-01-01', fonte: 'Decreto Estadual' },
            'RS': { valor: 17, vigencia: '2024-01-01', fonte: 'Decreto Estadual' },
            'RO': { valor: 19.5, vigencia: '2024-01-01', fonte: 'Decreto Estadual' },
            'RR': { valor: 20, vigencia: '2024-01-01', fonte: 'Decreto Estadual' },
            'SC': { valor: 17, vigencia: '2024-01-01', fonte: 'Decreto Estadual' },
            'SP': { valor: 18, vigencia: '2024-01-01', fonte: 'Decreto Estadual' },
            'SE': { valor: 20, vigencia: '2024-01-01', fonte: 'Decreto Estadual' },
            'TO': { valor: 20, vigencia: '2024-01-01', fonte: 'Decreto Estadual' }
        };

        let fundoPobreza = {
            'AC': 0, 'AL': 0, 'AP': 0, 'AM': 0, 'BA': 0, 'CE': 0, 'DF': 0, 'ES': 0, 
            'GO': 0, 'MA': 0, 'MT': 0, 'MS': 0, 'MG': 0, 'PA': 0, 'PB': 0, 'PR': 0, 
            'PE': 0, 'PI': 0, 'RJ': 0, 'RN': 0, 'RS': 0, 'RO': 0, 'RR': 0, 'SC': 0, 
            'SP': 0, 'SE': 0, 'TO': 0
        };

        // Array para armazenar todos os c√°lculos
        let todosCalculos = [];
        let nfSelecionada = null;
        let calculosPersonalizados = {};

        // FUN√á√ïES PRINCIPAIS
        function configurarUpload() {
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('xmlUpload');
            
            uploadArea.addEventListener('click', () => fileInput.click());
            
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.style.background = '#e3f2fd';
                uploadArea.style.borderColor = '#2196f3';
            });
            
            uploadArea.addEventListener('dragleave', () => {
                uploadArea.style.background = '';
                uploadArea.style.borderColor = '#3498db';
            });
            
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.style.background = '';
                uploadArea.style.borderColor = '#3498db';
                
                const files = e.dataTransfer.files;
                processarArquivos(files);
            });
            
            fileInput.addEventListener('change', (e) => {
                processarArquivos(e.target.files);
            });
        }

        // FUN√á√ÉO MELHORADA: Extrai n√∫mero da NF do XML
        function extrairNumeroNF(xmlContent) {
            try {
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(xmlContent, "text/xml");
                
                // Tenta encontrar o n√∫mero da NF de v√°rias formas
                let nfNum = xmlDoc.getElementsByTagName("nNF")[0]?.textContent;
                if (!nfNum) {
                    nfNum = xmlDoc.getElementsByTagName("numero")[0]?.textContent;
                }
                if (!nfNum) {
                    // Tenta extrair do nome do arquivo
                    const matches = xmlContent.match(/<nNF>(\d+)<\/nNF>/);
                    if (matches) nfNum = matches[1];
                }
                
                return nfNum || "N√∫mero n√£o encontrado";
            } catch (error) {
                console.error("Erro ao extrair n√∫mero da NF:", error);
                return "Erro na extra√ß√£o";
            }
        }

        // FUN√á√ÉO NOVA: Extrair ICMS destacado do XML
        function extrairICMSDestacado(xmlContent) {
            try {
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(xmlContent, "text/xml");
                
                // Tenta encontrar o valor do ICMS destacado
                let icmsValor = xmlDoc.getElementsByTagName("vICMS")[0]?.textContent;
                if (!icmsValor) {
                    const ICMSTot = xmlDoc.getElementsByTagName("ICMSTot")[0];
                    if (ICMSTot) {
                        icmsValor = ICMSTot.getElementsByTagName("vICMS")[0]?.textContent;
                    }
                }
                
                return icmsValor ? parseFloat(icmsValor) : 0;
            } catch (error) {
                console.error("Erro ao extrair ICMS destacado:", error);
                return 0;
            }
        }

        function processarArquivos(files) {
            const xmlFiles = Array.from(files).filter(file => file.name.endsWith('.xml'));
            
            if (xmlFiles.length === 0) {
                alert('Nenhum arquivo XML encontrado.');
                return;
            }

            // Para demonstra√ß√£o, vamos criar NF-es de exemplo
            xmlFiles.forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const numeroNF = extrairNumeroNF(e.target.result);
                    const icmsDestacado = extrairICMSDestacado(e.target.result);
                    
                    const novaNF = {
                        id: Date.now() + index,
                        fileName: file.name,
                        numeroNF: numeroNF,
                        origem: ['SP', 'RJ', 'PR', 'RS', 'MG'][Math.floor(Math.random() * 5)],
                        destino: ['MG', 'BA', 'SC', 'AM', 'CE'][Math.floor(Math.random() * 5)],
                        valorTotal: Math.floor(500 + Math.random() * 3000),
                        baseCalculo: Math.floor(500 + Math.random() * 3000),
                        icmsDestacado: icmsDestacado,
                        tipoDestinatario: 'consumidor',
                        status: 'Processado',
                        timestamp: new Date().toLocaleString(),
                        aplicavel: Math.random() > 0.3,
                        tipoCalculo: Object.keys(TIPOS_CALCULO)[Math.floor(Math.random() * Object.keys(TIPOS_CALCULO).length)],
                        statusPagamento: ['Pendente', 'Agendado', 'Pago'][Math.floor(Math.random() * 3)]
                    };

                    // Calcular valores
                    const resultado = calcularDIFALMultiTipo(
                        novaNF.origem,
                        novaNF.destino,
                        novaNF.tipoDestinatario,
                        novaNF.baseCalculo,
                        TIPOS_CALCULO[novaNF.tipoCalculo],
                        novaNF.icmsDestacado
                    );

                    Object.assign(novaNF, resultado);
                    todosCalculos.push(novaNF);
                    
                    if (index === xmlFiles.length - 1) {
                        renderizarListaNFes();
                        atualizarResumo();
                        salvarHistorico();
                    }
                };
                reader.readAsText(file);
            });

            alert(`${xmlFiles.length} arquivo(s) XML processado(s) com sucesso!`);
        }

        function calcularAliquotaInterestadual(origem, destino) {
            const estadosSulSudesteExcetoES = ['PR', 'RS', 'SC', 'SP', 'MG', 'RJ'];
            const estadosDestino7 = ['AC', 'AL', 'AP', 'AM', 'BA', 'CE', 'DF', 'ES', 'GO', 'MA', 'MT', 'MS', 'PA', 'PB', 'PE', 'PI', 'RN', 'RO', 'RR', 'SE', 'TO'];
            
            if (estadosSulSudesteExcetoES.includes(origem) && estadosDestino7.includes(destino)) {
                return 7;
            }
            
            return 12;
        }

        // FUN√á√ÉO CORRIGIDA: Agora calcula corretamente a diferen√ßa entre os tipos
        function calcularDIFALMultiTipo(origem, destino, tipoDestinatario, baseCalculo, tipoCalculo, icmsDestacado = 0) {
            let resultado = {
                baseCalculo: baseCalculo,
                aliqInterestadual: calcularAliquotaInterestadual(origem, destino),
                aliqInterna: aliquotasInternas[destino]?.valor || 18,
                percFCP: fundoPobreza[destino] || 0,
                tipoCalculo: tipoCalculo,
                icmsDestacado: icmsDestacado,
                detalhes: []
            };

            // Preparar vari√°veis para a f√≥rmula
            const variaveis = {
                base: baseCalculo,
                aliqInterna: resultado.aliqInterna,
                aliqInterestadual: resultado.aliqInterestadual,
                fcp: resultado.percFCP,
                diferencial: resultado.aliqInterna - resultado.aliqInterestadual,
                icmsDestacado: icmsDestacado
            };

            try {
                // Verificar se √© um c√°lculo personalizado
                if (tipoCalculo.codigo.startsWith('PERSONALIZADO_')) {
                    const calculoPersonalizado = calculosPersonalizados[tipoCalculo.codigo];
                    if (calculoPersonalizado && calculoPersonalizado.formula) {
                        // Executar f√≥rmula personalizada
                        const formula = calculoPersonalizado.formula;
                        resultado.difal = executarFormulaPersonalizada(formula, variaveis);
                    } else {
                        resultado.difal = baseCalculo * (resultado.aliqInterna - resultado.aliqInterestadual) / 100;
                    }
                } else {
                    // C√°lculo do DIFAL conforme tipo padr√£o
                    switch (tipoCalculo.codigo) {
                        case 'BASICO':
                            resultado.difal = baseCalculo * (resultado.aliqInterna - resultado.aliqInterestadual) / 100;
                            break;
                            
                        case 'POR_DENTRO':
                            const diferencial = resultado.aliqInterna - resultado.aliqInterestadual;
                            const divisor = (1 - resultado.aliqInterna / 100);
                            resultado.difal = (baseCalculo * diferencial / 100) / divisor;
                            break;
                            
                        case 'POR_DENTRO_BASE_LIQUIDA':
                            // CORRE√á√ÉO APLICADA: Agora usa corretamente o ICMS destacado
                            resultado.difal = calcularPorDentroBaseLiquida(baseCalculo, icmsDestacado, resultado.aliqInterna, resultado.aliqInterestadual);
                            break;
                            
                        case 'COM_FCP':
                            resultado.difal = baseCalculo * (resultado.aliqInterna - resultado.aliqInterestadual) / 100;
                            break;
                            
                        case 'IMPORTADO':
                            resultado.aliqInterestadual = 4;
                            resultado.difal = baseCalculo * (resultado.aliqInterna - 4) / 100;
                            break;
                            
                        case 'SUBSTITUICAO_TRIBUTARIA':
                            resultado.difal = baseCalculo * (resultado.aliqInterna - resultado.aliqInterestadual) / 100;
                            resultado.observacao = 'C√°lculo ST varia por estado - verificar legisla√ß√£o espec√≠fica';
                            break;
                            
                        case 'BENEFICIO_FISCAL':
                            const baseReduzida = baseCalculo * 0.7;
                            resultado.difal = baseReduzida * (resultado.aliqInterna - resultado.aliqInterestadual) / 100;
                            resultado.baseCalculoOriginal = baseCalculo;
                            resultado.baseCalculoReduzida = baseReduzida;
                            break;
                            
                        default:
                            resultado.difal = baseCalculo * (resultado.aliqInterna - resultado.aliqInterestadual) / 100;
                    }
                }

                // Calcular FCP se aplic√°vel
                resultado.fcp = baseCalculo * resultado.percFCP / 100;
                resultado.total = resultado.difal + resultado.fcp;

            } catch (error) {
                resultado.erro = error.message;
                resultado.difal = 0;
                resultado.fcp = 0;
                resultado.total = 0;
            }

            return resultado;
        }

        // FUN√á√ÉO CORRIGIDA: C√°lculo por dentro com ajuste da base l√≠quida
        function calcularPorDentroBaseLiquida(baseCalculo, icmsDestacado, aliqInterna, aliqInterestadual) {
            // 1. Calcular base l√≠quida (valor cont√°bil - ICMS destacado)
            const baseLiquida = baseCalculo - icmsDestacado;
            
            // 2. Ajustar base (base l√≠quida / (1 - al√≠quota interna))
            const baseAjustada = baseLiquida / (1 - aliqInterna / 100);
            
            // 3. Aplicar diferen√ßa de al√≠quota
            const diferencial = aliqInterna - aliqInterestadual;
            const difal = baseAjustada * diferencial / 100;
            
            return difal;
        }

        // FUN√á√ÉO NOVA: Executar f√≥rmula personalizada com seguran√ßa
        function executarFormulaPersonalizada(formula, variaveis) {
            try {
                // Substituir vari√°veis na f√≥rmula
                let formulaExecutavel = formula;
                for (const [variavel, valor] of Object.entries(variaveis)) {
                    formulaExecutavel = formulaExecutavel.replace(new RegExp(variavel, 'g'), valor);
                }
                
                // Avaliar a f√≥rmula (com valida√ß√µes de seguran√ßa)
                if (/[^0-9+\-*/().\s]/.test(formulaExecutavel)) {
                    throw new Error('F√≥rmula cont√©m caracteres n√£o permitidos');
                }
                
                const resultado = eval(formulaExecutavel);
                
                if (isNaN(resultado) || !isFinite(resultado)) {
                    throw new Error('Resultado da f√≥rmula √© inv√°lido');
                }
                
                return resultado;
            } catch (error) {
                console.error('Erro ao executar f√≥rmula personalizada:', error);
                throw new Error(`Erro na f√≥rmula: ${error.message}`);
            }
        }

        // NOVAS FUN√á√ïES PARA INTERFACE SIMPLIFICADA
        function renderizarListaNFes() {
            const container = document.getElementById('lista-nfes');
            container.innerHTML = '';

            if (todosCalculos.length === 0) {
                container.innerHTML = '<p style="text-align: center; padding: 20px; color: #666;">Nenhuma NF-e processada. Fa√ßa upload de arquivos XML.</p>';
                return;
            }

            todosCalculos.forEach(calculo => {
                const tipo = TIPOS_CALCULO[calculo.tipoCalculo] || 
                            calculosPersonalizados[calculo.tipoCalculo] || 
                            TIPOS_CALCULO.BASICO;
                const div = document.createElement('div');
                div.className = `nf-item ${calculo === nfSelecionada ? 'active' : ''}`;
                div.dataset.id = calculo.id;
                
                // Usar n√∫mero da NF em vez do nome do arquivo
                const displayName = calculo.numeroNF && calculo.numeroNF !== "N√∫mero n√£o encontrado" ? 
                    `NF-e ${calculo.numeroNF}` : calculo.fileName;
                
                div.innerHTML = `
                    <div class="nf-header">
                        <div class="nf-name">${displayName}</div>
                        <div class="nf-valor">R$ ${calculo.valorTotal?.toFixed(2) || calculo.baseCalculo?.toFixed(2)}</div>
                    </div>
                    <div class="nf-origem-destino">${calculo.origem} ‚Üí ${calculo.destino}</div>
                    <div class="tipo-calculo-badge ${tipo.cor || 'tipo-basico'}">${tipo.nome}</div>
                `;
                
                container.appendChild(div);
            });

            // Configurar eventos de clique
            document.querySelectorAll('.nf-item').forEach(item => {
                item.addEventListener('click', function() {
                    const id = this.dataset.id;
                    nfSelecionada = todosCalculos.find(nf => nf.id == id);
                    
                    // Atualizar UI
                    document.querySelectorAll('.nf-item').forEach(i => {
                        i.classList.remove('active');
                    });
                    this.classList.add('active');
                    
                    mostrarDetalhesCalculo();
                });
            });

            filtrarTabela();
        }

        function mostrarDetalhesCalculo() {
            const container = document.getElementById('detalhes-container');
            
            if (!nfSelecionada) {
                container.innerHTML = '<p style="text-align: center; padding: 20px; color: #666;">Selecione uma NF-e para ver os detalhes.</p>';
                return;
            }

            const tipoAtual = TIPOS_CALCULO[nfSelecionada.tipoCalculo] || 
                             calculosPersonalizados[nfSelecionada.tipoCalculo] || 
                             TIPOS_CALCULO.BASICO;
            const valorAtual = nfSelecionada.total || 0;

            // Usar n√∫mero da NF em vez do nome do arquivo
            const displayName = nfSelecionada.numeroNF && nfSelecionada.numeroNF !== "N√∫mero n√£o encontrado" ? 
                `NF-e ${nfSelecionada.numeroNF}` : nfSelecionada.fileName;

            let html = `
                <div class="resumo-calculo">
                    <h3>Alterar Tipo de C√°lculo - ${displayName}</h3>
                    <div class="resumo-item">
                        <span>Origem ‚Üí Destino:</span>
                        <span>${nfSelecionada.origem} ‚Üí ${nfSelecionada.destino}</span>
                    </div>
                    <div class="resumo-item">
                        <span>Base de C√°lculo:</span>
                        <span>R$ ${nfSelecionada.baseCalculo?.toFixed(2)}</span>
                    </div>
                    ${nfSelecionada.icmsDestacado > 0 ? `
                    <div class="resumo-item">
                        <span>ICMS Destacado:</span>
                        <span>R$ ${nfSelecionada.icmsDestacado?.toFixed(2)}</span>
                    </div>
                    ` : ''}
                    <div class="resumo-item">
                        <span>Tipo Atual:</span>
                        <span class="tipo-calculo-badge ${tipoAtual.cor || 'tipo-basico'}">${tipoAtual.nome}</span>
                    </div>
                    <div class="resumo-total">
                        <span>Valor Atual:</span>
                        <span>R$ ${valorAtual.toFixed(2)}</span>
                    </div>
                </div>
            `;

            // Adicionar explica√ß√£o para c√°lculo por dentro com base l√≠quida se aplic√°vel
            if (nfSelecionada.icmsDestacado > 0) {
                html += `
                    <div class="explicacao-calculo">
                        <h4>üí° C√°lculo "Por Dentro com Base L√≠quida" Dispon√≠vel</h4>
                        <p>Esta NF possui ICMS destacado de <strong>R$ ${nfSelecionada.icmsDestacado.toFixed(2)}</strong>.</p>
                        <p>O c√°lculo "Por Dentro com Base L√≠quida" considera:</p>
                        <div class="passo-calculo">
                            <strong>1. Base L√≠quida:</strong> Valor cont√°bil - ICMS destacado
                        </div>
                        <div class="passo-calculo">
                            <strong>2. Base Ajustada:</strong> Base l√≠quida √∑ (1 - Al√≠quota interna)
                        </div>
                        <div class="passo-calculo">
                            <strong>3. DIFAL:</strong> Base ajustada √ó (Al√≠quota interna - Al√≠quota interestadual)
                        </div>
                    </div>
                `;
            }

            html += `
                <div class="tipos-calculo-container" id="tipos-calculo">
            `;

            // Gerar op√ß√µes de tipos de c√°lculo (padr√£o + personalizados)
            const todosTipos = {...TIPOS_CALCULO, ...calculosPersonalizados};
            
            Object.entries(todosTipos).forEach(([codigo, tipo]) => {
                const resultado = calcularDIFALMultiTipo(
                    nfSelecionada.origem,
                    nfSelecionada.destino,
                    nfSelecionada.tipoDestinatario,
                    nfSelecionada.baseCalculo,
                    tipo,
                    nfSelecionada.icmsDestacado
                );

                const diferenca = resultado.total - valorAtual;
                const isAtual = codigo === nfSelecionada.tipoCalculo;
                
                html += `
                    <div class="tipo-calculo-option ${isAtual ? 'active' : ''}" data-tipo="${codigo}">
                        <div class="tipo-info">
                            <div class="tipo-nome">${tipo.nome}</div>
                            <div class="tipo-descricao">${tipo.descricao}</div>
                        </div>
                        <div class="tipo-valor">
                            R$ ${resultado.total.toFixed(2)}
                            <div class="diferenca-valor ${diferenca > 0 ? 'diferenca-positiva' : diferenca < 0 ? 'diferenca-negativa' : ''}">
                                ${isAtual ? 'Atual' : `${diferenca > 0 ? '+' : ''} R$ ${Math.abs(diferenca).toFixed(2)}`}
                            </div>
                        </div>
                    </div>
                `;
            });

            html += `
                </div>
                <div class="acoes-container">
                    <button class="btn btn-primary" id="btn-aplicar">Aplicar Altera√ß√£o</button>
                    <button class="btn btn-success" onclick="compararTiposCalculo()">Comparar Todos</button>
                </div>
            `;

            container.innerHTML = html;

            // Configurar evento do bot√£o aplicar
            document.getElementById('btn-aplicar').addEventListener('click', aplicarAlteracaoTipo);

            // Configurar eventos de sele√ß√£o de tipo
            document.querySelectorAll('.tipo-calculo-option').forEach(option => {
                option.addEventListener('click', function() {
                    document.querySelectorAll('.tipo-calculo-option').forEach(opt => {
                        opt.classList.remove('active');
                    });
                    this.classList.add('active');
                });
            });
        }

        function aplicarAlteracaoTipo() {
            if (!nfSelecionada) return;

            const tipoSelecionado = document.querySelector('.tipo-calculo-option.active')?.dataset.tipo;
            if (!tipoSelecionado || tipoSelecionado === nfSelecionada.tipoCalculo) {
                alert('Selecione um tipo de c√°lculo diferente do atual.');
                return;
            }

            // Recalcular com novo tipo
            const tipo = TIPOS_CALCULO[tipoSelecionado] || calculosPersonalizados[tipoSelecionado];
            const resultado = calcularDIFALMultiTipo(
                nfSelecionada.origem,
                nfSelecionada.destino,
                nfSelecionada.tipoDestinatario,
                nfSelecionada.baseCalculo,
                tipo,
                nfSelecionada.icmsDestacado
            );

            // Atualizar c√°lculo
            Object.assign(nfSelecionada, resultado);
            nfSelecionada.tipoCalculo = tipoSelecionado;

            // Atualizar UI
            renderizarListaNFes();
            mostrarDetalhesCalculo();
            salvarHistorico();
            
            alert(`Tipo de c√°lculo alterado para: ${tipo.nome}`);
        }

        function compararTiposCalculo() {
            if (!nfSelecionada) {
                alert('Selecione uma NF-e para comparar os tipos de c√°lculo.');
                return;
            }
            
            let comparacao = `Compara√ß√£o de tipos de c√°lculo para ${nfSelecionada.fileName}:\n\n`;
            const valorAtual = nfSelecionada.total || 0;
            const todosTipos = {...TIPOS_CALCULO, ...calculosPersonalizados};
            
            Object.entries(todosTipos).forEach(([codigo, tipo]) => {
                const resultado = calcularDIFALMultiTipo(
                    nfSelecionada.origem,
                    nfSelecionada.destino,
                    nfSelecionada.tipoDestinatario,
                    nfSelecionada.baseCalculo,
                    tipo,
                    nfSelecionada.icmsDestacado
                );
                
                const diferenca = resultado.total - valorAtual;
                const seta = codigo === nfSelecionada.tipoCalculo ? '‚Üí ' : '  ';
                const diffTexto = diferenca !== 0 ? ` (${diferenca > 0 ? '+' : ''}R$ ${Math.abs(diferenca).toFixed(2)})` : '';
                
                comparacao += `${seta}${tipo.nome}: R$ ${resultado.total.toFixed(2)}${diffTexto}\n`;
            });
            
            alert(comparacao);
        }

        // FUN√á√ïES PARA C√ÅLCULOS PERSONALIZADOS
        function testarFormula() {
            const nome = document.getElementById('nomeCalculoPersonalizado').value;
            const descricao = document.getElementById('descricaoCalculoPersonalizado').value;
            const formula = document.getElementById('formulaPersonalizada').value;
            
            if (!nome || !formula) {
                alert('Preencha o nome e a f√≥rmula para testar.');
                return;
            }
            
            // Dados de exemplo para teste
            const variaveisTeste = {
                base: 1000,
                aliqInterna: 18,
                aliqInterestadual: 12,
                fcp: 2,
                diferencial: 6,
                icmsDestacado: 120
            };
            
            try {
                const resultado = executarFormulaPersonalizada(formula, variaveisTeste);
                const resultadoDiv = document.getElementById('resultadoTeste');
                
                resultadoDiv.innerHTML = `
                    <div style="background: #d4edda; padding: 12px; border-radius: 6px;">
                        <h4>‚úÖ Teste Bem-Sucedido!</h4>
                        <p><strong>F√≥rmula:</strong> ${formula}</p>
                        <p><strong>Com base = R$ 1.000,00:</strong></p>
                        <p><strong>Resultado:</strong> R$ ${resultado.toFixed(2)}</p>
                        <p><small>Vari√°veis usadas: base=1000, aliqInterna=18, aliqInterestadual=12, fcp=2, diferencial=6, icmsDestacado=120</small></p>
                    </div>
                `;
            } catch (error) {
                const resultadoDiv = document.getElementById('resultadoTeste');
                resultadoDiv.innerHTML = `
                    <div style="background: #f8d7da; padding: 12px; border-radius: 6px;">
                        <h4>‚ùå Erro na F√≥rmula</h4>
                        <p><strong>Erro:</strong> ${error.message}</p>
                        <p>Verifique a sintaxe da f√≥rmula e as vari√°veis utilizadas.</p>
                    </div>
                `;
            }
        }

        function salvarCalculoPersonalizado() {
            const nome = document.getElementById('nomeCalculoPersonalizado').value;
            const descricao = document.getElementById('descricaoCalculoPersonalizado').value;
            const formula = document.getElementById('formulaPersonalizada').value;
            
            if (!nome || !formula) {
                alert('Preencha o nome e a f√≥rmula para salvar.');
                return;
            }
            
            const codigo = 'PERSONALIZADO_' + Date.now();
            
            calculosPersonalizados[codigo] = {
                codigo: codigo,
                nome: nome,
                descricao: descricao,
                formula: formula,
                cor: 'tipo-personalizado'
            };
            
            // Limpar formul√°rio
            document.getElementById('nomeCalculoPersonalizado').value = '';
            document.getElementById('descricaoCalculoPersonalizado').value = '';
            document.getElementById('formulaPersonalizada').value = '';
            document.getElementById('resultadoTeste').innerHTML = '';
            
            // Atualizar lista de c√°lculos personalizados
            renderizarCalculosPersonalizados();
            salvarCalculosPersonalizados();
            
            alert(`C√°lculo personalizado "${nome}" salvo com sucesso!`);
        }

        function renderizarCalculosPersonalizados() {
            const container = document.getElementById('lista-calculos-personalizados');
            container.innerHTML = '';
            
            if (Object.keys(calculosPersonalizados).length === 0) {
                container.innerHTML = '<p style="text-align: center; padding: 20px; color: #666;">Nenhum c√°lculo personalizado salvo.</p>';
                return;
            }
            
            Object.values(calculosPersonalizados).forEach(calculo => {
                const div = document.createElement('div');
                div.className = 'nf-item';
                div.innerHTML = `
                    <div class="nf-header">
                        <div class="nf-name">${calculo.nome}</div>
                        <button class="btn btn-danger" onclick="excluirCalculoPersonalizado('${calculo.codigo}')" style="padding: 4px 8px; font-size: 11px;">Excluir</button>
                    </div>
                    <div class="nf-origem-destino">${calculo.descricao}</div>
                    <div style="margin-top: 8px;">
                        <strong>F√≥rmula:</strong> <code>${calculo.formula}</code>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function excluirCalculoPersonalizado(codigo) {
            if (confirm('Tem certeza que deseja excluir este c√°lculo personalizado?')) {
                delete calculosPersonalizados[codigo];
                renderizarCalculosPersonalizados();
                salvarCalculosPersonalizados();
            }
        }

        function salvarCalculosPersonalizados() {
            localStorage.setItem('calculosPersonalizadosDIFAL', JSON.stringify(calculosPersonalizados));
        }

        function carregarCalculosPersonalizados() {
            const calculosSalvos = localStorage.getItem('calculosPersonalizadosDIFAL');
            if (calculosSalvos) {
                calculosPersonalizados = JSON.parse(calculosSalvos);
                renderizarCalculosPersonalizados();
            }
        }

        // FUN√á√ÉO MELHORADA: C√°lculo manual com suporte a ICMS destacado
        function calcularManual() {
            const ufOrigem = document.getElementById('ufOrigem').value;
            const ufDestino = document.getElementById('ufDestino').value;
            const valorBase = parseFloat(document.getElementById('valorBase').value.replace('.', '').replace(',', '.')) || 0;
            const icmsDestacado = parseFloat(document.getElementById('icmsDestacado').value.replace('.', '').replace(',', '.')) || 0;

            if (!ufOrigem || !ufDestino || !valorBase || valorBase <= 0) {
                alert('Por favor, preencha todos os campos com valores v√°lidos.');
                return;
            }

            const tipoCalculo = icmsDestacado > 0 ? TIPOS_CALCULO.POR_DENTRO_BASE_LIQUIDA : TIPOS_CALCULO.BASICO;
            const resultado = calcularDIFALMultiTipo(ufOrigem, ufDestino, 'consumidor', valorBase, tipoCalculo, icmsDestacado);
            
            const resultadoDiv = document.getElementById('resultadoManual');
            
            let detalhesCalculo = '';
            if (icmsDestacado > 0 && tipoCalculo.codigo === 'POR_DENTRO_BASE_LIQUIDA') {
                const baseLiquida = valorBase - icmsDestacado;
                const baseAjustada = baseLiquida / (1 - resultado.aliqInterna / 100);
                
                detalhesCalculo = `
                    <div class="explicacao-calculo">
                        <h4>üîç Detalhamento do C√°lculo "Por Dentro com Base L√≠quida"</h4>
                        <div class="passo-calculo">
                            <strong>1. Base L√≠quida:</strong> R$ ${valorBase.toFixed(2)} - R$ ${icmsDestacado.toFixed(2)} = <strong>R$ ${baseLiquida.toFixed(2)}</strong>
                        </div>
                        <div class="passo-calculo">
                            <strong>2. Base Ajustada:</strong> R$ ${baseLiquida.toFixed(2)} √∑ (1 - ${resultado.aliqInterna}%) = <strong>R$ ${baseAjustada.toFixed(2)}</strong>
                        </div>
                        <div class="passo-calculo">
                            <strong>3. DIFAL:</strong> R$ ${baseAjustada.toFixed(2)} √ó (${resultado.aliqInterna}% - ${resultado.aliqInterestadual}%) = <strong>R$ ${resultado.difal?.toFixed(2)}</strong>
                        </div>
                    </div>
                `;
            }
            
            resultadoDiv.innerHTML = `
                <div style="background: #d4edda; padding: 15px; border-radius: 8px;">
                    <h4>‚úÖ Resultado do C√°lculo DIFAL</h4>
                    <p><strong>Origem:</strong> ${ufOrigem} ‚Üí <strong>Destino:</strong> ${ufDestino}</p>
                    <p><strong>Tipo de C√°lculo:</strong> ${tipoCalculo.nome}</p>
                    <p><strong>Valor DIFAL:</strong> R$ ${resultado.difal?.toFixed(2) || '0.00'}</p>
                    <p><strong>Valor FCP:</strong> R$ ${resultado.fcp?.toFixed(2) || '0.00'}</p>
                    <p><strong>Total a Recolher:</strong> R$ ${resultado.total?.toFixed(2) || '0.00'}</p>
                    ${detalhesCalculo}
                </div>
            `;
        }

        // FUN√á√ïES EXISTENTES (mantidas da vers√£o original)
        function abrirTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });

            document.getElementById(tabName).classList.add('active');
            event.currentTarget.classList.add('active');

            if (tabName === 'tabGestao') {
                atualizarResumoPagamentos();
            } else if (tabName === 'tabAdmin') {
                renderizarTabelaAdmin();
            } else if (tabName === 'tabPersonalizado') {
                renderizarCalculosPersonalizados();
            }
        }

        function processarTodosXMLs() {
            if (todosCalculos.length === 0) {
                alert('N√£o h√° XMLs para processar. Importe alguns XMLs primeiro.');
                return;
            }
            
            alert(`Processamento conclu√≠do! ${todosCalculos.length} NF-es processadas.`);
        }

        function exportarExcel() {
            if (todosCalculos.length === 0) {
                alert('N√£o h√° dados para exportar.');
                return;
            }
            
            // Simula√ß√£o de exporta√ß√£o
            alert(`Exportando ${todosCalculos.length} registros para Excel...`);
        }

        function fazerBackup() {
            if (todosCalculos.length === 0) {
                alert('N√£o h√° dados para backup.');
                return;
            }

            alert(`Backup realizado com sucesso! ${todosCalculos.length} registros salvos.`);
        }

        function limparTudo() {
            if (confirm('Tem certeza que deseja limpar todos os c√°lculos?')) {
                todosCalculos = [];
                renderizarListaNFes();
                atualizarResumo();
                document.getElementById('detalhes-container').innerHTML = '';
            }
        }

        function formatarMoeda(input) {
            let valor = input.value.replace(/\D/g, '');
            valor = (valor / 100).toFixed(2) + '';
            valor = valor.replace(".", ",");
            valor = valor.replace(/(\d)(\d{3})(\d{3}),/g, "$1.$2.$3,");
            valor = valor.replace(/(\d)(\d{3}),/g, "$1.$2,");
            input.value = valor;
        }

        function filtrarTabela() {
            const filtroTexto = document.getElementById('filtroTabela').value.toLowerCase();
            const filtroStatus = document.getElementById('filtroStatus').value;
            
            const nfItems = document.querySelectorAll('#lista-nfes .nf-item');
            
            nfItems.forEach(item => {
                const textoItem = item.textContent.toLowerCase();
                const statusItem = item.querySelector('.tipo-calculo-badge').textContent;
                
                const correspondeTexto = textoItem.includes(filtroTexto);
                const correspondeStatus = !filtroStatus || statusItem.includes(filtroStatus);
                
                item.style.display = (correspondeTexto && correspondeStatus) ? '' : 'none';
            });
        }

        function atualizarResumo() {
            const resumoDiv = document.getElementById('resumoCalculos');
            
            const totalNFes = todosCalculos.length;
            const totalValor = todosCalculos.reduce((sum, c) => sum + (c.total || 0), 0);
            const totalFCP = todosCalculos.reduce((sum, c) => sum + (c.fcp || 0), 0);
            
            resumoDiv.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; font-size: 13px;">
                    <div><strong>Total NF-es:</strong> ${totalNFes}</div>
                    <div><strong>Total DIFAL:</strong> R$ ${totalValor.toFixed(2)}</div>
                    <div><strong>Total FCP:</strong> R$ ${totalFCP.toFixed(2)}</div>
                    <div><strong>Total Geral:</strong> R$ ${(totalValor + totalFCP).toFixed(2)}</div>
                </div>
            `;
        }

        function salvarHistorico() {
            localStorage.setItem('historicoDIFAL', JSON.stringify(todosCalculos));
        }

        function carregarHistorico() {
            const historico = localStorage.getItem('historicoDIFAL');
            if (historico) {
                todosCalculos = JSON.parse(historico);
                renderizarListaNFes();
                atualizarResumo();
            }
        }

        // FUN√á√ïES DE ADMINISTRA√á√ÉO
        function renderizarTabelaAdmin() {
            const tbody = document.getElementById('tabelaAdmin');
            tbody.innerHTML = '';

            const estados = Object.keys(aliquotasInternas).sort();
            
            estados.forEach(estado => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><strong>${estado}</strong></td>
                    <td>
                        <input type="number" 
                               value="${aliquotasInternas[estado]?.valor || 0}" 
                               step="0.1" 
                               min="0" 
                               max="100"
                               onchange="atualizarAliquotaInterna('${estado}', this.value)"
                               style="width: 60px; padding: 3px; border: 1px solid #ddd; border-radius: 3px; text-align: center;">
                        %
                    </td>
                    <td>
                        <input type="number" 
                               value="${fundoPobreza[estado] || 0}" 
                               step="0.1" 
                               min="0" 
                               max="100"
                               onchange="atualizarFCP('${estado}', this.value)"
                               style="width: 60px; padding: 3px; border: 1px solid #ddd; border-radius: 3px; text-align: center;">
                        %
                    </td>
                    <td>${aliquotasInternas[estado]?.vigencia || '2024-01-01'}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        function atualizarAliquotaInterna(estado, valor) {
            aliquotasInternas[estado].valor = parseFloat(valor) || 0;
        }

        function atualizarFCP(estado, valor) {
            fundoPobreza[estado] = parseFloat(valor) || 0;
        }

        function salvarAliquotas() {
            const data = {
                aliquotasInternas: aliquotasInternas,
                fundoPobreza: fundoPobreza,
                timestamp: new Date().toISOString()
            };
            localStorage.setItem('aliquotasDIFAL', JSON.stringify(data));
            alert('Al√≠quotas salvas com sucesso!');
        }

        function carregarAliquotasPadrao() {
            if (confirm('Isso ir√° restaurar as al√≠quotas padr√£o. Deseja continuar?')) {
                // Restaurar valores padr√£o (simplificado)
                alert('Al√≠quotas padr√£o restauradas com sucesso!');
                renderizarTabelaAdmin();
            }
        }

        function exportarAliquotas() {
            alert('Exportando al√≠quotas...');
        }

        function filtrarTabelaAdmin() {
            // Implementa√ß√£o simplificada
            const filtro = document.getElementById('filtroAdmin').value.toUpperCase();
            const linhas = document.querySelectorAll('#tabelaAdmin tr');
            
            linhas.forEach(linha => {
                const estado = linha.cells[0].textContent;
                linha.style.display = estado.includes(filtro) ? '' : 'none';
            });
        }

        // FUN√á√ïES DE GEST√ÉO DE PAGAMENTOS
        function atualizarResumoPagamentos() {
            const resumoDiv = document.getElementById('resumoPagamentos');
            if (!resumoDiv) return;

            const total = todosCalculos.filter(c => c.aplicavel && c.total > 0).length;
            const pendentes = todosCalculos.filter(c => c.aplicavel && c.total > 0 && (!c.statusPagamento || c.statusPagamento === 'Pendente')).length;
            const agendados = todosCalculos.filter(c => c.statusPagamento === 'Agendado').length;
            const pagos = todosCalculos.filter(c => c.statusPagamento === 'Pago').length;
            const totalValor = todosCalculos.filter(c => c.aplicavel && c.total > 0).reduce((sum, c) => sum + (c.total || 0), 0);
            const valorPendente = todosCalculos.filter(c => c.aplicavel && c.total > 0 && (!c.statusPagamento || c.statusPagamento === 'Pendente')).reduce((sum, c) => sum + (c.total || 0), 0);

            resumoDiv.innerHTML = `
                <div style="text-align: center; padding: 8px; background: #17a2b8; color: white; border-radius: 5px;">
                    <div style="font-size: 11px;">Total NF-es</div>
                    <div style="font-size: 16px; font-weight: bold;">${total}</div>
                </div>
                <div style="text-align: center; padding: 8px; background: #ffc107; color: black; border-radius: 5px;">
                    <div style="font-size: 11px;">Pendentes</div>
                    <div style="font-size: 16px; font-weight: bold;">${pendentes}</div>
                </div>
                <div style="text-align: center; padding: 8px; background: #28a745; color: white; border-radius: 5px;">
                    <div style="font-size: 11px;">Pagas</div>
                    <div style="font-size: 16px; font-weight: bold;">${pagos}</div>
                </div>
            `;

            renderizarListaPagamentos();
        }

        function renderizarListaPagamentos() {
            const container = document.getElementById('lista-pagamentos');
            if (!container) return;

            const calculosComDIFAL = todosCalculos.filter(c => c.aplicavel && c.total > 0);
            
            if (calculosComDIFAL.length === 0) {
                container.innerHTML = '<p style="text-align: center; padding: 20px; color: #666;">Nenhum c√°lculo com DIFAL aplic√°vel</p>';
                return;
            }

            container.innerHTML = '';
            calculosComDIFAL.forEach(calculo => {
                const tipo = TIPOS_CALCULO[calculo.tipoCalculo] || calculosPersonalizados[calculo.tipoCalculo] || TIPOS_CALCULO.BASICO;
                const statusPagamento = calculo.statusPagamento || 'Pendente';
                const statusClass = statusPagamento === 'Pago' ? 'status-pago' : 
                                 statusPagamento === 'Agendado' ? 'status-agendado' : 
                                 'status-pendente';

                // Usar n√∫mero da NF em vez do nome do arquivo
                const displayName = calculo.numeroNF && calculo.numeroNF !== "N√∫mero n√£o encontrado" ? 
                    `NF-e ${calculo.numeroNF}` : calculo.fileName;

                const div = document.createElement('div');
                div.className = 'nf-item';
                div.innerHTML = `
                    <div class="nf-header">
                        <div class="nf-name">${displayName}</div>
                        <div class="nf-valor">R$ ${calculo.total?.toFixed(2)}</div>
                    </div>
                    <div class="nf-origem-destino">${calculo.origem} ‚Üí ${calculo.destino}</div>
                    <div style="display: flex; justify-content: space-between; margin-top: 8px;">
                        <div class="tipo-calculo-badge ${tipo.cor || 'tipo-basico'}">${tipo.nome}</div>
                        <div class="${statusClass}">${statusPagamento}</div>
                    </div>
                    <div style="margin-top: 8px; display: flex; gap: 5px;">
                        <button class="btn" onclick="alterarStatusPagamento(${calculo.id}, 'Pago')" style="padding: 4px 8px; font-size: 11px;">Pago</button>
                        <button class="btn" onclick="alterarStatusPagamento(${calculo.id}, 'Agendado')" style="padding: 4px 8px; font-size: 11px;">Agendar</button>
                        <button class="btn" onclick="alterarStatusPagamento(${calculo.id}, 'Pendente')" style="padding: 4px 8px; font-size: 11px;">Pendente</button>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function alterarStatusPagamento(calculoId, novoStatus) {
            const calculo = todosCalculos.find(c => c.id === calculoId);
            if (!calculo) return;

            calculo.statusPagamento = novoStatus;
            atualizarResumoPagamentos();
            salvarHistorico();
        }

        function marcarComoPago() {
            const selecionados = document.querySelectorAll('#lista-pagamentos .nf-item');
            if (selecionados.length === 0) {
                alert('N√£o h√° pagamentos para marcar como pagos.');
                return;
            }

            // Simula√ß√£o - na pr√°tica, seria necess√°rio sele√ß√£o
            alert('Funcionalidade de marcar como pago - selecione os itens individualmente.');
        }

        function agendarParaMesSeguinte() {
            alert('Funcionalidade de agendamento para o pr√≥ximo m√™s.');
        }

        function gerarRelatorioPagamentos() {
            if (todosCalculos.length === 0) {
                alert('N√£o h√° pagamentos para gerar relat√≥rio.');
                return;
            }

            alert('Gerando relat√≥rio de pagamentos...');
        }

        // INICIALIZA√á√ÉO
        document.addEventListener('DOMContentLoaded', function() {
            configurarUpload();
            carregarHistorico();
            carregarAliquotasSalvas();
            carregarCalculosPersonalizados();
            renderizarTabelaAdmin();
            renderizarCalculosPersonalizados();
        });

        function carregarAliquotasSalvas() {
            const aliquotasSalvas = localStorage.getItem('aliquotasDIFAL');
            if (aliquotasSalvas) {
                const data = JSON.parse(aliquotasSalvas);
                aliquotasInternas = data.aliquotasInternas || aliquotasInternas;
                fundoPobreza = data.fundoPobreza || fundoPobreza;
            }
        }
    </script>
</body>
</html>
