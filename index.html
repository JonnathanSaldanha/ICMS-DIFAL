<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora DIFAL - Al√≠quotas Atualizadas 2024</title>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        header {
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }

        .tab {
            padding: 15px 30px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 16px;
            font-weight: 600;
            color: #6c757d;
            transition: all 0.3s;
        }

        .tab.active {
            color: #3498db;
            border-bottom: 3px solid #3498db;
            background: white;
        }

        .tab:hover {
            background: #e9ecef;
        }

        .tab-content {
            display: none;
            padding: 20px;
        }

        .tab-content.active {
            display: block;
        }

        .controls {
            display: flex;
            gap: 15px;
            padding: 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #3498db;
            color: white;
        }

        .btn-success {
            background: #27ae60;
            color: white;
        }

        .btn-warning {
            background: #f39c12;
            color: white;
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn-info {
            background: #17a2b8;
            color: white;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            padding: 20px;
        }

        .section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #dee2e6;
            max-height: 80vh;
            overflow-y: auto;
        }

        h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.5em;
        }

        .upload-area {
            border: 3px dashed #3498db;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            transition: all 0.3s;
            cursor: pointer;
            margin-bottom: 20px;
        }

        .upload-area:hover {
            background: #e3f2fd;
            border-color: #2980b9;
        }

        .upload-area input {
            display: none;
        }

        .resumo {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .tabela-resultados {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 12px;
        }

        .tabela-resultados th,
        .tabela-resultados td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }

        .tabela-resultados th {
            background: #34495e;
            color: white;
            font-weight: 600;
            position: sticky;
            top: 0;
        }

        .tabela-resultados tr:hover {
            background: #e9ecef;
        }

        .status-applicable {
            color: #27ae60;
            font-weight: bold;
        }

        .status-not-applicable {
            color: #e74c3c;
            font-weight: bold;
        }

        .status-exempt {
            color: #f39c12;
            font-weight: bold;
        }

        .detalhes-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            padding: 8px 0;
            border-bottom: 1px solid rgba(0,0,0,0.1);
        }

        .detalhes-total {
            font-weight: bold;
            font-size: 1.2em;
            color: #155724;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 2px solid #28a745;
        }

        .xml-info {
            background: #fff3cd;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid #ffc107;
        }

        .calculadora-section {
            background: white;
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #3498db;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #2c3e50;
        }

        .form-group select, 
        .form-group input {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        .form-group select:focus, 
        .form-group input:focus {
            outline: none;
            border-color: #3498db;
        }

        .filtros {
            margin-bottom: 15px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .filtros input, .filtros select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            flex: 1;
            min-width: 200px;
        }

        .progresso-container {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
            display: none;
        }

        .progresso-bar {
            width: 200px;
            height: 10px;
            background: #f0f0f0;
            border-radius: 5px;
            margin-top: 5px;
            overflow: hidden;
        }

        .progresso-fill {
            height: 100%;
            background: #3498db;
            border-radius: 5px;
            transition: width 0.3s ease;
        }

        .config-section {
            background: #fff3cd;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            border-left: 4px solid #ffc107;
        }

        .admin-section {
            background: white;
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #e74c3c;
            margin-top: 20px;
        }

        .tabela-admin {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 12px;
        }

        .tabela-admin th,
        .tabela-admin td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }

        .tabela-admin th {
            background: #34495e;
            color: white;
            font-weight: 600;
        }

        .tabela-admin input {
            width: 80px;
            padding: 4px;
            border: 1px solid #ddd;
            border-radius: 3px;
            text-align: center;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .controls {
                flex-direction: column;
            }
            
            .tabela-resultados {
                font-size: 10px;
            }
            
            .tabs {
                flex-wrap: wrap;
            }
            
            .tab {
                padding: 10px 15px;
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üßÆ Calculadora DIFAL - Al√≠quotas Atualizadas 2024</h1>
            <p>Processamento preciso de XMLs com c√°lculos corretos de DIFAL - Base de dados atualizada</p>
        </header>

        <div class="tabs">
            <button class="tab active" onclick="abrirTab('tabCalculadora')">Calculadora</button>
            <button class="tab" onclick="abrirTab('tabAdmin')">Administrar Al√≠quotas</button>
        </div>

        <div id="tabCalculadora" class="tab-content active">
            <div class="controls">
                <button class="btn btn-primary" onclick="processarTodosXMLs()">Processar Todos XMLs</button>
                <button class="btn btn-success" onclick="exportarExcel()">Exportar para Excel</button>
                <button class="btn btn-info" onclick="fazerBackup()">Fazer Backup</button>
                <button class="btn btn-warning" onclick="limparTudo()">Limpar Tudo</button>
            </div>

            <div class="progresso-container" id="progressoContainer">
                <div id="progressoTexto">Processando...</div>
                <div class="progresso-bar">
                    <div class="progresso-fill" id="progressoFill"></div>
                </div>
            </div>

            <div class="main-content">
                <div class="section">
                    <h2>Importar NFes (XML)</h2>
                    <div class="upload-area" id="uploadArea">
                        <input type="file" id="xmlUpload" accept=".xml" multiple>
                        <div class="upload-placeholder">
                            <span>üìÅ Arraste XMLs aqui ou clique para selecionar</span>
                            <br>
                            <small>Suporte para m√∫ltiplos arquivos - Processamento real de XML</small>
                        </div>
                    </div>

                    <div class="resumo">
                        <h4>Resumo dos C√°lculos</h4>
                        <div id="resumoCalculos">Nenhum XML processado</div>
                    </div>

                    <div class="config-section">
                        <h4>‚öôÔ∏è Configura√ß√µes</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;">
                            <label>
                                <input type="checkbox" id="autoProcessar" checked> Auto-processar
                            </label>
                            <label>
                                <input type="checkbox" id="manterHistorico" checked> Manter hist√≥rico
                            </label>
                        </div>
                    </div>

                    <div class="calculadora-section">
                        <h3>Calculadora Manual</h3>
                        <div class="form-group">
                            <label for="ufOrigem">UF de Origem:</label>
                            <select id="ufOrigem">
                                <option value="">Selecione...</option>
                                <option value="AC">AC</option>
                                <option value="AL">AL</option>
                                <option value="AP">AP</option>
                                <option value="AM">AM</option>
                                <option value="BA">BA</option>
                                <option value="CE">CE</option>
                                <option value="DF">DF</option>
                                <option value="ES">ES</option>
                                <option value="GO">GO</option>
                                <option value="MA">MA</option>
                                <option value="MT">MT</option>
                                <option value="MS">MS</option>
                                <option value="MG">MG</option>
                                <option value="PA">PA</option>
                                <option value="PB">PB</option>
                                <option value="PR">PR</option>
                                <option value="PE">PE</option>
                                <option value="PI">PI</option>
                                <option value="RJ">RJ</option>
                                <option value="RN">RN</option>
                                <option value="RS">RS</option>
                                <option value="RO">RO</option>
                                <option value="RR">RR</option>
                                <option value="SC">SC</option>
                                <option value="SP">SP</option>
                                <option value="SE">SE</option>
                                <option value="TO">TO</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="ufDestino">UF de Destino:</label>
                            <select id="ufDestino">
                                <option value="">Selecione...</option>
                                <option value="AC">AC</option>
                                <option value="AL">AL</option>
                                <option value="AP">AP</option>
                                <option value="AM">AM</option>
                                <option value="BA">BA</option>
                                <option value="CE">CE</option>
                                <option value="DF">DF</option>
                                <option value="ES">ES</option>
                                <option value="GO">GO</option>
                                <option value="MA">MA</option>
                                <option value="MT">MT</option>
                                <option value="MS">MS</option>
                                <option value="MG">MG</option>
                                <option value="PA">PA</option>
                                <option value="PB">PB</option>
                                <option value="PR">PR</option>
                                <option value="PE">PE</option>
                                <option value="PI">PI</option>
                                <option value="RJ">RJ</option>
                                <option value="RN">RN</option>
                                <option value="RS">RS</option>
                                <option value="RO">RO</option>
                                <option value="RR">RR</option>
                                <option value="SC">SC</option>
                                <option value="SP">SP</option>
                                <option value="SE">SE</option>
                                <option value="TO">TO</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="valorBase">Valor Base (R$):</label>
                            <input type="text" id="valorBase" placeholder="0,00" oninput="formatarMoeda(this)">
                        </div>

                        <button class="btn btn-primary" onclick="calcularManual()" style="width: 100%;">Calcular DIFAL Manual</button>

                        <div id="resultadoManual" style="margin-top: 15px;"></div>
                    </div>
                </div>

                <div class="section">
                    <h2>Resultados dos C√°lculos</h2>
                    
                    <div class="filtros">
                        <input type="text" id="filtroTabela" placeholder="Filtrar por NF-e, UF, status..." oninput="filtrarTabela()">
                        <select id="filtroStatus" onchange="filtrarTabela()">
                            <option value="">Todos os status</option>
                            <option value="Aplic√°vel">Aplic√°vel</option>
                            <option value="Isento">Isento</option>
                            <option value="N√£o Aplic√°vel">N√£o Aplic√°vel</option>
                            <option value="Erro">Erro</option>
                        </select>
                    </div>

                    <div class="tabela-container">
                        <table class="tabela-resultados">
                            <thead>
                                <tr>
                                    <th>NF-e</th>
                                    <th>Origem</th>
                                    <th>Destino</th>
                                    <th>Valor Total</th>
                                    <th>Aliq. Inter</th>
                                    <th>Aliq. Interna</th>
                                    <th>DIFAL</th>
                                    <th>FCP</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="tabelaResultados">
                                <tr>
                                    <td colspan="9" style="text-align: center; padding: 20px;">
                                        Nenhum resultado dispon√≠vel
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div id="detalhesContainer"></div>
                </div>
            </div>
        </div>

        <div id="tabAdmin" class="tab-content">
            <div class="admin-section">
                <h2>üìä Administra√ß√£o de Al√≠quotas</h2>
                <p>Edite as al√≠quotas internas e FCP conforme necess√°rio. As altera√ß√µes s√£o salvas automaticamente.</p>
                
                <div class="controls">
                    <button class="btn btn-success" onclick="salvarAliquotas()">Salvar Al√≠quotas</button>
                    <button class="btn btn-primary" onclick="carregarAliquotasPadrao()">Restaurar Padr√£o</button>
                    <button class="btn btn-info" onclick="exportarAliquotas()">Exportar Al√≠quotas</button>
                    <button class="btn btn-warning" onclick="importarAliquotas()">Importar Al√≠quotas</button>
                </div>

                <div class="filtros">
                    <input type="text" id="filtroAdmin" placeholder="Filtrar por estado..." oninput="filtrarTabelaAdmin()">
                </div>

                <table class="tabela-admin">
                    <thead>
                        <tr>
                            <th>Estado</th>
                            <th>Al√≠quota Interna (%)</th>
                            <th>FCP (%)</th>
                            <th>√öltima Atualiza√ß√£o</th>
                        </tr>
                    </thead>
                    <tbody id="tabelaAdmin">
                        <!-- Preenchido via JavaScript -->
                    </tbody>
                </table>

                <div style="margin-top: 20px; padding: 15px; background: #e3f2fd; border-radius: 8px;">
                    <h4>‚ÑπÔ∏è Regras Interestaduais Atuais</h4>
                    <ul style="margin-top: 10px;">
                        <li><strong>Produtos importados:</strong> 4%</li>
                        <li><strong>Sul/Sudeste (exceto ES) ‚Üí Norte/Nordeste/Centro-Oeste/ES:</strong> 7%</li>
                        <li><strong>Demais opera√ß√µes interestaduais:</strong> 12%</li>
                    </ul>
                    <p style="margin-top: 10px; font-size: 12px; color: #666;">
                        * As regras interestaduais s√£o calculadas automaticamente com base nas UFs de origem e destino.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // BANCO DE DADOS ATUALIZADO CONFORME PLANILHA
        let aliquotasInternas = {
            'AC': 19, 'AL': 20, 'AP': 18, 'AM': 20, 'BA': 20.5, 'CE': 20, 'DF': 20, 'ES': 17, 
            'GO': 19, 'MA': 23, 'MT': 17, 'MS': 17, 'MG': 18, 'PA': 19, 'PB': 20, 'PR': 19.5, 
            'PE': 20.5, 'PI': 22.5, 'RJ': 22, 'RN': 20, 'RS': 17, 'RO': 19.5, 'RR': 20, 'SC': 17, 
            'SP': 18, 'SE': 20, 'TO': 20
        };

        let fundoPobreza = {
            'AC': 0, 'AL': 0, 'AP': 0, 'AM': 0, 'BA': 0, 'CE': 0, 'DF': 0, 'ES': 0, 
            'GO': 0, 'MA': 0, 'MT': 0, 'MS': 0, 'MG': 0, 'PA': 0, 'PB': 0, 'PR': 0, 
            'PE': 0, 'PI': 0, 'RJ': 0, 'RN': 0, 'RS': 0, 'RO': 0, 'RR': 0, 'SC': 0, 
            'SP': 0, 'SE': 0, 'TO': 0
        };

        // Array para armazenar todos os c√°lculos
        let todosCalculos = [];
        let cacheCalculos = new Map();
        let configUsuario = {
            autoProcessar: true,
            manterHistorico: true,
            formatoMoeda: 'BRL',
            casasDecimais: 2
        };

        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', function() {
            configurarUpload();
            carregarConfiguracoes();
            carregarHistorico();
            carregarAliquotasSalvas();
            renderizarTabelaAdmin();
        });

        function abrirTab(tabName) {
            // Esconder todas as tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Mostrar tab selecionada
            document.getElementById(tabName).classList.add('active');
            event.currentTarget.classList.add('active');
        }

        function configurarUpload() {
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('xmlUpload');
            
            uploadArea.addEventListener('click', () => fileInput.click());
            
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.style.background = '#e3f2fd';
                uploadArea.style.borderColor = '#2196f3';
            });
            
            uploadArea.addEventListener('dragleave', () => {
                uploadArea.style.background = '';
                uploadArea.style.borderColor = '#3498db';
            });
            
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.style.background = '';
                uploadArea.style.borderColor = '#3498db';
                
                const files = e.dataTransfer.files;
                processarArquivos(files);
            });
            
            fileInput.addEventListener('change', (e) => {
                processarArquivos(e.target.files);
            });

            // Configurar eventos de configura√ß√£o
            document.getElementById('autoProcessar').addEventListener('change', salvarConfiguracoes);
            document.getElementById('manterHistorico').addEventListener('change', salvarConfiguracoes);
        }

        function carregarConfiguracoes() {
            const configSalva = localStorage.getItem('configDIFAL');
            if (configSalva) {
                configUsuario = { ...configUsuario, ...JSON.parse(configSalva) };
                document.getElementById('autoProcessar').checked = configUsuario.autoProcessar;
                document.getElementById('manterHistorico').checked = configUsuario.manterHistorico;
            }
        }

        function salvarConfiguracoes() {
            configUsuario.autoProcessar = document.getElementById('autoProcessar').checked;
            configUsuario.manterHistorico = document.getElementById('manterHistorico').checked;
            localStorage.setItem('configDIFAL', JSON.stringify(configUsuario));
        }

        function carregarAliquotasSalvas() {
            const aliquotasSalvas = localStorage.getItem('aliquotasDIFAL');
            if (aliquotasSalvas) {
                const data = JSON.parse(aliquotasSalvas);
                aliquotasInternas = data.aliquotasInternas || aliquotasInternas;
                fundoPobreza = data.fundoPobreza || fundoPobreza;
            }
        }

        function salvarAliquotas() {
            const data = {
                aliquotasInternas: aliquotasInternas,
                fundoPobreza: fundoPobreza,
                timestamp: new Date().toISOString()
            };
            localStorage.setItem('aliquotasDIFAL', JSON.stringify(data));
            alert('Al√≠quotas salvas com sucesso!');
        }

        function carregarHistorico() {
            if (configUsuario.manterHistorico) {
                const historico = localStorage.getItem('historicoDIFAL');
                if (historico) {
                    todosCalculos = JSON.parse(historico);
                    atualizarTabela();
                    atualizarResumo();
                }
            }
        }

        function salvarHistorico() {
            if (configUsuario.manterHistorico) {
                localStorage.setItem('historicoDIFAL', JSON.stringify(todosCalculos));
            }
        }

        async function processarArquivos(files) {
            const xmlFiles = Array.from(files).filter(file => file.name.endsWith('.xml'));
            
            if (xmlFiles.length === 0) {
                alert('Nenhum arquivo XML encontrado.');
                return;
            }

            mostrarProgresso(0, xmlFiles.length);

            for (let i = 0; i < xmlFiles.length; i++) {
                const file = xmlFiles[i];
                await processarArquivoComRetry(file);
                mostrarProgresso(i + 1, xmlFiles.length);
            }

            ocultarProgresso();
            atualizarResumo();
            salvarHistorico();
            
            if (configUsuario.autoProcessar) {
                processarTodosXMLs();
            }
        }

        function processarArquivoComRetry(file, tentativa = 0) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        processarXMLReal(e.target.result, file.name);
                        resolve();
                    } catch (error) {
                        if (tentativa < 2) {
                            setTimeout(() => {
                                processarArquivoComRetry(file, tentativa + 1).then(resolve);
                            }, 1000);
                        } else {
                            console.error('Erro ao processar arquivo ap√≥s 3 tentativas:', file.name, error);
                            resolve();
                        }
                    }
                };
                reader.onerror = () => resolve();
                reader.readAsText(file);
            });
        }

        function mostrarProgresso(atual, total) {
            const container = document.getElementById('progressoContainer');
            const texto = document.getElementById('progressoTexto');
            const fill = document.getElementById('progressoFill');
            
            const percentual = (atual / total) * 100;
            texto.textContent = `Processando: ${atual}/${total} (${percentual.toFixed(1)}%)`;
            fill.style.width = `${percentual}%`;
            container.style.display = 'block';
        }

        function ocultarProgresso() {
            document.getElementById('progressoContainer').style.display = 'none';
        }

        function calcularAliquotaInterestadual(origem, destino) {
            // Regras conforme planilha
            const estadosSulSudesteExcetoES = ['PR', 'RS', 'SC', 'SP', 'MG', 'RJ'];
            const estadosDestino7 = ['AC', 'AL', 'AP', 'AM', 'BA', 'CE', 'DF', 'ES', 'GO', 'MA', 'MT', 'MS', 'PA', 'PB', 'PE', 'PI', 'RN', 'RO', 'RR', 'SE', 'TO'];
            
            if (estadosSulSudesteExcetoES.includes(origem) && estadosDestino7.includes(destino)) {
                return 7; // Sul/Sudeste (exceto ES) ‚Üí Norte/Nordeste/Centro-Oeste/ES
            }
            
            return 12; // Demais opera√ß√µes interestaduais
        }

        function processarXMLReal(xmlContent, fileName) {
            try {
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(xmlContent, "text/xml");
                
                if (xmlDoc.getElementsByTagName("parsererror").length > 0) {
                    throw new Error("XML inv√°lido ou mal formado");
                }

                // Extrair dados principais da NFe
                const infNFe = xmlDoc.getElementsByTagName("infNFe")[0];

                // Extrair UF de origem e destino
                const emit = xmlDoc.getElementsByTagName("emit")[0];
                const dest = xmlDoc.getElementsByTagName("dest")[0];
                
                const emitEnder = emit.getElementsByTagName("enderEmit")[0] || emit;
                const destEnder = dest.getElementsByTagName("enderDest")[0] || dest;
                
                const emitUF = emitEnder.getElementsByTagName("UF")[0]?.textContent;
                const destUF = destEnder.getElementsByTagName("UF")[0]?.textContent;

                if (!emitUF || !destUF) {
                    throw new Error("UF do emitente ou destinat√°rio n√£o encontrado");
                }

                // Extrair valores
                const total = xmlDoc.getElementsByTagName("total")[0];
                const ICMSTot = total ? total.getElementsByTagName("ICMSTot")[0] : null;
                
                const vNF = ICMSTot ? ICMSTot.getElementsByTagName("vNF")[0]?.textContent : "0";
                const vProd = ICMSTot ? ICMSTot.getElementsByTagName("vProd")[0]?.textContent : "0";
                const vFrete = ICMSTot ? ICMSTot.getElementsByTagName("vFrete")[0]?.textContent || "0" : "0";
                const vSeg = ICMSTot ? ICMSTot.getElementsByTagName("vSeg")[0]?.textContent || "0" : "0";
                const vDesc = ICMSTot ? ICMSTot.getElementsByTagName("vDesc")[0]?.textContent || "0" : "0";
                const vOutro = ICMSTot ? ICMSTot.getElementsByTagName("vOutro")[0]?.textContent || "0" : "0";

                // Determinar tipo de destinat√°rio
                const indIEDest = dest.getElementsByTagName("indIEDest")[0]?.textContent;
                let tipoDestinatario = 'consumidor';
                
                if (indIEDest === '1') {
                    tipoDestinatario = 'contribuinte';
                } else if (indIEDest === '2' || indIEDest === '9') {
                    tipoDestinatario = 'isento';
                }

                // Calcular base de c√°lculo corretamente
                const baseCalculo = sanitizarValor(vProd) + sanitizarValor(vFrete) + sanitizarValor(vSeg) - sanitizarValor(vDesc) + sanitizarValor(vOutro);
                const valorTotal = sanitizarValor(vNF) || baseCalculo;

                const calculo = {
                    id: Date.now() + Math.random(),
                    fileName: fileName,
                    origem: emitUF,
                    destino: destUF,
                    tipoDestinatario: tipoDestinatario,
                    valorOperacao: sanitizarValor(vProd),
                    valorFrete: sanitizarValor(vFrete),
                    valorSeguro: sanitizarValor(vSeg),
                    valorDesconto: sanitizarValor(vDesc),
                    valorOutros: sanitizarValor(vOutro),
                    baseCalculo: baseCalculo,
                    valorTotal: valorTotal,
                    status: 'Processado',
                    timestamp: new Date().toLocaleString(),
                    detalhes: []
                };

                // Calcular DIFAL usando cache
                const resultado = calcularDIFALComCache(
                    calculo.origem,
                    calculo.destino,
                    calculo.tipoDestinatario,
                    calculo.baseCalculo
                );

                Object.assign(calculo, resultado);
                todosCalculos.push(calculo);
                
                atualizarTabela();
                
            } catch (error) {
                console.error('Erro ao processar XML:', error);
                
                // Adicionar c√°lculo com erro para visualiza√ß√£o
                const calculoErro = {
                    id: Date.now() + Math.random(),
                    fileName: fileName,
                    origem: 'ERRO',
                    destino: 'ERRO',
                    tipoDestinatario: 'erro',
                    baseCalculo: 0,
                    valorTotal: 0,
                    status: 'Erro',
                    timestamp: new Date().toLocaleString(),
                    aplicavel: false,
                    motivo: error.message,
                    difal: 0,
                    fcp: 0,
                    total: 0
                };
                
                todosCalculos.push(calculoErro);
                atualizarTabela();
            }
        }

        function calcularDIFALComCache(origem, destino, tipoDestinatario, baseCalculo) {
            const chave = `${origem}-${destino}-${tipoDestinatario}-${baseCalculo}`;
            
            if (cacheCalculos.has(chave)) {
                return cacheCalculos.get(chave);
            }
            
            const resultado = calcularDIFALDetalhado(origem, destino, tipoDestinatario, baseCalculo);
            cacheCalculos.set(chave, resultado);
            
            return resultado;
        }

        function calcularDIFALDetalhado(origem, destino, tipoDestinatario, baseCalculo) {
            // Verificar aplicabilidade primeiro
            const aplicavel = verificarAplicabilidade(origem, destino, tipoDestinatario);
            
            if (!aplicavel.aplicavel) {
                return {
                    aplicavel: false,
                    motivo: aplicavel.motivo,
                    difal: 0,
                    fcp: 0,
                    total: 0,
                    aliqInterestadual: 0,
                    aliqInterna: 0,
                    percFCP: 0,
                    detalhes: []
                };
            }
            
            // Obter al√≠quotas atualizadas
            const aliqInterestadual = calcularAliquotaInterestadual(origem, destino);
            const aliqInterna = aliquotasInternas[destino] || 18;
            const percFCP = fundoPobreza[destino] || 0;
            
            // C√°lculo correto do DIFAL conforme legisla√ß√£o
            const difal = baseCalculo * (aliqInterna - aliqInterestadual) / 100;
            const fcp = baseCalculo * percFCP / 100;
            const total = difal + fcp;
            
            const detalhes = [
                { descricao: 'Base de C√°lculo', valor: baseCalculo, formula: 'Valor Produtos + Frete + Seguro - Desconto + Outros' },
                { descricao: 'Al√≠quota Interestadual', valor: aliqInterestadual, formula: `${origem} ‚Üí ${destino}` },
                { descricao: 'Al√≠quota Interna Destino', valor: aliqInterna, formula: `UF ${destino}` },
                { descricao: 'Diferencial de Al√≠quota', valor: (aliqInterna - aliqInterestadual).toFixed(2), formula: `${aliqInterna}% - ${aliqInterestadual}%` },
                { descricao: 'C√°lculo DIFAL', valor: difal, formula: `R$ ${baseCalculo.toFixed(2)} √ó ${(aliqInterna - aliqInterestadual).toFixed(2)}%` },
                { descricao: 'Fundo Combate √† Pobreza', valor: percFCP, formula: `${percFCP}%` },
                { descricao: 'Valor FCP', valor: fcp, formula: `R$ ${baseCalculo.toFixed(2)} √ó ${percFCP}%` }
            ];
            
            return {
                aplicavel: true,
                origem,
                destino,
                baseCalculo,
                aliqInterestadual,
                aliqInterna,
                percFCP,
                difal,
                fcp,
                total,
                detalhes,
                motivo: ''
            };
        }

        function verificarAplicabilidade(origem, destino, tipoDestinatario) {
            if (origem === destino) {
                return { aplicavel: false, motivo: 'Opera√ß√£o interna (mesmo estado)' };
            }
            
            if (tipoDestinatario === 'isento') {
                return { aplicavel: false, motivo: 'Opera√ß√£o imune ou isenta' };
            }
            
            // Verificar se as al√≠quotas s√£o iguais (n√£o h√° diferencial)
            const aliqInterestadual = calcularAliquotaInterestadual(origem, destino);
            const aliqInterna = aliquotasInternas[destino];
            
            if (aliqInterestadual === aliqInterna) {
                return { aplicavel: false, motivo: 'Al√≠quotas iguais - sem diferencial' };
            }
            
            return { aplicavel: true, motivo: '' };
        }

        function sanitizarValor(valor) {
            if (typeof valor === 'string') {
                valor = valor.replace(/[^\d,.-]/g, '');
                valor = valor.replace(',', '.');
            }
            
            const numero = parseFloat(valor);
            if (isNaN(numero) || numero < 0) {
                return 0;
            }
            
            return numero;
        }

        function formatarMoeda(input) {
            let valor = input.value.replace(/\D/g, '');
            valor = (valor / 100).toFixed(2) + '';
            valor = valor.replace(".", ",");
            valor = valor.replace(/(\d)(\d{3})(\d{3}),/g, "$1.$2.$3,");
            valor = valor.replace(/(\d)(\d{3}),/g, "$1.$2,");
            input.value = valor;
        }

        function filtrarTabela() {
            const filtroTexto = document.getElementById('filtroTabela').value.toLowerCase();
            const filtroStatus = document.getElementById('filtroStatus').value;
            
            const linhas = document.querySelectorAll('#tabelaResultados tr');
            
            linhas.forEach(linha => {
                const textoLinha = linha.textContent.toLowerCase();
                const statusLinha = linha.querySelector('.status-applicable, .status-not-applicable, .status-exempt')?.textContent || '';
                
                const correspondeTexto = textoLinha.includes(filtroTexto);
                const correspondeStatus = !filtroStatus || statusLinha.includes(filtroStatus);
                
                linha.style.display = (correspondeTexto && correspondeStatus) ? '' : 'none';
            });
        }

        function atualizarTabela() {
            const tbody = document.getElementById('tabelaResultados');
            const detalhesContainer = document.getElementById('detalhesContainer');
            
            tbody.innerHTML = '';
            detalhesContainer.innerHTML = '';
            
            if (todosCalculos.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="9" style="text-align: center; padding: 20px;">
                            Nenhum resultado dispon√≠vel
                        </td>
                    </tr>
                `;
                return;
            }
            
            todosCalculos.forEach((calculo, index) => {
                const tr = document.createElement('tr');
                
                const statusClass = calculo.status === 'Erro' ? 'status-not-applicable' : 
                    calculo.aplicavel ? 
                    (calculo.difal > 0 ? 'status-applicable' : 'status-exempt') : 
                    'status-not-applicable';
                
                const statusText = calculo.status === 'Erro' ? 'Erro' :
                    calculo.aplicavel ? 
                    (calculo.difal > 0 ? 'Aplic√°vel' : 'Isento') : 
                    'N√£o Aplic√°vel';
                
                tr.innerHTML = `
                    <td title="${calculo.fileName}">${calculo.fileName.length > 20 ? calculo.fileName.substring(0, 20) + '...' : calculo.fileName}</td>
                    <td>${calculo.origem}</td>
                    <td>${calculo.destino}</td>
                    <td>R$ ${calculo.valorTotal?.toFixed(2) || calculo.baseCalculo?.toFixed(2) || '0.00'}</td>
                    <td>${calculo.aliqInterestadual?.toFixed(2) || '0.00'}%</td>
                    <td>${calculo.aliqInterna?.toFixed(2) || '0.00'}%</td>
                    <td>R$ ${calculo.difal?.toFixed(2) || '0.00'}</td>
                    <td>R$ ${calculo.fcp?.toFixed(2) || '0.00'}</td>
                    <td><span class="${statusClass}">${statusText}</span></td>
                `;
                
                if (calculo.status !== 'Erro') {
                    tr.addEventListener('click', () => mostrarDetalhes(calculo));
                    tr.style.cursor = 'pointer';
                }
                
                tbody.appendChild(tr);
            });

            filtrarTabela();
        }

        function mostrarDetalhes(calculo) {
            const detalhesContainer = document.getElementById('detalhesContainer');
            
            let html = `
                <div class="xml-info">
                    <h3>Detalhes do C√°lculo - ${calculo.fileName}</h3>
                    <div><strong>Origem:</strong> ${calculo.origem}</div>
                    <div><strong>Destino:</strong> ${calculo.destino}</div>
                    <div><strong>Tipo Destinat√°rio:</strong> ${calculo.tipoDestinatario}</div>
                    <div><strong>Status:</strong> ${calculo.aplicavel ? (calculo.difal > 0 ? 'DIFAL Aplic√°vel' : 'Isento') : 'N√£o Aplic√°vel'}</div>
                    ${calculo.motivo ? `<div><strong>Motivo:</strong> ${calculo.motivo}</div>` : ''}
                    <div><strong>Data/Hora:</strong> ${calculo.timestamp}</div>
                </div>
            `;
            
            if (calculo.aplicavel && calculo.detalhes.length > 0) {
                html += '<div class="resultado" style="display: block; background: #d4edda; padding: 15px; border-radius: 8px; margin-top: 10px;">';
                html += '<h4>Detalhamento do C√°lculo</h4>';
                
                calculo.detalhes.forEach(detalhe => {
                    html += `
                        <div class="detalhes-item">
                            <span>${detalhe.descricao}:</span>
                            <span>
                                ${typeof detalhe.valor === 'number' ? 
                                  (detalhe.descricao.includes('Al√≠quota') || detalhe.descricao.includes('Fundo') ? 
                                   `${detalhe.valor}%` : `R$ ${detalhe.valor.toFixed(2)}`) : 
                                  detalhe.valor}
                                ${detalhe.formula ? `<br><small style="color: #666;">${detalhe.formula}</small>` : ''}
                            </span>
                        </div>
                    `;
                });
                
                html += `
                    <div class="detalhes-total">
                        <span>TOTAL A RECOLHER (DIFAL + FCP):</span>
                        <span>R$ ${calculo.total.toFixed(2)}</span>
                    </div>
                `;
                
                html += '</div>';
            }
            
            detalhesContainer.innerHTML = html;
        }

        function atualizarResumo() {
            const resumoDiv = document.getElementById('resumoCalculos');
            
            const totalNFes = todosCalculos.length;
            const totalProcessados = todosCalculos.filter(c => c.status !== 'Erro').length;
            const totalErros = todosCalculos.filter(c => c.status === 'Erro').length;
            const totalAplicavel = todosCalculos.filter(c => c.aplicavel && c.difal > 0).length;
            const totalIsento = todosCalculos.filter(c => c.aplicavel && c.difal === 0).length;
            const totalNaoAplicavel = todosCalculos.filter(c => !c.aplicavel && c.status !== 'Erro').length;
            const totalValor = todosCalculos.reduce((sum, c) => sum + (c.difal || 0), 0);
            const totalFCP = todosCalculos.reduce((sum, c) => sum + (c.fcp || 0), 0);
            const totalBaseCalculo = todosCalculos.reduce((sum, c) => sum + (c.baseCalculo || 0), 0);
            
            resumoDiv.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; font-size: 14px;">
                    <div><strong>Total NF-es:</strong> ${totalNFes}</div>
                    <div><strong>Processados:</strong> ${totalProcessados}</div>
                    <div><strong>Erros:</strong> ${totalErros}</div>
                    <div><strong>DIFAL Aplic√°vel:</strong> ${totalAplicavel}</div>
                    <div><strong>Isentos:</strong> ${totalIsento}</div>
                    <div><strong>N√£o Aplic√°vel:</strong> ${totalNaoAplicavel}</div>
                    <div><strong>Total Base C√°lculo:</strong> R$ ${totalBaseCalculo.toFixed(2)}</div>
                    <div><strong>Total DIFAL:</strong> R$ ${totalValor.toFixed(2)}</div>
                    <div><strong>Total FCP:</strong> R$ ${totalFCP.toFixed(2)}</div>
                    <div><strong>Total Geral:</strong> R$ ${(totalValor + totalFCP).toFixed(2)}</div>
                </div>
            `;
        }

        function processarTodosXMLs() {
            if (todosCalculos.length === 0) {
                alert('N√£o h√° XMLs para processar. Importe alguns XMLs primeiro.');
                return;
            }
            
            mostrarProgresso(0, todosCalculos.length);
            
            setTimeout(() => {
                let processados = 0;
                todosCalculos.forEach((calculo, index) => {
                    if (calculo.status !== 'Erro' && calculo.aplicavel) {
                        const resultado = calcularDIFALComCache(
                            calculo.origem,
                            calculo.destino,
                            calculo.tipoDestinatario,
                            calculo.baseCalculo
                        );
                        Object.assign(calculo, resultado);
                    }
                    processados++;
                    
                    if (processados % 5 === 0) {
                        mostrarProgresso(processados, todosCalculos.length);
                    }
                });
                
                ocultarProgresso();
                atualizarTabela();
                atualizarResumo();
                salvarHistorico();
                
                alert(`Processamento conclu√≠do! ${todosCalculos.length} NF-es processadas.`);
            }, 100);
        }

        function exportarExcel() {
            if (todosCalculos.length === 0) {
                alert('N√£o h√° dados para exportar.');
                return;
            }
            
            const dadosExcel = todosCalculos.map(calculo => ({
                'Arquivo': calculo.fileName,
                'Data Processamento': calculo.timestamp,
                'UF Origem': calculo.origem,
                'UF Destino': calculo.destino,
                'Tipo Destinat√°rio': calculo.tipoDestinatario,
                'Base C√°lculo (R$)': calculo.baseCalculo?.toFixed(2) || '0.00',
                'Valor Total NF (R$)': calculo.valorTotal?.toFixed(2) || '0.00',
                'Al√≠quota Interestadual (%)': calculo.aliqInterestadual?.toFixed(2) || '0.00',
                'Al√≠quota Interna (%)': calculo.aliqInterna?.toFixed(2) || '0.00',
                'Diferencial Al√≠quota (%)': calculo.aliqInterna && calculo.aliqInterestadual ? 
                    (calculo.aliqInterna - calculo.aliqInterestadual).toFixed(2) : '0.00',
                'FCP (%)': calculo.percFCP || '0.00',
                'Valor DIFAL (R$)': calculo.difal?.toFixed(2) || '0.00',
                'Valor FCP (R$)': calculo.fcp?.toFixed(2) || '0.00',
                'Total a Recolher (R$)': calculo.total?.toFixed(2) || '0.00',
                'Status': calculo.status === 'Erro' ? 'Erro' : 
                         calculo.aplicavel ? (calculo.difal > 0 ? 'Aplic√°vel' : 'Isento') : 'N√£o Aplic√°vel',
                'Motivo': calculo.motivo || calculo.status === 'Erro' ? 'Erro no processamento' : ''
            }));
            
            const worksheet = XLSX.utils.json_to_sheet(dadosExcel);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, 'C√°lculos DIFAL');
            
            const colWidths = [];
            Object.keys(dadosExcel[0]).forEach(key => {
                colWidths.push({ wch: Math.max(key.length, 12) });
            });
            worksheet['!cols'] = colWidths;
            
            XLSX.writeFile(workbook, `calculos_difal_${new Date().toISOString().split('T')[0]}.xlsx`);
        }

        function fazerBackup() {
            if (todosCalculos.length === 0) {
                alert('N√£o h√° dados para backup.');
                return;
            }

            const backup = {
                calculos: todosCalculos,
                aliquotasInternas: aliquotasInternas,
                fundoPobreza: fundoPobreza,
                timestamp: new Date().toISOString(),
                versao: '3.0',
                totalRegistros: todosCalculos.length
            };
            
            const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `backup_difal_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            alert(`Backup realizado com sucesso! ${todosCalculos.length} registros salvos.`);
        }

        function limparTudo() {
            if (confirm('Tem certeza que deseja limpar todos os c√°lculos?')) {
                todosCalculos = [];
                cacheCalculos.clear();
                atualizarTabela();
                atualizarResumo();
                document.getElementById('resultadoManual').innerHTML = '';
                localStorage.removeItem('historicoDIFAL');
            }
        }

        function calcularManual() {
            const ufOrigem = document.getElementById('ufOrigem').value;
            const ufDestino = document.getElementById('ufDestino').value;
            const valorBase = sanitizarValor(document.getElementById('valorBase').value);

            if (!ufOrigem || !ufDestino || !valorBase || valorBase <= 0) {
                alert('Por favor, preencha todos os campos com valores v√°lidos.');
                return;
            }

            const resultado = calcularDIFALComCache(ufOrigem, ufDestino, 'consumidor', valorBase);
            exibirResultadoManual(resultado);
        }

        function exibirResultadoManual(resultado) {
            const resultadoDiv = document.getElementById('resultadoManual');
            
            let html = '<div style="background: #d4edda; padding: 15px; border-radius: 8px; border: 2px solid #28a745;">';
            
            if (!resultado.aplicavel) {
                html = '<div style="background: #fff3cd; padding: 15px; border-radius: 8px; border: 2px solid #ffc107;">';
                html += `<h4>‚ö†Ô∏è DIFAL N√£o Aplic√°vel</h4>`;
                html += `<p><strong>Motivo:</strong> ${resultado.motivo}</p>`;
            } else {
                html += `<h4>‚úÖ Resultado do C√°lculo DIFAL</h4>`;
                html += `<p><strong>Origem:</strong> ${resultado.origem} ‚Üí <strong>Destino:</strong> ${resultado.destino}</p>`;
                
                resultado.detalhes.forEach(detalhe => {
                    html += `
                        <div class="detalhes-item">
                            <span>${detalhe.descricao}:</span>
                            <span>
                                ${typeof detalhe.valor === 'number' ? 
                                  (detalhe.descricao.includes('Al√≠quota') || detalhe.descricao.includes('Fundo') ? 
                                   `${detalhe.valor}%` : `R$ ${detalhe.valor.toFixed(2)}`) : 
                                  detalhe.valor}
                                ${detalhe.formula ? `<br><small style="color: #666;">${detalhe.formula}</small>` : ''}
                            </span>
                        </div>
                    `;
                });
                
                html += `
                    <div class="detalhes-total">
                        <span>TOTAL A RECOLHER (DIFAL + FCP):</span>
                        <span>R$ ${resultado.total.toFixed(2)}</span>
                    </div>
                    <div style="margin-top: 10px; padding: 10px; background: #c3e6cb; border-radius: 5px;">
                        <small>üí° Recolhimento via GNRE para o estado de ${resultado.destino}</small>
                    </div>
                `;
            }
            
            html += '</div>';
            resultadoDiv.innerHTML = html;
        }

        // FUN√á√ïES DE ADMINISTRA√á√ÉO DE AL√çQUOTAS
        function renderizarTabelaAdmin() {
            const tbody = document.getElementById('tabelaAdmin');
            tbody.innerHTML = '';

            const estados = Object.keys(aliquotasInternas).sort();
            
            estados.forEach(estado => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><strong>${estado}</strong></td>
                    <td>
                        <input type="number" 
                               value="${aliquotasInternas[estado]}" 
                               step="0.1" 
                               min="0" 
                               max="100"
                               onchange="atualizarAliquotaInterna('${estado}', this.value)"
                               style="width: 80px; padding: 4px; border: 1px solid #ddd; border-radius: 3px; text-align: center;">
                        %
                    </td>
                    <td>
                        <input type="number" 
                               value="${fundoPobreza[estado] || 0}" 
                               step="0.1" 
                               min="0" 
                               max="100"
                               onchange="atualizarFCP('${estado}', this.value)"
                               style="width: 80px; padding: 4px; border: 1px solid #ddd; border-radius: 3px; text-align: center;">
                        %
                    </td>
                    <td>${new Date().toLocaleDateString('pt-BR')}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        function atualizarAliquotaInterna(estado, valor) {
            aliquotasInternas[estado] = parseFloat(valor) || 0;
            cacheCalculos.clear(); // Limpar cache para recalcular com novas al√≠quotas
        }

        function atualizarFCP(estado, valor) {
            fundoPobreza[estado] = parseFloat(valor) || 0;
            cacheCalculos.clear(); // Limpar cache para recalcular com novas al√≠quotas
        }

        function filtrarTabelaAdmin() {
            const filtro = document.getElementById('filtroAdmin').value.toUpperCase();
            const linhas = document.querySelectorAll('#tabelaAdmin tr');
            
            linhas.forEach(linha => {
                const estado = linha.cells[0].textContent;
                linha.style.display = estado.includes(filtro) ? '' : 'none';
            });
        }

        function carregarAliquotasPadrao() {
            if (confirm('Isso ir√° restaurar as al√≠quotas padr√£o. Deseja continuar?')) {
                aliquotasInternas = {
                    'AC': 19, 'AL': 20, 'AP': 18, 'AM': 20, 'BA': 20.5, 'CE': 20, 'DF': 20, 'ES': 17, 
                    'GO': 19, 'MA': 23, 'MT': 17, 'MS': 17, 'MG': 18, 'PA': 19, 'PB': 20, 'PR': 19.5, 
                    'PE': 20.5, 'PI': 22.5, 'RJ': 22, 'RN': 20, 'RS': 17, 'RO': 19.5, 'RR': 20, 'SC': 17, 
                    'SP': 18, 'SE': 20, 'TO': 20
                };
                
                fundoPobreza = {
                    'AC': 0, 'AL': 0, 'AP': 0, 'AM': 0, 'BA': 0, 'CE': 0, 'DF': 0, 'ES': 0, 
                    'GO': 0, 'MA': 0, 'MT': 0, 'MS': 0, 'MG': 0, 'PA': 0, 'PB': 0, 'PR': 0, 
                    'PE': 0, 'PI': 0, 'RJ': 0, 'RN': 0, 'RS': 0, 'RO': 0, 'RR': 0, 'SC': 0, 
                    'SP': 0, 'SE': 0, 'TO': 0
                };
                
                renderizarTabelaAdmin();
                cacheCalculos.clear();
                alert('Al√≠quotas padr√£o restauradas com sucesso!');
            }
        }

        function exportarAliquotas() {
            const data = {
                aliquotasInternas: aliquotasInternas,
                fundoPobreza: fundoPobreza,
                timestamp: new Date().toISOString(),
                versao: '1.0'
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `aliquotas_difal_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function importarAliquotas() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = function(e) {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = JSON.parse(e.target.result);
                        if (data.aliquotasInternas && data.fundoPobreza) {
                            aliquotasInternas = data.aliquotasInternas;
                            fundoPobreza = data.fundoPobreza;
                            renderizarTabelaAdmin();
                            cacheCalculos.clear();
                            alert('Al√≠quotas importadas com sucesso!');
                        } else {
                            alert('Arquivo inv√°lido. Estrutura de dados n√£o reconhecida.');
                        }
                    } catch (error) {
                        alert('Erro ao importar arquivo: ' + error.message);
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }
    </script>
</body>
</html>
