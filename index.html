<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora DIFAL - Multi Tipos de C√°lculo 2025</title>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        header {
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }

        .tab {
            padding: 15px 30px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 16px;
            font-weight: 600;
            color: #6c757d;
            transition: all 0.3s;
        }

        .tab.active {
            color: #3498db;
            border-bottom: 3px solid #3498db;
            background: white;
        }

        .tab:hover {
            background: #e9ecef;
        }

        .tab-content {
            display: none;
            padding: 20px;
        }

        .tab-content.active {
            display: block;
        }

        .controls {
            display: flex;
            gap: 15px;
            padding: 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #3498db;
            color: white;
        }

        .btn-success {
            background: #27ae60;
            color: white;
        }

        .btn-warning {
            background: #f39c12;
            color: white;
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn-info {
            background: #17a2b8;
            color: white;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            padding: 20px;
        }

        .section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #dee2e6;
            max-height: 80vh;
            overflow-y: auto;
        }

        h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.5em;
        }

        .upload-area {
            border: 3px dashed #3498db;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            transition: all 0.3s;
            cursor: pointer;
            margin-bottom: 20px;
        }

        .upload-area:hover {
            background: #e3f2fd;
            border-color: #2980b9;
        }

        .upload-area input {
            display: none;
        }

        .resumo {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .tabela-resultados {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 12px;
        }

        .tabela-resultados th,
        .tabela-resultados td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }

        .tabela-resultados th {
            background: #34495e;
            color: white;
            font-weight: 600;
            position: sticky;
            top: 0;
        }

        .tabela-resultados tr:hover {
            background: #e9ecef;
        }

        .status-applicable {
            color: #27ae60;
            font-weight: bold;
        }

        .status-not-applicable {
            color: #e74c3c;
            font-weight: bold;
        }

        .status-exempt {
            color: #f39c12;
            font-weight: bold;
        }

        .detalhes-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            padding: 8px 0;
            border-bottom: 1px solid rgba(0,0,0,0.1);
        }

        .detalhes-total {
            font-weight: bold;
            font-size: 1.2em;
            color: #155724;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 2px solid #28a745;
        }

        .xml-info {
            background: #fff3cd;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid #ffc107;
        }

        .calculadora-section {
            background: white;
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #3498db;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #2c3e50;
        }

        .form-group select, 
        .form-group input {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        .form-group select:focus, 
        .form-group input:focus {
            outline: none;
            border-color: #3498db;
        }

        .filtros {
            margin-bottom: 15px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .filtros input, .filtros select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            flex: 1;
            min-width: 200px;
        }

        .progresso-container {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
            display: none;
        }

        .progresso-bar {
            width: 200px;
            height: 10px;
            background: #f0f0f0;
            border-radius: 5px;
            margin-top: 5px;
            overflow: hidden;
        }

        .progresso-fill {
            height: 100%;
            background: #3498db;
            border-radius: 5px;
            transition: width 0.3s ease;
        }

        .config-section {
            background: #fff3cd;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            border-left: 4px solid #ffc107;
        }

        .admin-section {
            background: white;
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #e74c3c;
            margin-top: 20px;
        }

        .tabela-admin {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 12px;
        }

        .tabela-admin th,
        .tabela-admin td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }

        .tabela-admin th {
            background: #34495e;
            color: white;
            font-weight: 600;
        }

        .tabela-admin input {
            width: 80px;
            padding: 4px;
            border: 1px solid #ddd;
            border-radius: 3px;
            text-align: center;
        }

        /* NOVOS ESTILOS PARA TIPOS DE C√ÅLCULO */
        .tipo-calculo-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: bold;
            margin: 2px;
        }
        
        .tipo-basico { background: #28a745; color: white; }
        .tipo-por-dentro { background: #17a2b8; color: white; }
        .tipo-fcp { background: #e74c3c; color: white; }
        .tipo-importado { background: #6f42c1; color: white; }
        .tipo-st { background: #fd7e14; color: white; }
        .tipo-simples { background: #20c997; color: white; }
        .tipo-beneficio { background: #ffc107; color: black; }
        
        .recomendacao-box {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
        }
        
        .detalhes-tipo-calculo {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
            border: 1px solid #dee2e6;
        }

        /* NOVOS ESTILOS ADICIONADOS */
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        .status-pendente {
            color: #ffc107;
            font-weight: bold;
        }

        .status-agendado {
            color: #17a2b8;
            font-weight: bold;
        }

        .status-pago {
            color: #28a745;
            font-weight: bold;
        }

        .gestao-pagamento {
            background: #fff3cd;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 4px solid #ffc107;
        }

        .selecao-tipo-calculo {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border: 1px solid #2196f3;
        }

        .comparacao-tipos {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border: 1px solid #dee2e6;
        }

        .tooltip {
            position: relative;
            display: inline-block;
            cursor: help;
        }

        .tooltip .tooltiptext {
            visibility: hidden;
            width: 200px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -100px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 12px;
        }

        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }

        .modo-escuro {
            background: #2c3e50;
            color: #ecf0f1;
        }

        .modo-escuro .section {
            background: #34495e;
            color: #ecf0f1;
        }

        .grafico-container {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border: 1px solid #dee2e6;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .controls {
                flex-direction: column;
            }
            
            .tabela-resultados {
                font-size: 10px;
            }
            
            .tabs {
                flex-wrap: wrap;
            }
            
            .tab {
                padding: 10px 15px;
                font-size: 14px;
            }
        }

        @media (prefers-reduced-motion: reduce) {
            * {
                animation: none !important;
                transition: none !important;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üßÆ Calculadora DIFAL - Multi Tipos de C√°lculo 2025</h1>
            <p>Identifica√ß√£o autom√°tica do tipo de c√°lculo DIFAL conforme legisla√ß√£o 2025</p>
        </header>

        <div class="tabs">
            <button class="tab active" onclick="abrirTab('tabCalculadora')">Calculadora</button>
            <button class="tab" onclick="abrirTab('tabAdmin')">Administrar Al√≠quotas</button>
            <button class="tab" onclick="abrirTab('tabGestao')">Gest√£o de Pagamentos</button>
        </div>

        <div id="tabCalculadora" class="tab-content active">
            <div class="controls">
                <button class="btn btn-primary" onclick="processarTodosXMLs()">Processar Todos XMLs</button>
                <button class="btn btn-success" onclick="exportarExcel()">Exportar para Excel</button>
                <button class="btn btn-info" onclick="fazerBackup()">Fazer Backup</button>
                <button class="btn btn-warning" onclick="limparTudo()">Limpar Tudo</button>
                <button class="btn btn-secondary" onclick="alternarModoEscuro()">Modo Escuro</button>
            </div>

            <div class="progresso-container" id="progressoContainer">
                <div id="progressoTexto">Processando...</div>
                <div class="progresso-bar">
                    <div class="progresso-fill" id="progressoFill"></div>
                </div>
            </div>

            <div class="main-content">
                <div class="section">
                    <h2>Importar NFes (XML)</h2>
                    <div class="upload-area" id="uploadArea">
                        <input type="file" id="xmlUpload" accept=".xml" multiple>
                        <div class="upload-placeholder">
                            <span>üìÅ Arraste XMLs aqui ou clique para selecionar</span>
                            <br>
                            <small>Suporte para m√∫ltiplos arquivos - Processamento real de XML</small>
                        </div>
                    </div>

                    <div class="resumo">
                        <h4>Resumo dos C√°lculos</h4>
                        <div id="resumoCalculos">Nenhum XML processado</div>
                    </div>

                    <div class="config-section">
                        <h4>‚öôÔ∏è Configura√ß√µes</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;">
                            <label>
                                <input type="checkbox" id="autoProcessar" checked> Auto-processar
                            </label>
                            <label>
                                <input type="checkbox" id="manterHistorico" checked> Manter hist√≥rico
                            </label>
                            <label>
                                <input type="checkbox" id="usarWebWorker"> Usar processamento em background
                            </label>
                            <label>
                                <input type="checkbox" id="modoEscuro"> Modo escuro permanente
                            </label>
                        </div>
                    </div>

                    <div class="calculadora-section">
                        <h3>Calculadora Manual</h3>
                        <div class="form-group">
                            <label for="ufOrigem">UF de Origem:</label>
                            <select id="ufOrigem">
                                <option value="">Selecione...</option>
                                <option value="AC">AC</option>
                                <option value="AL">AL</option>
                                <option value="AP">AP</option>
                                <option value="AM">AM</option>
                                <option value="BA">BA</option>
                                <option value="CE">CE</option>
                                <option value="DF">DF</option>
                                <option value="ES">ES</option>
                                <option value="GO">GO</option>
                                <option value="MA">MA</option>
                                <option value="MT">MT</option>
                                <option value="MS">MS</option>
                                <option value="MG">MG</option>
                                <option value="PA">PA</option>
                                <option value="PB">PB</option>
                                <option value="PR">PR</option>
                                <option value="PE">PE</option>
                                <option value="PI">PI</option>
                                <option value="RJ">RJ</option>
                                <option value="RN">RN</option>
                                <option value="RS">RS</option>
                                <option value="RO">RO</option>
                                <option value="RR">RR</option>
                                <option value="SC">SC</option>
                                <option value="SP">SP</option>
                                <option value="SE">SE</option>
                                <option value="TO">TO</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="ufDestino">UF de Destino:</label>
                            <select id="ufDestino">
                                <option value="">Selecione...</option>
                                <option value="AC">AC</option>
                                <option value="AL">AL</option>
                                <option value="AP">AP</option>
                                <option value="AM">AM</option>
                                <option value="BA">BA</option>
                                <option value="CE">CE</option>
                                <option value="DF">DF</option>
                                <option value="ES">ES</option>
                                <option value="GO">GO</option>
                                <option value="MA">MA</option>
                                <option value="MT">MT</option>
                                <option value="MS">MS</option>
                                <option value="MG">MG</option>
                                <option value="PA">PA</option>
                                <option value="PB">PB</option>
                                <option value="PR">PR</option>
                                <option value="PE">PE</option>
                                <option value="PI">PI</option>
                                <option value="RJ">RJ</option>
                                <option value="RN">RN</option>
                                <option value="RS">RS</option>
                                <option value="RO">RO</option>
                                <option value="RR">RR</option>
                                <option value="SC">SC</option>
                                <option value="SP">SP</option>
                                <option value="SE">SE</option>
                                <option value="TO">TO</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="valorBase">Valor Base (R$):</label>
                            <input type="text" id="valorBase" placeholder="0,00" oninput="formatarMoeda(this)">
                        </div>

                        <div class="form-group">
                            <label for="tipoCalculoManual">Tipo de C√°lculo:</label>
                            <select id="tipoCalculoManual">
                                <option value="BASICO">B√°sico (Por Fora)</option>
                                <option value="POR_DENTRO">Por Dentro</option>
                                <option value="COM_FCP">Com FCP</option>
                                <option value="IMPORTADO">Importado</option>
                                <option value="SUBSTITUICAO_TRIBUTARIA">Subst. Tribut√°ria</option>
                                <option value="SIMPLES_NACIONAL">Simples Nacional</option>
                                <option value="BENEFICIO_FISCAL">Benef√≠cio Fiscal</option>
                            </select>
                        </div>

                        <button class="btn btn-primary" onclick="calcularManual()" style="width: 100%;">Calcular DIFAL Manual</button>

                        <div id="resultadoManual" style="margin-top: 15px;"></div>
                    </div>
                </div>

                <div class="section">
                    <h2>Resultados dos C√°lculos</h2>
                    
                    <div class="filtros">
                        <input type="text" id="filtroTabela" placeholder="Filtrar por NF-e, UF, status..." oninput="filtrarTabela()">
                        <select id="filtroStatus" onchange="filtrarTabela()">
                            <option value="">Todos os status</option>
                            <option value="Aplic√°vel">Aplic√°vel</option>
                            <option value="Isento">Isento</option>
                            <option value="N√£o Aplic√°vel">N√£o Aplic√°vel</option>
                            <option value="Erro">Erro</option>
                            <option value="Pendente">Pendente</option>
                            <option value="Agendado">Agendado</option>
                            <option value="Pago">Pago</option>
                        </select>
                        <select id="filtroTipoCalculo" onchange="filtrarTabela()">
                            <option value="">Todos os tipos</option>
                            <option value="B√°sico">B√°sico</option>
                            <option value="Por Dentro">Por Dentro</option>
                            <option value="Com FCP">Com FCP</option>
                            <option value="Importado">Importado</option>
                            <option value="ST">Subst. Trib.</option>
                            <option value="Simples">Simples</option>
                            <option value="Benef√≠cio">Benef√≠cio</option>
                        </select>
                    </div>

                    <div class="tabela-container">
                        <table class="tabela-resultados">
                            <thead>
                                <tr>
                                    <th>NF-e</th>
                                    <th>Origem</th>
                                    <th>Destino</th>
                                    <th>Valor Total</th>
                                    <th>Aliq. Inter</th>
                                    <th>Aliq. Interna</th>
                                    <th>DIFAL</th>
                                    <th>FCP</th>
                                    <th>Tipo C√°lculo</th>
                                    <th>Status Pag.</th>
                                    <th>A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody id="tabelaResultados">
                                <tr>
                                    <td colspan="11" style="text-align: center; padding: 20px;">
                                        Nenhum resultado dispon√≠vel
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div id="detalhesContainer"></div>
                </div>
            </div>
        </div>

        <div id="tabAdmin" class="tab-content">
            <div class="admin-section">
                <h2>üìä Administra√ß√£o de Al√≠quotas</h2>
                <p>Edite as al√≠quotas internas e FCP conforme necess√°rio. As altera√ß√µes s√£o salvas automaticamente.</p>
                
                <div class="controls">
                    <button class="btn btn-success" onclick="salvarAliquotas()">Salvar Al√≠quotas</button>
                    <button class="btn btn-primary" onclick="carregarAliquotasPadrao()">Restaurar Padr√£o</button>
                    <button class="btn btn-info" onclick="exportarAliquotas()">Exportar Al√≠quotas</button>
                    <button class="btn btn-warning" onclick="importarAliquotas()">Importar Al√≠quotas</button>
                </div>

                <div class="filtros">
                    <input type="text" id="filtroAdmin" placeholder="Filtrar por estado..." oninput="filtrarTabelaAdmin()">
                </div>

                <table class="tabela-admin">
                    <thead>
                        <tr>
                            <th>Estado</th>
                            <th>Al√≠quota Interna (%)</th>
                            <th>FCP (%)</th>
                            <th>Vig√™ncia</th>
                            <th>Fonte</th>
                        </tr>
                    </thead>
                    <tbody id="tabelaAdmin">
                        <!-- Preenchido via JavaScript -->
                    </tbody>
                </table>

                <div style="margin-top: 20px; padding: 15px; background: #e3f2fd; border-radius: 8px;">
                    <h4>‚ÑπÔ∏è Regras Interestaduais Atuais</h4>
                    <ul style="margin-top: 10px;">
                        <li><strong>Produtos importados:</strong> 4%</li>
                        <li><strong>Sul/Sudeste (exceto ES) ‚Üí Norte/Nordeste/Centro-Oeste/ES:</strong> 7%</li>
                        <li><strong>Demais opera√ß√µes interestaduais:</strong> 12%</li>
                    </ul>
                    <p style="margin-top: 10px; font-size: 12px; color: #666;">
                        * As regras interestaduais s√£o calculadas automaticamente com base nas UFs de origem e destino.
                    </p>
                </div>
            </div>
        </div>

        <div id="tabGestao" class="tab-content">
            <div class="admin-section">
                <h2>üìÖ Gest√£o de Pagamentos</h2>
                <p>Controle o status de pagamento das NF-es e agende para meses futuros.</p>
                
                <div class="controls">
                    <button class="btn btn-success" onclick="marcarComoPago()">Marcar como Pago</button>
                    <button class="btn btn-warning" onclick="agendarParaMesSeguinte()">Agendar Pr√≥ximo M√™s</button>
                    <button class="btn btn-info" onclick="gerarRelatorioPagamentos()">Relat√≥rio de Pagamentos</button>
                    <button class="btn btn-primary" onclick="exportarGNRE()">Exportar para GNRE</button>
                </div>

                <div class="gestao-pagamento">
                    <h4>Resumo de Pagamentos</h4>
                    <div id="resumoPagamentos" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 10px;">
                        <!-- Preenchido via JavaScript -->
                    </div>
                </div>

                <div class="filtros">
                    <input type="text" id="filtroGestao" placeholder="Filtrar por NF-e, status..." oninput="filtrarTabelaGestao()">
                    <select id="filtroMes" onchange="filtrarTabelaGestao()">
                        <option value="">Todos os meses</option>
                        <option value="01">Janeiro</option>
                        <option value="02">Fevereiro</option>
                        <option value="03">Mar√ßo</option>
                        <option value="04">Abril</option>
                        <option value="05">Maio</option>
                        <option value="06">Junho</option>
                        <option value="07">Julho</option>
                        <option value="08">Agosto</option>
                        <option value="09">Setembro</option>
                        <option value="10">Outubro</option>
                        <option value="11">Novembro</option>
                        <option value="12">Dezembro</option>
                    </select>
                    <select id="filtroAno" onchange="filtrarTabelaGestao()">
                        <option value="">Todos os anos</option>
                        <option value="2024">2024</option>
                        <option value="2025">2025</option>
                        <option value="2026">2026</option>
                    </select>
                </div>

                <table class="tabela-admin">
                    <thead>
                        <tr>
                            <th><input type="checkbox" id="selectAll" onchange="selecionarTodos()"></th>
                            <th>NF-e</th>
                            <th>Destino</th>
                            <th>Valor DIFAL</th>
                            <th>Valor FCP</th>
                            <th>Total</th>
                            <th>Status</th>
                            <th>M√™s/Ano Ref.</th>
                            <th>Vencimento</th>
                            <th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody id="tabelaGestao">
                        <!-- Preenchido via JavaScript -->
                    </tbody>
                </table>

                <div class="grafico-container">
                    <h4>üìä Distribui√ß√£o de Pagamentos por M√™s</h4>
                    <div id="graficoPagamentos" style="height: 200px; background: #f8f9fa; border-radius: 5px; padding: 10px;">
                        <!-- Gr√°fico ser√° renderizado aqui -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Web Worker para processamento em background
        const xmlWorker = new Worker(URL.createObjectURL(new Blob([`
            self.onmessage = function(e) {
                const { xmlContent, fileName } = e.data;
                try {
                    const parser = new DOMParser();
                    const xmlDoc = parser.parseFromString(xmlContent, "text/xml");
                    
                    if (xmlDoc.getElementsByTagName("parsererror").length > 0) {
                        throw new Error("XML inv√°lido ou mal formado");
                    }

                    // Extrair dados do XML (c√≥digo simplificado para o worker)
                    const emit = xmlDoc.getElementsByTagName("emit")[0];
                    const dest = xmlDoc.getElementsByTagName("dest")[0];
                    const total = xmlDoc.getElementsByTagName("total")[0];
                    const ICMSTot = total ? total.getElementsByTagName("ICMSTot")[0] : null;
                    
                    const emitUF = emit.getElementsByTagName("UF")[0]?.textContent;
                    const destUF = dest.getElementsByTagName("UF")[0]?.textContent;
                    const vNF = ICMSTot ? ICMSTot.getElementsByTagName("vNF")[0]?.textContent : "0";
                    
                    self.postMessage({
                        success: true,
                        data: { emitUF, destUF, vNF, fileName }
                    });
                } catch (error) {
                    self.postMessage({
                        success: false,
                        error: error.message,
                        fileName: fileName
                    });
                }
            };
        `], { type: 'text/javascript' })));

        // TIPOS DE C√ÅLCULO DIFAL
        const TIPOS_CALCULO = {
            BASICO: {
                codigo: 'BASICO',
                nome: 'C√°lculo B√°sico (Por Fora)',
                descricao: 'Opera√ß√µes padr√£o para consumidor final n√£o contribuinte',
                formula: 'DIFAL = Base √ó (Al√≠quota Interna - Al√≠quota Interestadual)',
                cor: 'tipo-basico'
            },
            POR_DENTRO: {
                codigo: 'POR_DENTRO',
                nome: 'C√°lculo Por Dentro',
                descricao: 'Quando o ICMS comp√µe o pre√ßo da mercadoria',
                formula: 'DIFAL = [Base √ó (Al√≠quota Interna - Al√≠quota Interestadual)] √∑ (1 - Al√≠quota Interna)',
                cor: 'tipo-por-dentro'
            },
            COM_FCP: {
                codigo: 'COM_FCP',
                nome: 'Com FCP',
                descricao: 'Estados com adicional de Fundo de Combate √† Pobreza',
                formula: 'FCP = Base √ó Al√≠quota FCP | Total = DIFAL + FCP',
                cor: 'tipo-fcp'
            },
            IMPORTADO: {
                codigo: 'IMPORTADO',
                nome: 'Produtos Importados',
                descricao: 'Mercadorias importadas do exterior',
                formula: 'Al√≠quota Interestadual = 4% (Resolu√ß√£o Senado 13/2012)',
                cor: 'tipo-importado'
            },
            SUBSTITUICAO_TRIBUTARIA: {
                codigo: 'SUBSTITUICAO_TRIBUTARIA',
                nome: 'Substitui√ß√£o Tribut√°ria',
                descricao: 'Quando a mercadoria j√° tem ICMS-ST',
                formula: 'Regras espec√≠ficas por estado/produto',
                cor: 'tipo-st'
            },
            SIMPLES_NACIONAL: {
                codigo: 'SIMPLES_NACIONAL',
                nome: 'Simples Nacional',
                descricao: 'Empresas do Simples Nacional',
                formula: 'Recolhimento via DAS ou separadamente',
                cor: 'tipo-simples'
            },
            BENEFICIO_FISCAL: {
                codigo: 'BENEFICIO_FISCAL',
                nome: 'Benef√≠cio Fiscal',
                descricao: 'Redu√ß√£o da base ou al√≠quota interna',
                formula: 'Base/Al√≠quota reduzida conforme conv√™nio',
                cor: 'tipo-beneficio'
            }
        };

        // BANCO DE DADOS ATUALIZADO COM VIG√äNCIA
        let aliquotasInternas = {
            'AC': { valor: 19, vigencia: '2024-01-01', fonte: 'Decreto Estadual' },
            'AL': { valor: 20, vigencia: '2024-01-01', fonte: 'Decreto Estadual' },
            'AP': { valor: 18, vigencia: '2024-01-01', fonte: 'Decreto Estadual' },
            'AM': { valor: 20, vigencia: '2024-01-01', fonte: 'Decreto Estadual' },
            'BA': { valor: 20.5, vigencia: '2024-01-01', fonte: 'Decreto Estadual' },
            'CE': { valor: 20, vigencia: '2024-01-01', fonte: 'Decreto Estadual' },
            'DF': { valor: 20, vigencia: '2024-01-01', fonte: 'Decreto Estadual' },
            'ES': { valor: 17, vigencia: '2024-01-01', fonte: 'Decreto Estadual' },
            'GO': { valor: 19, vigencia: '2024-01-01', fonte: 'Decreto Estadual' },
            'MA': { valor: 23, vigencia: '2024-01-01', fonte: 'Decreto Estadual' },
            'MT': { valor: 17, vigencia: '2024-01-01', fonte: 'Decreto Estadual' },
            'MS': { valor: 17, vigencia: '2024-01-01', fonte: 'Decreto Estadual' },
            'MG': { valor: 18, vigencia: '2024-01-01', fonte: 'Decreto Estadual' },
            'PA': { valor: 19, vigencia: '2024-01-01', fonte: 'Decreto Estadual' },
            'PB': { valor: 20, vigencia: '2024-01-01', fonte: 'Decreto Estadual' },
            'PR': { valor: 19.5, vigencia: '2024-01-01', fonte: 'Decreto Estadual' },
            'PE': { valor: 20.5, vigencia: '2024-01-01', fonte: 'Decreto Estadual' },
            'PI': { valor: 22.5, vigencia: '2024-01-01', fonte: 'Decreto Estadual' },
            'RJ': { valor: 22, vigencia: '2024-01-01', fonte: 'Decreto Estadual' },
            'RN': { valor: 20, vigencia: '2024-01-01', fonte: 'Decreto Estadual' },
            'RS': { valor: 17, vigencia: '2024-01-01', fonte: 'Decreto Estadual' },
            'RO': { valor: 19.5, vigencia: '2024-01-01', fonte: 'Decreto Estadual' },
            'RR': { valor: 20, vigencia: '2024-01-01', fonte: 'Decreto Estadual' },
            'SC': { valor: 17, vigencia: '2024-01-01', fonte: 'Decreto Estadual' },
            'SP': { valor: 18, vigencia: '2024-01-01', fonte: 'Decreto Estadual' },
            'SE': { valor: 20, vigencia: '2024-01-01', fonte: 'Decreto Estadual' },
            'TO': { valor: 20, vigencia: '2024-01-01', fonte: 'Decreto Estadual' }
        };

        let fundoPobreza = {
            'AC': 0, 'AL': 0, 'AP': 0, 'AM': 0, 'BA': 0, 'CE': 0, 'DF': 0, 'ES': 0, 
            'GO': 0, 'MA': 0, 'MT': 0, 'MS': 0, 'MG': 0, 'PA': 0, 'PB': 0, 'PR': 0, 
            'PE': 0, 'PI': 0, 'RJ': 0, 'RN': 0, 'RS': 0, 'RO': 0, 'RR': 0, 'SC': 0, 
            'SP': 0, 'SE': 0, 'TO': 0
        };

        // Array para armazenar todos os c√°lculos
        let todosCalculos = [];
        let cacheCalculos = new Map();
        let configUsuario = {
            autoProcessar: true,
            manterHistorico: true,
            usarWebWorker: false,
            modoEscuro: false,
            formatoMoeda: 'BRL',
            casasDecimais: 2
        };

        // Sistema de cache melhorado
        const cacheManager = {
            get: (chave) => {
                try {
                    const item = localStorage.getItem(`cache_${chave}`);
                    if (!item) return null;
                    
                    const { valor, expiracao } = JSON.parse(item);
                    if (Date.now() > expiracao) {
                        localStorage.removeItem(`cache_${chave}`);
                        return null;
                    }
                    return valor;
                } catch {
                    return null;
                }
            },
            
            set: (chave, valor, expiracaoMinutos = 60) => {
                try {
                    const item = {
                        valor: valor,
                        expiracao: Date.now() + (expiracaoMinutos * 60 * 1000)
                    };
                    localStorage.setItem(`cache_${chave}`, JSON.stringify(item));
                } catch (error) {
                    console.warn('Erro ao salvar cache:', error);
                }
            },
            
            clear: () => {
                Object.keys(localStorage).forEach(key => {
                    if (key.startsWith('cache_')) {
                        localStorage.removeItem(key);
                    }
                });
            }
        };

        // FUN√á√ïES QUE ESTAVAM FALTANDO DA VERS√ÉO ANTERIOR
        function configurarUpload() {
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('xmlUpload');
            
            uploadArea.addEventListener('click', () => fileInput.click());
            
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.style.background = '#e3f2fd';
                uploadArea.style.borderColor = '#2196f3';
            });
            
            uploadArea.addEventListener('dragleave', () => {
                uploadArea.style.background = '';
                uploadArea.style.borderColor = '#3498db';
            });
            
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.style.background = '';
                uploadArea.style.borderColor = '#3498db';
                
                const files = e.dataTransfer.files;
                processarArquivos(files);
            });
            
            fileInput.addEventListener('change', (e) => {
                processarArquivos(e.target.files);
            });

            // Configurar eventos de configura√ß√£o
            document.getElementById('autoProcessar').addEventListener('change', salvarConfiguracoes);
            document.getElementById('manterHistorico').addEventListener('change', salvarConfiguracoes);
            document.getElementById('usarWebWorker').addEventListener('change', salvarConfiguracoes);
            document.getElementById('modoEscuro').addEventListener('change', salvarConfiguracoes);
        }

        function salvarConfiguracoes() {
            configUsuario.autoProcessar = document.getElementById('autoProcessar').checked;
            configUsuario.manterHistorico = document.getElementById('manterHistorico').checked;
            configUsuario.usarWebWorker = document.getElementById('usarWebWorker').checked;
            configUsuario.modoEscuro = document.getElementById('modoEscuro').checked;
            localStorage.setItem('configDIFAL', JSON.stringify(configUsuario));
        }

        function carregarConfiguracoes() {
            const configSalva = localStorage.getItem('configDIFAL');
            if (configSalva) {
                configUsuario = { ...configUsuario, ...JSON.parse(configSalva) };
                document.getElementById('autoProcessar').checked = configUsuario.autoProcessar;
                document.getElementById('manterHistorico').checked = configUsuario.manterHistorico;
                document.getElementById('usarWebWorker').checked = configUsuario.usarWebWorker;
                document.getElementById('modoEscuro').checked = configUsuario.modoEscuro;
                
                if (configUsuario.modoEscuro) {
                    alternarModoEscuro();
                }
            }
        }

        function carregarAliquotasSalvas() {
            const aliquotasSalvas = localStorage.getItem('aliquotasDIFAL');
            if (aliquotasSalvas) {
                const data = JSON.parse(aliquotasSalvas);
                aliquotasInternas = data.aliquotasInternas || aliquotasInternas;
                fundoPobreza = data.fundoPobreza || fundoPobreza;
            }
        }

        function salvarAliquotas() {
            const data = {
                aliquotasInternas: aliquotasInternas,
                fundoPobreza: fundoPobreza,
                timestamp: new Date().toISOString()
            };
            localStorage.setItem('aliquotasDIFAL', JSON.stringify(data));
            alert('Al√≠quotas salvas com sucesso!');
        }

        function carregarHistorico() {
            if (configUsuario.manterHistorico) {
                const historico = localStorage.getItem('historicoDIFAL');
                if (historico) {
                    todosCalculos = JSON.parse(historico);
                    atualizarTabela();
                    atualizarResumo();
                }
            }
        }

        function salvarHistorico() {
            if (configUsuario.manterHistorico) {
                localStorage.setItem('historicoDIFAL', JSON.stringify(todosCalculos));
            }
        }

        function processarArquivoComRetry(file, tentativa = 0) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        processarXMLReal(e.target.result, file.name);
                        resolve();
                    } catch (error) {
                        if (tentativa < 2) {
                            setTimeout(() => {
                                processarArquivoComRetry(file, tentativa + 1).then(resolve);
                            }, 1000);
                        } else {
                            console.error('Erro ao processar arquivo ap√≥s 3 tentativas:', file.name, error);
                            resolve();
                        }
                    }
                };
                reader.onerror = () => resolve();
                reader.readAsText(file);
            });
        }

        function mostrarProgresso(atual, total) {
            const container = document.getElementById('progressoContainer');
            const texto = document.getElementById('progressoTexto');
            const fill = document.getElementById('progressoFill');
            
            const percentual = (atual / total) * 100;
            texto.textContent = `Processando: ${atual}/${total} (${percentual.toFixed(1)}%)`;
            fill.style.width = `${percentual}%`;
            container.style.display = 'block';
        }

        function ocultarProgresso() {
            document.getElementById('progressoContainer').style.display = 'none';
        }

        function calcularAliquotaInterestadual(origem, destino) {
            // Regras conforme planilha
            const estadosSulSudesteExcetoES = ['PR', 'RS', 'SC', 'SP', 'MG', 'RJ'];
            const estadosDestino7 = ['AC', 'AL', 'AP', 'AM', 'BA', 'CE', 'DF', 'ES', 'GO', 'MA', 'MT', 'MS', 'PA', 'PB', 'PE', 'PI', 'RN', 'RO', 'RR', 'SE', 'TO'];
            
            if (estadosSulSudesteExcetoES.includes(origem) && estadosDestino7.includes(destino)) {
                return 7; // Sul/Sudeste (exceto ES) ‚Üí Norte/Nordeste/Centro-Oeste/ES
            }
            
            return 12; // Demais opera√ß√µes interestaduais
        }

        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', function() {
            configurarUpload();
            carregarConfiguracoes();
            carregarHistorico();
            carregarAliquotasSalvas();
            renderizarTabelaAdmin();
            atualizarResumoPagamentos();
            renderizarGraficoPagamentos();
            inicializarTooltips();
            
            // Configurar Web Worker
            xmlWorker.onmessage = function(e) {
                const { success, data, error, fileName } = e.data;
                if (success) {
                    console.log('XML processado via worker:', fileName);
                } else {
                    console.error('Erro no worker:', error);
                }
            };
        });

        function abrirTab(tabName) {
            // Esconder todas as tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Mostrar tab selecionada
            document.getElementById(tabName).classList.add('active');
            event.currentTarget.classList.add('active');

            // Atualizar conte√∫do espec√≠fico da tab
            if (tabName === 'tabGestao') {
                atualizarResumoPagamentos();
                renderizarTabelaGestao();
                renderizarGraficoPagamentos();
            }
        }

        // FUN√á√ÉO MELHORADA: processarArquivos com Web Worker
        async function processarArquivos(files) {
            const xmlFiles = Array.from(files).filter(file => file.name.endsWith('.xml'));
            
            if (xmlFiles.length === 0) {
                alert('Nenhum arquivo XML encontrado.');
                return;
            }

            mostrarProgresso(0, xmlFiles.length);

            // Aplicar estado de loading
            document.getElementById('uploadArea').classList.add('loading');

            try {
                if (configUsuario.usarWebWorker && xmlFiles.length > 5) {
                    await processarComWebWorker(xmlFiles);
                } else {
                    await processarSemWebWorker(xmlFiles);
                }
            } catch (error) {
                console.error('Erro no processamento:', error);
                alert('Erro ao processar arquivos: ' + error.message);
            } finally {
                document.getElementById('uploadArea').classList.remove('loading');
                ocultarProgresso();
                atualizarResumo();
                salvarHistorico();
                
                if (configUsuario.autoProcessar) {
                    processarTodosXMLs();
                }
            }
        }

        async function processarComWebWorker(xmlFiles) {
            const promises = xmlFiles.map(file => {
                return new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        xmlWorker.postMessage({
                            xmlContent: e.target.result,
                            fileName: file.name
                        });
                        resolve();
                    };
                    reader.readAsText(file);
                });
            });

            await Promise.all(promises);
        }

        async function processarSemWebWorker(xmlFiles) {
            for (let i = 0; i < xmlFiles.length; i++) {
                const file = xmlFiles[i];
                await processarArquivoComRetry(file);
                mostrarProgresso(i + 1, xmlFiles.length);
            }
        }

        // FUN√á√ÉO MELHORADA: identificarTipoCalculo com mais precis√£o
        function identificarTipoCalculo(xmlDoc, origem, destino, tipoDestinatario, baseCalculo) {
            const tiposAplicaveis = [];
            const recomendacao = {
                tipoPrincipal: null,
                tiposSecundarios: [],
                confianca: 0,
                motivo: ''
            };

            try {
                // 1. Verificar se √© produto importado
                if (ehProdutoImportado(xmlDoc)) {
                    tiposAplicaveis.push(TIPOS_CALCULO.IMPORTADO);
                    recomendacao.confianca += 30;
                }

                // 2. Verificar FCP
                if (fundoPobreza[destino] > 0) {
                    tiposAplicaveis.push(TIPOS_CALCULO.COM_FCP);
                    recomendacao.confianca += 20;
                }

                // 3. Verificar Substitui√ß√£o Tribut√°ria
                if (temSubstituicaoTributaria(xmlDoc)) {
                    tiposAplicaveis.push(TIPOS_CALCULO.SUBSTITUICAO_TRIBUTARIA);
                    recomendacao.confianca += 25;
                }

                // 4. Verificar Benef√≠cio Fiscal
                if (temBeneficioFiscal(xmlDoc, destino)) {
                    tiposAplicaveis.push(TIPOS_CALCULO.BENEFICIO_FISCAL);
                    recomendacao.confianca += 15;
                }

                // 5. Verificar Simples Nacional
                if (ehEmitenteSimplesNacional(xmlDoc)) {
                    tiposAplicaveis.push(TIPOS_CALCULO.SIMPLES_NACIONAL);
                    recomendacao.confianca += 20;
                }

                // 6. Verificar se precisa c√°lculo por dentro
                if (precisaCalculoPorDentro(xmlDoc, destino)) {
                    tiposAplicaveis.push(TIPOS_CALCULO.POR_DENTRO);
                    recomendacao.confianca += 25;
                }

                // 7. C√°lculo b√°sico sempre dispon√≠vel
                tiposAplicaveis.push(TIPOS_CALCULO.BASICO);
                recomendacao.confianca += 10;

                // Determinar tipo principal com base na confian√ßa
                if (tiposAplicaveis.includes(TIPOS_CALCULO.IMPORTADO)) {
                    recomendacao.tipoPrincipal = TIPOS_CALCULO.IMPORTADO;
                } else if (tiposAplicaveis.includes(TIPOS_CALCULO.SUBSTITUICAO_TRIBUTARIA)) {
                    recomendacao.tipoPrincipal = TIPOS_CALCULO.SUBSTITUICAO_TRIBUTARIA;
                } else if (tiposAplicaveis.includes(TIPOS_CALCULO.POR_DENTRO)) {
                    recomendacao.tipoPrincipal = TIPOS_CALCULO.POR_DENTRO;
                } else if (tiposAplicaveis.includes(TIPOS_CALCULO.COM_FCP)) {
                    recomendacao.tipoPrincipal = TIPOS_CALCULO.COM_FCP;
                } else {
                    recomendacao.tipoPrincipal = TIPOS_CALCULO.BASICO;
                }

                // Tipos secund√°rios (excluindo o principal)
                recomendacao.tiposSecundarios = tiposAplicaveis.filter(tipo => 
                    tipo.codigo !== recomendacao.tipoPrincipal.codigo
                );

                // Ajustar confian√ßa baseado na quantidade de indicadores
                const totalIndicadores = tiposAplicaveis.length;
                recomendacao.confianca = Math.min(100, recomendacao.confianca + (totalIndicadores * 5));

                recomendacao.motivo = gerarMotivoRecomendacao(recomendacao, xmlDoc, destino);

            } catch (error) {
                console.error('Erro ao identificar tipo de c√°lculo:', error);
                recomendacao.tipoPrincipal = TIPOS_CALCULO.BASICO;
                recomendacao.confianca = 50;
                recomendacao.motivo = 'Erro na an√°lise. Usando c√°lculo b√°sico como fallback.';
            }

            return recomendacao;
        }

        // FUN√á√ïES AUXILIARES PARA IDENTIFICA√á√ÉO DE TIPO DE C√ÅLCULO
        function ehProdutoImportado(xmlDoc) {
            try {
                // Verificar se h√° informa√ß√µes de importa√ß√£o
                const di = xmlDoc.getElementsByTagName('DI');
                const adi = xmlDoc.getElementsByTagName('adi');
                
                // Verificar se h√° indica√ß√£o de produto importado
                const origemProduto = xmlDoc.getElementsByTagName('orig');
                if (origemProduto.length > 0) {
                    const origem = origemProduto[0].textContent;
                    if (origem === '1' || origem === '2') return true; // 1=Nacional, 2=Estrangeira
                }
                
                return di.length > 0 || adi.length > 0;
            } catch (error) {
                return false;
            }
        }

        function temSubstituicaoTributaria(xmlDoc) {
            try {
                // Verificar se h√° ICMS-ST
                const icmsST = xmlDoc.getElementsByTagName('ICMSST');
                const vBCST = xmlDoc.getElementsByTagName('vBCST');
                const vICMSST = xmlDoc.getElementsByTagName('vICMSST');
                
                return icmsST.length > 0 || vBCST.length > 0 || vICMSST.length > 0;
            } catch (error) {
                return false;
            }
        }

        function temBeneficioFiscal(xmlDoc, destino) {
            try {
                // Verificar se h√° conv√™nio ou benef√≠cio fiscal
                const infAdProd = xmlDoc.getElementsByTagName('infAdProd');
                const textoInfAdProd = infAdProd.length > 0 ? infAdProd[0].textContent.toLowerCase() : '';
                
                const palavrasChave = [
                    'conv√™nio', 'convenio', 'benef√≠cio', 'beneficio', 'redu√ß√£o', 'reducao',
                    'isen√ß√£o', 'isencao', 'suspens√£o', 'suspensao', 'al√≠quota zero', 'aliquota zero'
                ];
                
                return palavrasChave.some(palavra => textoInfAdProd.includes(palavra));
            } catch (error) {
                return false;
            }
        }

        function ehEmitenteSimplesNacional(xmlDoc) {
            try {
                const emit = xmlDoc.getElementsByTagName('emit')[0];
                const crt = emit.getElementsByTagName('CRT')[0]?.textContent;
                
                // CRT = 1 (Simples Nacional)
                return crt === '1';
            } catch (error) {
                return false;
            }
        }

        function precisaCalculoPorDentro(xmlDoc, destino) {
            try {
                // Estados que normalmente exigem c√°lculo por dentro
                const estadosPorDentro = ['RJ', 'SP', 'MG', 'PR'];
                
                // Verificar se o produto tem indica√ß√£o de ICMS incluso
                const infAdProd = xmlDoc.getElementsByTagName('infAdProd');
                const textoInfAdProd = infAdProd.length > 0 ? infAdProd[0].textContent.toLowerCase() : '';
                
                const indicadoresPorDentro = [
                    'icms incluso', 'tributa√ß√£o monof√°sica', 'pre√ßo com icms',
                    'valor com icms', 'inclui icms'
                ];
                
                return estadosPorDentro.includes(destino) || 
                       indicadoresPorDentro.some(indicador => textoInfAdProd.includes(indicador));
            } catch (error) {
                return false;
            }
        }

        function gerarMotivoRecomendacao(recomendacao, xmlDoc, destino) {
            const motivos = [];
            
            if (recomendacao.tipoPrincipal.codigo === 'IMPORTADO') {
                motivos.push('Produto identificado como importado do exterior');
            }
            
            if (recomendacao.tiposSecundarios.some(t => t.codigo === 'COM_FCP')) {
                motivos.push(`Estado ${destino} possui FCP de ${fundoPobreza[destino]}%`);
            }
            
            if (recomendacao.tiposSecundarios.some(t => t.codigo === 'SUBSTITUICAO_TRIBUTARIA')) {
                motivos.push('Nota possui indica√ß√£o de Substitui√ß√£o Tribut√°ria');
            }
            
            if (recomendacao.tiposSecundarios.some(t => t.codigo === 'SIMPLES_NACIONAL')) {
                motivos.push('Emitente identificado como Simples Nacional');
            }
            
            if (recomendacao.tipoPrincipal.codigo === 'POR_DENTRO') {
                motivos.push('Caracter√≠sticas indicam necessidade de c√°lculo por dentro');
            }
            
            return motivos.length > 0 ? motivos.join(' | ') : 'C√°lculo padr√£o aplicado';
        }

        // FUN√á√ÉO CORRIGIDA: calcularDIFALMultiTipo com tratamento de erro
        function calcularDIFALMultiTipo(origem, destino, tipoDestinatario, baseCalculo, tipoCalculo, xmlDoc = null) {
            let resultado = {
                baseCalculo: baseCalculo,
                aliqInterestadual: calcularAliquotaInterestadual(origem, destino),
                aliqInterna: aliquotasInternas[destino]?.valor || 18,
                percFCP: fundoPobreza[destino] || 0,
                tipoCalculo: tipoCalculo,
                detalhes: [],
                erro: null
            };

            // Ajustar al√≠quota interestadual para importados
            if (tipoCalculo.codigo === 'IMPORTADO') {
                resultado.aliqInterestadual = 4;
            }

            try {
                // C√°lculo do DIFAL conforme tipo
                switch (tipoCalculo.codigo) {
                    case 'BASICO':
                        resultado.difal = baseCalculo * (resultado.aliqInterna - resultado.aliqInterestadual) / 100;
                        break;
                        
                    case 'POR_DENTRO':
                        const diferencial = resultado.aliqInterna - resultado.aliqInterestadual;
                        const divisor = (1 - resultado.aliqInterna / 100);
                        
                        // Prote√ß√£o contra divis√£o por zero
                        if (Math.abs(divisor) < 0.0001) {
                            resultado.difal = 0;
                            resultado.erro = 'Al√≠quota interna inv√°lida para c√°lculo por dentro';
                        } else {
                            resultado.difal = (baseCalculo * diferencial / 100) / divisor;
                        }
                        break;
                        
                    case 'COM_FCP':
                        resultado.difal = baseCalculo * (resultado.aliqInterna - resultado.aliqInterestadual) / 100;
                        break;
                        
                    case 'IMPORTADO':
                        resultado.difal = baseCalculo * (resultado.aliqInterna - 4) / 100;
                        break;
                        
                    case 'SUBSTITUICAO_TRIBUTARIA':
                        resultado.difal = baseCalculo * (resultado.aliqInterna - resultado.aliqInterestadual) / 100;
                        resultado.observacao = 'C√°lculo ST varia por estado - verificar legisla√ß√£o espec√≠fica';
                        break;
                        
                    case 'SIMPLES_NACIONAL':
                        resultado.difal = baseCalculo * (resultado.aliqInterna - resultado.aliqInterestadual) / 100;
                        resultado.observacao = 'Verificar necessidade de recolhimento separado do DAS';
                        break;
                        
                    case 'BENEFICIO_FISCAL':
                        const baseReduzida = baseCalculo * 0.7; // Exemplo: 30% de redu√ß√£o
                        resultado.difal = baseReduzida * (resultado.aliqInterna - resultado.aliqInterestadual) / 100;
                        resultado.baseCalculoOriginal = baseCalculo;
                        resultado.baseCalculoReduzida = baseReduzida;
                        break;
                        
                    default:
                        resultado.difal = baseCalculo * (resultado.aliqInterna - resultado.aliqInterestadual) / 100;
                }

                // Calcular FCP se aplic√°vel
                resultado.fcp = baseCalculo * resultado.percFCP / 100;
                resultado.total = resultado.difal + resultado.fcp;

                // Gerar detalhes do c√°lculo
                resultado.detalhes = gerarDetalhesCalculo(resultado, tipoCalculo);

            } catch (error) {
                resultado.erro = error.message;
                resultado.difal = 0;
                resultado.fcp = 0;
                resultado.total = 0;
            }

            return resultado;
        }

        function gerarDetalhesCalculo(resultado, tipoCalculo) {
            const detalhes = [
                { descricao: 'Base de C√°lculo', valor: resultado.baseCalculo, formula: 'Valor da opera√ß√£o' },
                { descricao: 'Al√≠quota Interestadual', valor: resultado.aliqInterestadual, formula: `${resultado.aliqInterestadual}%` },
                { descricao: 'Al√≠quota Interna Destino', valor: resultado.aliqInterna, formula: `${resultado.aliqInterna}%` }
            ];

            // Adicionar detalhes espec√≠ficos por tipo
            switch (tipoCalculo.codigo) {
                case 'POR_DENTRO':
                    detalhes.push(
                        { descricao: 'Tipo C√°lculo', valor: 'Por Dentro', formula: 'ICMS incluso no pre√ßo' },
                        { descricao: 'F√≥rmula Aplicada', valor: tipoCalculo.formula, formula: '' }
                    );
                    break;
                    
                case 'IMPORTADO':
                    detalhes.push(
                        { descricao: 'Tipo C√°lculo', valor: 'Produto Importado', formula: 'Al√≠quota interestadual 4%' },
                        { descricao: 'Regulamenta√ß√£o', valor: 'Resolu√ß√£o Senado 13/2012', formula: '' }
                    );
                    break;
                    
                case 'BENEFICIO_FISCAL':
                    detalhes.push(
                        { descricao: 'Base Original', valor: resultado.baseCalculoOriginal, formula: 'Antes do benef√≠cio' },
                        { descricao: 'Base com Redu√ß√£o', valor: resultado.baseCalculoReduzida, formula: '70% da base original' },
                        { descricao: 'Tipo C√°lculo', valor: 'Com Benef√≠cio Fiscal', formula: 'Redu√ß√£o de base' }
                    );
                    break;
                    
                default:
                    detalhes.push(
                        { descricao: 'Tipo C√°lculo', valor: tipoCalculo.nome, formula: tipoCalculo.formula }
                    );
            }

            detalhes.push(
                { descricao: 'Diferencial de Al√≠quota', valor: (resultado.aliqInterna - resultado.aliqInterestadual).toFixed(2), formula: `${resultado.aliqInterna}% - ${resultado.aliqInterestadual}%` },
                { descricao: 'Valor DIFAL', valor: resultado.difal, formula: `C√°lculo ${tipoCalculo.nome}` },
                { descricao: 'Fundo Combate √† Pobreza', valor: resultado.percFCP, formula: `${resultado.percFCP}%` },
                { descricao: 'Valor FCP', valor: resultado.fcp, formula: `R$ ${resultado.baseCalculo.toFixed(2)} √ó ${resultado.percFCP}%` }
            );

            if (resultado.observacao) {
                detalhes.push({ descricao: 'Observa√ß√£o', valor: resultado.observacao, formula: '' });
            }

            return detalhes;
        }

        // FUN√á√ÉO QUE ESTAVA FALTANDO: processarXMLReal
        function processarXMLReal(xmlContent, fileName) {
            try {
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(xmlContent, "text/xml");
                
                if (xmlDoc.getElementsByTagName("parsererror").length > 0) {
                    throw new Error("XML inv√°lido ou mal formado");
                }

                // Extrair dados principais da NFe
                const infNFe = xmlDoc.getElementsByTagName("infNFe")[0];

                // Extrair UF de origem e destino
                const emit = xmlDoc.getElementsByTagName("emit")[0];
                const dest = xmlDoc.getElementsByTagName("dest")[0];
                
                const emitEnder = emit.getElementsByTagName("enderEmit")[0] || emit;
                const destEnder = dest.getElementsByTagName("enderDest")[0] || dest;
                
                const emitUF = emitEnder.getElementsByTagName("UF")[0]?.textContent;
                const destUF = destEnder.getElementsByTagName("UF")[0]?.textContent;

                if (!emitUF || !destUF) {
                    throw new Error("UF do emitente ou destinat√°rio n√£o encontrado");
                }

                // Extrair valores
                const total = xmlDoc.getElementsByTagName("total")[0];
                const ICMSTot = total ? total.getElementsByTagName("ICMSTot")[0] : null;
                
                const vNF = ICMSTot ? ICMSTot.getElementsByTagName("vNF")[0]?.textContent : "0";
                const vProd = ICMSTot ? ICMSTot.getElementsByTagName("vProd")[0]?.textContent : "0";
                const vFrete = ICMSTot ? ICMSTot.getElementsByTagName("vFrete")[0]?.textContent || "0" : "0";
                const vSeg = ICMSTot ? ICMSTot.getElementsByTagName("vSeg")[0]?.textContent || "0" : "0";
                const vDesc = ICMSTot ? ICMSTot.getElementsByTagName("vDesc")[0]?.textContent || "0" : "0";
                const vOutro = ICMSTot ? ICMSTot.getElementsByTagName("vOutro")[0]?.textContent || "0" : "0";

                // Determinar tipo de destinat√°rio
                const indIEDest = dest.getElementsByTagName("indIEDest")[0]?.textContent;
                let tipoDestinatario = 'consumidor';
                
                if (indIEDest === '1') {
                    tipoDestinatario = 'contribuinte';
                } else if (indIEDest === '2' || indIEDest === '9') {
                    tipoDestinatario = 'isento';
                }

                // Calcular base de c√°lculo corretamente
                const baseCalculo = sanitizarValor(vProd) + sanitizarValor(vFrete) + sanitizarValor(vSeg) - sanitizarValor(vDesc) + sanitizarValor(vOutro);
                const valorTotal = sanitizarValor(vNF) || baseCalculo;

                // IDENTIFICAR TIPO DE C√ÅLCULO
                const recomendacaoCalculo = identificarTipoCalculo(
                    xmlDoc, emitUF, destUF, tipoDestinatario, baseCalculo
                );

                const calculo = {
                    id: Date.now() + Math.random(),
                    fileName: fileName,
                    origem: emitUF,
                    destino: destUF,
                    tipoDestinatario: tipoDestinatario,
                    valorOperacao: sanitizarValor(vProd),
                    valorFrete: sanitizarValor(vFrete),
                    valorSeguro: sanitizarValor(vSeg),
                    valorDesconto: sanitizarValor(vDesc),
                    valorOutros: sanitizarValor(vOutro),
                    baseCalculo: baseCalculo,
                    valorTotal: valorTotal,
                    status: 'Processado',
                    timestamp: new Date().toLocaleString(),
                    recomendacaoCalculo: recomendacaoCalculo
                };

                // Verificar aplicabilidade primeiro
                const aplicavel = verificarAplicabilidade(emitUF, destUF, tipoDestinatario);
                
                if (!aplicavel.aplicavel) {
                    calculo.aplicavel = false;
                    calculo.motivo = aplicavel.motivo;
                    calculo.difal = 0;
                    calculo.fcp = 0;
                    calculo.total = 0;
                } else {
                    // CALCULAR COM O TIPO RECOMENDADO
                    const resultado = calcularDIFALMultiTipo(
                        calculo.origem,
                        calculo.destino,
                        calculo.tipoDestinatario,
                        calculo.baseCalculo,
                        recomendacaoCalculo.tipoPrincipal,
                        xmlDoc
                    );

                    Object.assign(calculo, resultado);
                    calculo.aplicavel = true;
                }

                todosCalculos.push(calculo);
                atualizarTabela();
                
            } catch (error) {
                console.error('Erro ao processar XML:', error);
                
                // Adicionar c√°lculo com erro para visualiza√ß√£o
                const calculoErro = {
                    id: Date.now() + Math.random(),
                    fileName: fileName,
                    origem: 'ERRO',
                    destino: 'ERRO',
                    tipoDestinatario: 'erro',
                    baseCalculo: 0,
                    valorTotal: 0,
                    status: 'Erro',
                    timestamp: new Date().toLocaleString(),
                    aplicavel: false,
                    motivo: error.message,
                    difal: 0,
                    fcp: 0,
                    total: 0
                };
                
                todosCalculos.push(calculoErro);
                atualizarTabela();
            }
        }

        // FUN√á√ÉO QUE ESTAVA FALTANDO: verificarAplicabilidade
        function verificarAplicabilidade(origem, destino, tipoDestinatario) {
            if (origem === destino) {
                return { aplicavel: false, motivo: 'Opera√ß√£o interna (mesmo estado)' };
            }
            
            if (tipoDestinatario === 'isento') {
                return { aplicavel: false, motivo: 'Opera√ß√£o imune ou isenta' };
            }
            
            // Verificar se as al√≠quotas s√£o iguais (n√£o h√° diferencial)
            const aliqInterestadual = calcularAliquotaInterestadual(origem, destino);
            const aliqInterna = aliquotasInternas[destino]?.valor;
            
            if (aliqInterestadual === aliqInterna) {
                return { aplicavel: false, motivo: 'Al√≠quotas iguais - sem diferencial' };
            }
            
            return { aplicavel: true, motivo: '' };
        }

        // FUN√á√ÉO QUE ESTAVA FALTANDO: sanitizarValor
        function sanitizarValor(valor) {
            if (typeof valor === 'string') {
                valor = valor.replace(/[^\d,.-]/g, '');
                valor = valor.replace(',', '.');
            }
            
            const numero = parseFloat(valor);
            if (isNaN(numero) || numero < 0) {
                return 0;
            }
            
            return numero;
        }

        // FUN√á√ÉO QUE ESTAVA FALTANDO: formatarMoeda
        function formatarMoeda(input) {
            let valor = input.value.replace(/\D/g, '');
            valor = (valor / 100).toFixed(2) + '';
            valor = valor.replace(".", ",");
            valor = valor.replace(/(\d)(\d{3})(\d{3}),/g, "$1.$2.$3,");
            valor = valor.replace(/(\d)(\d{3}),/g, "$1.$2,");
            input.value = valor;
        }

        // FUN√á√ÉO QUE ESTAVA FALTANDO: filtrarTabela
        function filtrarTabela() {
            const filtroTexto = document.getElementById('filtroTabela').value.toLowerCase();
            const filtroStatus = document.getElementById('filtroStatus').value;
            const filtroTipoCalculo = document.getElementById('filtroTipoCalculo').value;
            
            const linhas = document.querySelectorAll('#tabelaResultados tr');
            
            linhas.forEach(linha => {
                const textoLinha = linha.textContent.toLowerCase();
                const statusLinha = linha.querySelector('.status-applicable, .status-not-applicable, .status-exempt')?.textContent || '';
                const tipoCalculoLinha = linha.cells[8]?.textContent || '';
                
                const correspondeTexto = textoLinha.includes(filtroTexto);
                const correspondeStatus = !filtroStatus || statusLinha.includes(filtroStatus);
                const correspondeTipo = !filtroTipoCalculo || tipoCalculoLinha.includes(filtroTipoCalculo);
                
                linha.style.display = (correspondeTexto && correspondeStatus && correspondeTipo) ? '' : 'none';
            });
        }

        // FUN√á√ÉO QUE ESTAVA FALTANDO: atualizarTabela
        function atualizarTabela() {
            const tbody = document.getElementById('tabelaResultados');
            const detalhesContainer = document.getElementById('detalhesContainer');
            
            tbody.innerHTML = '';
            detalhesContainer.innerHTML = '';
            
            if (todosCalculos.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="11" style="text-align: center; padding: 20px;">
                            Nenhum resultado dispon√≠vel
                        </td>
                    </tr>
                `;
                return;
            }
            
            todosCalculos.forEach((calculo, index) => {
                const tr = document.createElement('tr');
                
                const statusClass = calculo.status === 'Erro' ? 'status-not-applicable' : 
                    calculo.aplicavel ? 
                    (calculo.difal > 0 ? 'status-applicable' : 'status-exempt') : 
                    'status-not-applicable';
                
                const statusText = calculo.status === 'Erro' ? 'Erro' :
                    calculo.aplicavel ? 
                    (calculo.difal > 0 ? 'Aplic√°vel' : 'Isento') : 
                    'N√£o Aplic√°vel';

                const tipoCalculoHTML = calculo.recomendacaoCalculo ? 
                    `<span class="tipo-calculo-badge ${calculo.recomendacaoCalculo.tipoPrincipal.cor}" 
                          title="${calculo.recomendacaoCalculo.tipoPrincipal.descricao}">
                        ${calculo.recomendacaoCalculo.tipoPrincipal.nome.split(' ')[0]}
                    </span>` : 
                    '<span>N/A</span>';

                const statusPagamento = calculo.statusPagamento || 'Pendente';
                const statusPagamentoClass = statusPagamento === 'Pago' ? 'status-pago' : 
                                           statusPagamento === 'Agendado' ? 'status-agendado' : 
                                           'status-pendente';
                
                tr.innerHTML = `
                    <td title="${calculo.fileName}">${calculo.fileName.length > 20 ? calculo.fileName.substring(0, 20) + '...' : calculo.fileName}</td>
                    <td>${calculo.origem}</td>
                    <td>${calculo.destino}</td>
                    <td>R$ ${calculo.valorTotal?.toFixed(2) || calculo.baseCalculo?.toFixed(2) || '0.00'}</td>
                    <td>${calculo.aliqInterestadual?.toFixed(2) || '0.00'}%</td>
                    <td>${calculo.aliqInterna?.toFixed(2) || '0.00'}%</td>
                    <td>R$ ${calculo.difal?.toFixed(2) || '0.00'}</td>
                    <td>R$ ${calculo.fcp?.toFixed(2) || '0.00'}</td>
                    <td>${tipoCalculoHTML}</td>
                    <td><span class="${statusPagamentoClass}">${statusPagamento}</span></td>
                    <td>
                        <button onclick="mostrarDetalhes(${JSON.stringify(calculo).replace(/"/g, '&quot;')})" 
                                class="btn btn-info" style="padding: 2px 8px; font-size: 11px;">
                            Detalhes
                        </button>
                    </td>
                `;
                
                if (calculo.status !== 'Erro') {
                    tr.addEventListener('click', () => mostrarDetalhes(calculo));
                    tr.style.cursor = 'pointer';
                }
                
                tbody.appendChild(tr);
            });

            filtrarTabela();
        }

        // FUN√á√ÉO QUE ESTAVA FALTANDO: atualizarResumo
        function atualizarResumo() {
            const resumoDiv = document.getElementById('resumoCalculos');
            
            const totalNFes = todosCalculos.length;
            const totalProcessados = todosCalculos.filter(c => c.status !== 'Erro').length;
            const totalErros = todosCalculos.filter(c => c.status === 'Erro').length;
            const totalAplicavel = todosCalculos.filter(c => c.aplicavel && c.difal > 0).length;
            const totalIsento = todosCalculos.filter(c => c.aplicavel && c.difal === 0).length;
            const totalNaoAplicavel = todosCalculos.filter(c => !c.aplicavel && c.status !== 'Erro').length;
            const totalValor = todosCalculos.reduce((sum, c) => sum + (c.difal || 0), 0);
            const totalFCP = todosCalculos.reduce((sum, c) => sum + (c.fcp || 0), 0);
            const totalBaseCalculo = todosCalculos.reduce((sum, c) => sum + (c.baseCalculo || 0), 0);
            
            // Estat√≠sticas por tipo de c√°lculo
            const tiposCalculoCount = {};
            Object.values(TIPOS_CALCULO).forEach(tipo => {
                tiposCalculoCount[tipo.codigo] = todosCalculos.filter(c => 
                    c.recomendacaoCalculo && c.recomendacaoCalculo.tipoPrincipal.codigo === tipo.codigo
                ).length;
            });
            
            resumoDiv.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; font-size: 14px;">
                    <div><strong>Total NF-es:</strong> ${totalNFes}</div>
                    <div><strong>Processados:</strong> ${totalProcessados}</div>
                    <div><strong>Erros:</strong> ${totalErros}</div>
                    <div><strong>DIFAL Aplic√°vel:</strong> ${totalAplicavel}</div>
                    <div><strong>Isentos:</strong> ${totalIsento}</div>
                    <div><strong>N√£o Aplic√°vel:</strong> ${totalNaoAplicavel}</div>
                    <div><strong>Total Base C√°lculo:</strong> R$ ${totalBaseCalculo.toFixed(2)}</div>
                    <div><strong>Total DIFAL:</strong> R$ ${totalValor.toFixed(2)}</div>
                    <div><strong>Total FCP:</strong> R$ ${totalFCP.toFixed(2)}</div>
                    <div><strong>Total Geral:</strong> R$ ${(totalValor + totalFCP).toFixed(2)}</div>
                </div>
                <div style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                    <strong>Tipos de C√°lculo:</strong>
                    ${Object.entries(tiposCalculoCount).map(([tipo, count]) => 
                        count > 0 ? `<span class="tipo-calculo-badge ${TIPOS_CALCULO[tipo].cor}">${TIPOS_CALCULO[tipo].nome.split(' ')[0]}: ${count}</span>` : ''
                    ).join(' ')}
                </div>
            `;
        }

        // FUN√á√ÉO QUE ESTAVA FALTANDO: processarTodosXMLs
        function processarTodosXMLs() {
            if (todosCalculos.length === 0) {
                alert('N√£o h√° XMLs para processar. Importe alguns XMLs primeiro.');
                return;
            }
            
            mostrarProgresso(0, todosCalculos.length);
            
            setTimeout(() => {
                let processados = 0;
                todosCalculos.forEach((calculo, index) => {
                    if (calculo.status !== 'Erro' && calculo.aplicavel && calculo.recomendacaoCalculo) {
                        const resultado = calcularDIFALMultiTipo(
                            calculo.origem,
                            calculo.destino,
                            calculo.tipoDestinatario,
                            calculo.baseCalculo,
                            calculo.recomendacaoCalculo.tipoPrincipal
                        );
                        Object.assign(calculo, resultado);
                    }
                    processados++;
                    
                    if (processados % 5 === 0) {
                        mostrarProgresso(processados, todosCalculos.length);
                    }
                });
                
                ocultarProgresso();
                atualizarTabela();
                atualizarResumo();
                salvarHistorico();
                
                alert(`Processamento conclu√≠do! ${todosCalculos.length} NF-es processadas.`);
            }, 100);
        }

        // FUN√á√ÉO QUE ESTAVA FALTANDO: exportarExcel
        function exportarExcel() {
            if (todosCalculos.length === 0) {
                alert('N√£o h√° dados para exportar.');
                return;
            }
            
            const dadosExcel = todosCalculos.map(calculo => ({
                'Arquivo': calculo.fileName,
                'Data Processamento': calculo.timestamp,
                'UF Origem': calculo.origem,
                'UF Destino': calculo.destino,
                'Tipo Destinat√°rio': calculo.tipoDestinatario,
                'Tipo C√°lculo': calculo.recomendacaoCalculo ? calculo.recomendacaoCalculo.tipoPrincipal.nome : 'N/A',
                'Base C√°lculo (R$)': calculo.baseCalculo?.toFixed(2) || '0.00',
                'Valor Total NF (R$)': calculo.valorTotal?.toFixed(2) || '0.00',
                'Al√≠quota Interestadual (%)': calculo.aliqInterestadual?.toFixed(2) || '0.00',
                'Al√≠quota Interna (%)': calculo.aliqInterna?.toFixed(2) || '0.00',
                'Diferencial Al√≠quota (%)': calculo.aliqInterna && calculo.aliqInterestadual ? 
                    (calculo.aliqInterna - calculo.aliqInterestadual).toFixed(2) : '0.00',
                'FCP (%)': calculo.percFCP || '0.00',
                'Valor DIFAL (R$)': calculo.difal?.toFixed(2) || '0.00',
                'Valor FCP (R$)': calculo.fcp?.toFixed(2) || '0.00',
                'Total a Recolher (R$)': calculo.total?.toFixed(2) || '0.00',
                'Status': calculo.status === 'Erro' ? 'Erro' : 
                         calculo.aplicavel ? (calculo.difal > 0 ? 'Aplic√°vel' : 'Isento') : 'N√£o Aplic√°vel',
                'Motivo': calculo.motivo || calculo.status === 'Erro' ? 'Erro no processamento' : '',
                'Confian√ßa Recomenda√ß√£o (%)': calculo.recomendacaoCalculo ? calculo.recomendacaoCalculo.confianca : 'N/A',
                'Status Pagamento': calculo.statusPagamento || 'Pendente'
            }));
            
            const worksheet = XLSX.utils.json_to_sheet(dadosExcel);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, 'C√°lculos DIFAL');
            
            const colWidths = [];
            Object.keys(dadosExcel[0]).forEach(key => {
                colWidths.push({ wch: Math.max(key.length, 12) });
            });
            worksheet['!cols'] = colWidths;
            
            XLSX.writeFile(workbook, `calculos_difal_${new Date().toISOString().split('T')[0]}.xlsx`);
        }

        // FUN√á√ÉO QUE ESTAVA FALTANDO: fazerBackup
        function fazerBackup() {
            if (todosCalculos.length === 0) {
                alert('N√£o h√° dados para backup.');
                return;
            }

            const backup = {
                calculos: todosCalculos,
                aliquotasInternas: aliquotasInternas,
                fundoPobreza: fundoPobreza,
                timestamp: new Date().toISOString(),
                versao: '4.0',
                totalRegistros: todosCalculos.length
            };
            
            const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `backup_difal_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            alert(`Backup realizado com sucesso! ${todosCalculos.length} registros salvos.`);
        }

        // FUN√á√ÉO QUE ESTAVA FALTANDO: limparTudo
        function limparTudo() {
            if (confirm('Tem certeza que deseja limpar todos os c√°lculos?')) {
                todosCalculos = [];
                cacheCalculos.clear();
                atualizarTabela();
                atualizarResumo();
                document.getElementById('resultadoManual').innerHTML = '';
                localStorage.removeItem('historicoDIFAL');
            }
        }

        // FUN√á√ÉO QUE ESTAVA FALTANDO: calcularManual
        function calcularManual() {
            const ufOrigem = document.getElementById('ufOrigem').value;
            const ufDestino = document.getElementById('ufDestino').value;
            const valorBase = sanitizarValor(document.getElementById('valorBase').value);
            const tipoCalculoCodigo = document.getElementById('tipoCalculoManual').value;

            if (!ufOrigem || !ufDestino || !valorBase || valorBase <= 0) {
                alert('Por favor, preencha todos os campos com valores v√°lidos.');
                return;
            }

            const tipoCalculo = TIPOS_CALCULO[tipoCalculoCodigo];
            const resultado = calcularDIFALMultiTipo(ufOrigem, ufDestino, 'consumidor', valorBase, tipoCalculo);
            exibirResultadoManual(resultado);
        }

        // FUN√á√ÉO QUE ESTAVA FALTANDO: exibirResultadoManual
        function exibirResultadoManual(resultado) {
            const resultadoDiv = document.getElementById('resultadoManual');
            
            let html = '<div style="background: #d4edda; padding: 15px; border-radius: 8px; border: 2px solid #28a745;">';
            
            if (!resultado.aplicavel) {
                html = '<div style="background: #fff3cd; padding: 15px; border-radius: 8px; border: 2px solid #ffc107;">';
                html += `<h4>‚ö†Ô∏è DIFAL N√£o Aplic√°vel</h4>`;
                html += `<p><strong>Motivo:</strong> ${resultado.motivo}</p>`;
            } else {
                html += `<h4>‚úÖ Resultado do C√°lculo DIFAL</h4>`;
                html += `<p><strong>Origem:</strong> ${resultado.origem} ‚Üí <strong>Destino:</strong> ${resultado.destino}</p>`;
                html += `<p><strong>Tipo de C√°lculo:</strong> <span class="tipo-calculo-badge ${resultado.tipoCalculo.cor}">${resultado.tipoCalculo.nome}</span></p>`;
                
                resultado.detalhes.forEach(detalhe => {
                    html += `
                        <div class="detalhes-item">
                            <span>${detalhe.descricao}:</span>
                            <span>
                                ${typeof detalhe.valor === 'number' ? 
                                  (detalhe.descricao.includes('Al√≠quota') || detalhe.descricao.includes('Fundo') ? 
                                   `${detalhe.valor}%` : `R$ ${detalhe.valor.toFixed(2)}`) : 
                                  detalhe.valor}
                                ${detalhe.formula ? `<br><small style="color: #666;">${detalhe.formula}</small>` : ''}
                            </span>
                        </div>
                    `;
                });
                
                html += `
                    <div class="detalhes-total">
                        <span>TOTAL A RECOLHER (DIFAL + FCP):</span>
                        <span>R$ ${resultado.total.toFixed(2)}</span>
                    </div>
                    <div style="margin-top: 10px; padding: 10px; background: #c3e6cb; border-radius: 5px;">
                        <small>üí° Recolhimento via GNRE para o estado de ${resultado.destino}</small>
                    </div>
                `;
            }
            
            html += '</div>';
            resultadoDiv.innerHTML = html;
        }

        // FUN√á√ïES DE ADMINISTRA√á√ÉO DE AL√çQUOTAS QUE ESTAVAM FALTANDO
        function renderizarTabelaAdmin() {
            const tbody = document.getElementById('tabelaAdmin');
            tbody.innerHTML = '';

            const estados = Object.keys(aliquotasInternas).sort();
            
            estados.forEach(estado => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><strong>${estado}</strong></td>
                    <td>
                        <input type="number" 
                               value="${aliquotasInternas[estado]?.valor || 0}" 
                               step="0.1" 
                               min="0" 
                               max="100"
                               onchange="atualizarAliquotaInterna('${estado}', this.value)"
                               style="width: 80px; padding: 4px; border: 1px solid #ddd; border-radius: 3px; text-align: center;">
                        %
                    </td>
                    <td>
                        <input type="number" 
                               value="${fundoPobreza[estado] || 0}" 
                               step="0.1" 
                               min="0" 
                               max="100"
                               onchange="atualizarFCP('${estado}', this.value)"
                               style="width: 80px; padding: 4px; border: 1px solid #ddd; border-radius: 3px; text-align: center;">
                        %
                    </td>
                    <td>${aliquotasInternas[estado]?.vigencia || '2024-01-01'}</td>
                    <td>${aliquotasInternas[estado]?.fonte || 'Decreto Estadual'}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        function atualizarAliquotaInterna(estado, valor) {
            if (!aliquotasInternas[estado]) {
                aliquotasInternas[estado] = { valor: 0, vigencia: '2024-01-01', fonte: 'Decreto Estadual' };
            }
            aliquotasInternas[estado].valor = parseFloat(valor) || 0;
            cacheCalculos.clear(); // Limpar cache para recalcular com novas al√≠quotas
        }

        function atualizarFCP(estado, valor) {
            fundoPobreza[estado] = parseFloat(valor) || 0;
            cacheCalculos.clear(); // Limpar cache para recalcular com novas al√≠quotas
        }

        function filtrarTabelaAdmin() {
            const filtro = document.getElementById('filtroAdmin').value.toUpperCase();
            const linhas = document.querySelectorAll('#tabelaAdmin tr');
            
            linhas.forEach(linha => {
                const estado = linha.cells[0].textContent;
                linha.style.display = estado.includes(filtro) ? '' : 'none';
            });
        }

        function carregarAliquotasPadrao() {
            if (confirm('Isso ir√° restaurar as al√≠quotas padr√£o. Deseja continuar?')) {
                aliquotasInternas = {
                    'AC': { valor: 19, vigencia: '2024-01-01', fonte: 'Decreto Estadual' },
                    'AL': { valor: 20, vigencia: '2024-01-01', fonte: 'Decreto Estadual' },
                    'AP': { valor: 18, vigencia: '2024-01-01', fonte: 'Decreto Estadual' },
                    'AM': { valor: 20, vigencia: '2024-01-01', fonte: 'Decreto Estadual' },
                    'BA': { valor: 20.5, vigencia: '2024-01-01', fonte: 'Decreto Estadual' },
                    'CE': { valor: 20, vigencia: '2024-01-01', fonte: 'Decreto Estadual' },
                    'DF': { valor: 20, vigencia: '2024-01-01', fonte: 'Decreto Estadual' },
                    'ES': { valor: 17, vigencia: '2024-01-01', fonte: 'Decreto Estadual' },
                    'GO': { valor: 19, vigencia: '2024-01-01', fonte: 'Decreto Estadual' },
                    'MA': { valor: 23, vigencia: '2024-01-01', fonte: 'Decreto Estadual' },
                    'MT': { valor: 17, vigencia: '2024-01-01', fonte: 'Decreto Estadual' },
                    'MS': { valor: 17, vigencia: '2024-01-01', fonte: 'Decreto Estadual' },
                    'MG': { valor: 18, vigencia: '2024-01-01', fonte: 'Decreto Estadual' },
                    'PA': { valor: 19, vigencia: '2024-01-01', fonte: 'Decreto Estadual' },
                    'PB': { valor: 20, vigencia: '2024-01-01', fonte: 'Decreto Estadual' },
                    'PR': { valor: 19.5, vigencia: '2024-01-01', fonte: 'Decreto Estadual' },
                    'PE': { valor: 20.5, vigencia: '2024-01-01', fonte: 'Decreto Estadual' },
                    'PI': { valor: 22.5, vigencia: '2024-01-01', fonte: 'Decreto Estadual' },
                    'RJ': { valor: 22, vigencia: '2024-01-01', fonte: 'Decreto Estadual' },
                    'RN': { valor: 20, vigencia: '2024-01-01', fonte: 'Decreto Estadual' },
                    'RS': { valor: 17, vigencia: '2024-01-01', fonte: 'Decreto Estadual' },
                    'RO': { valor: 19.5, vigencia: '2024-01-01', fonte: 'Decreto Estadual' },
                    'RR': { valor: 20, vigencia: '2024-01-01', fonte: 'Decreto Estadual' },
                    'SC': { valor: 17, vigencia: '2024-01-01', fonte: 'Decreto Estadual' },
                    'SP': { valor: 18, vigencia: '2024-01-01', fonte: 'Decreto Estadual' },
                    'SE': { valor: 20, vigencia: '2024-01-01', fonte: 'Decreto Estadual' },
                    'TO': { valor: 20, vigencia: '2024-01-01', fonte: 'Decreto Estadual' }
                };
                
                fundoPobreza = {
                    'AC': 0, 'AL': 0, 'AP': 0, 'AM': 0, 'BA': 0, 'CE': 0, 'DF': 0, 'ES': 0, 
                    'GO': 0, 'MA': 0, 'MT': 0, 'MS': 0, 'MG': 0, 'PA': 0, 'PB': 0, 'PR': 0, 
                    'PE': 0, 'PI': 0, 'RJ': 0, 'RN': 0, 'RS': 0, 'RO': 0, 'RR': 0, 'SC': 0, 
                    'SP': 0, 'SE': 0, 'TO': 0
                };
                
                renderizarTabelaAdmin();
                cacheCalculos.clear();
                alert('Al√≠quotas padr√£o restauradas com sucesso!');
            }
        }

        function exportarAliquotas() {
            const data = {
                aliquotasInternas: aliquotasInternas,
                fundoPobreza: fundoPobreza,
                timestamp: new Date().toISOString(),
                versao: '1.0'
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `aliquotas_difal_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function importarAliquotas() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = function(e) {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = JSON.parse(e.target.result);
                        if (data.aliquotasInternas && data.fundoPobreza) {
                            aliquotasInternas = data.aliquotasInternas;
                            fundoPobreza = data.fundoPobreza;
                            renderizarTabelaAdmin();
                            cacheCalculos.clear();
                            alert('Al√≠quotas importadas com sucesso!');
                        } else {
                            alert('Arquivo inv√°lido. Estrutura de dados n√£o reconhecida.');
                        }
                    } catch (error) {
                        alert('Erro ao importar arquivo: ' + error.message);
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        // NOVAS FUN√á√ïES DE GEST√ÉO DE PAGAMENTOS
        function atualizarResumoPagamentos() {
            const resumoDiv = document.getElementById('resumoPagamentos');
            if (!resumoDiv) return;

            const total = todosCalculos.filter(c => c.aplicavel && c.difal > 0).length;
            const pendentes = todosCalculos.filter(c => c.aplicavel && c.difal > 0 && (!c.statusPagamento || c.statusPagamento === 'Pendente')).length;
            const agendados = todosCalculos.filter(c => c.statusPagamento === 'Agendado').length;
            const pagos = todosCalculos.filter(c => c.statusPagamento === 'Pago').length;
            const totalValor = todosCalculos.filter(c => c.aplicavel && c.difal > 0).reduce((sum, c) => sum + (c.total || 0), 0);
            const valorPendente = todosCalculos.filter(c => c.aplicavel && c.difal > 0 && (!c.statusPagamento || c.statusPagamento === 'Pendente')).reduce((sum, c) => sum + (c.total || 0), 0);

            resumoDiv.innerHTML = `
                <div style="text-align: center; padding: 10px; background: #17a2b8; color: white; border-radius: 5px;">
                    <div style="font-size: 12px;">Total NF-es</div>
                    <div style="font-size: 18px; font-weight: bold;">${total}</div>
                </div>
                <div style="text-align: center; padding: 10px; background: #ffc107; color: black; border-radius: 5px;">
                    <div style="font-size: 12px;">Pendentes</div>
                    <div style="font-size: 18px; font-weight: bold;">${pendentes}</div>
                </div>
                <div style="text-align: center; padding: 10px; background: #6f42c1; color: white; border-radius: 5px;">
                    <div style="font-size: 12px;">Agendados</div>
                    <div style="font-size: 18px; font-weight: bold;">${agendados}</div>
                </div>
                <div style="text-align: center; padding: 10px; background: #28a745; color: white; border-radius: 5px;">
                    <div style="font-size: 12px;">Pagas</div>
                    <div style="font-size: 18px; font-weight: bold;">${pagos}</div>
                </div>
                <div style="text-align: center; padding: 10px; background: #dc3545; color: white; border-radius: 5px;">
                    <div style="font-size: 12px;">Valor Pendente</div>
                    <div style="font-size: 18px; font-weight: bold;">R$ ${valorPendente.toFixed(2)}</div>
                </div>
                <div style="text-align: center; padding: 10px; background: #343a40; color: white; border-radius: 5px;">
                    <div style="font-size: 12px;">Valor Total</div>
                    <div style="font-size: 18px; font-weight: bold;">R$ ${totalValor.toFixed(2)}</div>
                </div>
            `;
        }

        function renderizarTabelaGestao() {
            const tbody = document.getElementById('tabelaGestao');
            if (!tbody) return;

            const calculosComDIFAL = todosCalculos.filter(c => c.aplicavel && c.difal > 0);
            
            if (calculosComDIFAL.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="10" style="text-align: center; padding: 20px;">
                            Nenhum c√°lculo com DIFAL aplic√°vel
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = '';
            calculosComDIFAL.forEach(calculo => {
                const tr = document.createElement('tr');
                const statusPagamento = calculo.statusPagamento || 'Pendente';
                const mesReferencia = calculo.mesReferencia || new Date().toLocaleDateString('pt-BR');
                const vencimento = calculo.vencimento || 'N√£o definido';

                const statusClass = statusPagamento === 'Pago' ? 'status-pago' : 
                                 statusPagamento === 'Agendado' ? 'status-agendado' : 
                                 'status-pendente';

                tr.innerHTML = `
                    <td><input type="checkbox" class="select-item" value="${calculo.id}"></td>
                    <td title="${calculo.fileName}">${calculo.fileName.length > 20 ? calculo.fileName.substring(0, 20) + '...' : calculo.fileName}</td>
                    <td>${calculo.destino}</td>
                    <td>R$ ${calculo.difal?.toFixed(2) || '0.00'}</td>
                    <td>R$ ${calculo.fcp?.toFixed(2) || '0.00'}</td>
                    <td><strong>R$ ${calculo.total?.toFixed(2) || '0.00'}</strong></td>
                    <td><span class="${statusClass}">${statusPagamento}</span></td>
                    <td>${mesReferencia}</td>
                    <td>${vencimento}</td>
                    <td>
                        <button onclick="alterarStatusPagamento('${calculo.id}', 'Pago')" class="btn btn-success" style="padding: 2px 8px; font-size: 11px;">Pago</button>
                        <button onclick="alterarStatusPagamento('${calculo.id}', 'Agendado')" class="btn btn-warning" style="padding: 2px 8px; font-size: 11px;">Agendar</button>
                        <button onclick="alterarStatusPagamento('${calculo.id}', 'Pendente')" class="btn btn-secondary" style="padding: 2px 8px; font-size: 11px;">Pendente</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function alterarStatusPagamento(calculoId, novoStatus) {
            const calculo = todosCalculos.find(c => c.id === calculoId);
            if (!calculo) return;

            calculo.statusPagamento = novoStatus;
            
            // Definir m√™s de refer√™ncia e vencimento
            const agora = new Date();
            if (novoStatus === 'Agendado') {
                const proximoMes = new Date(agora.getFullYear(), agora.getMonth() + 1, 1);
                calculo.mesReferencia = proximoMes.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
                calculo.vencimento = new Date(agora.getFullYear(), agora.getMonth() + 1, 10).toLocaleDateString('pt-BR');
            } else if (novoStatus === 'Pago') {
                calculo.mesReferencia = agora.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
                calculo.vencimento = 'Pago em ' + agora.toLocaleDateString('pt-BR');
            }

            atualizarResumoPagamentos();
            renderizarTabelaGestao();
            salvarHistorico();
        }

        function agendarParaMesSeguinte() {
            const selecionados = document.querySelectorAll('.select-item:checked');
            if (selecionados.length === 0) {
                alert('Selecione pelo menos uma NF-e para agendar.');
                return;
            }

            selecionados.forEach(checkbox => {
                alterarStatusPagamento(checkbox.value, 'Agendado');
            });

            alert(`${selecionados.length} NF-e(s) agendada(s) para o pr√≥ximo m√™s.`);
        }

        function marcarComoPago() {
            const selecionados = document.querySelectorAll('.select-item:checked');
            if (selecionados.length === 0) {
                alert('Selecione pelo menos uma NF-e para marcar como paga.');
                return;
            }

            selecionados.forEach(checkbox => {
                alterarStatusPagamento(checkbox.value, 'Pago');
            });

            alert(`${selecionados.length} NF-e(s) marcada(s) como pagas.`);
        }

        function selecionarTodos() {
            const selectAll = document.getElementById('selectAll');
            const checkboxes = document.querySelectorAll('.select-item');
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAll.checked;
            });
        }

        function renderizarGraficoPagamentos() {
            const container = document.getElementById('graficoPagamentos');
            if (!container) return;

            // Agrupar por m√™s
            const pagamentosPorMes = {};
            todosCalculos.forEach(calculo => {
                if (calculo.aplicavel && calculo.difal > 0) {
                    const mes = calculo.mesReferencia || 'N√£o definido';
                    if (!pagamentosPorMes[mes]) {
                        pagamentosPorMes[mes] = { total: 0, count: 0 };
                    }
                    pagamentosPorMes[mes].total += calculo.total || 0;
                    pagamentosPorMes[mes].count += 1;
                }
            });

            // Criar gr√°fico simples com HTML
            let html = '<div style="display: flex; align-items: end; height: 150px; gap: 10px; padding: 10px;">';
            Object.entries(pagamentosPorMes).forEach(([mes, data]) => {
                const altura = Math.max(20, (data.total / Math.max(...Object.values(pagamentosPorMes).map(d => d.total))) * 120);
                html += `
                    <div style="display: flex; flex-direction: column; align-items: center;">
                        <div style="width: 30px; background: #3498db; height: ${altura}px; border-radius: 3px;"></div>
                        <div style="font-size: 10px; margin-top: 5px; text-align: center;">${mes.split(' ')[0]}</div>
                        <div style="font-size: 9px; color: #666;">R$ ${data.total.toFixed(0)}</div>
                    </div>
                `;
            });
            html += '</div>';

            container.innerHTML = html;
        }

        // NOVAS FUN√á√ïES PARA MODIFICA√á√ÉO DE TIPO DE C√ÅLCULO
        function alterarTipoCalculo(calculoId, novoTipoCodigo) {
            const calculo = todosCalculos.find(c => c.id === calculoId);
            if (!calculo) return;

            const novoTipo = TIPOS_CALCULO[novoTipoCodigo];
            if (!novoTipo) return;

            // Recalcular com novo tipo
            const resultado = calcularDIFALMultiTipo(
                calculo.origem,
                calculo.destino,
                calculo.tipoDestinatario,
                calculo.baseCalculo,
                novoTipo
            );

            // Atualizar c√°lculo
            Object.assign(calculo, resultado);
            calculo.recomendacaoCalculo.tipoPrincipal = novoTipo;
            calculo.recomendacaoCalculo.motivo = `Tipo alterado manualmente para: ${novoTipo.nome}`;

            atualizarTabela();
            salvarHistorico();
            
            // Mostrar detalhes atualizados
            mostrarDetalhes(calculo);
        }

        function compararTiposCalculo(calculoId) {
            const calculo = todosCalculos.find(c => c.id === calculoId);
            if (!calculo) return;

            const tiposComparacao = Object.values(TIPOS_CALCULO);
            let html = '<div class="comparacao-tipos"><h4>üîç Compara√ß√£o entre Tipos de C√°lculo</h4>';

            tiposComparacao.forEach(tipo => {
                const resultado = calcularDIFALMultiTipo(
                    calculo.origem,
                    calculo.destino,
                    calculo.tipoDestinatario,
                    calculo.baseCalculo,
                    tipo
                );

                html += `
                    <div style="border: 1px solid #ddd; padding: 10px; margin: 5px 0; border-radius: 5px; 
                                ${tipo.codigo === calculo.recomendacaoCalculo.tipoPrincipal.codigo ? 'background: #e3f2fd;' : ''}">
                        <strong class="tipo-calculo-badge ${tipo.cor}">${tipo.nome}</strong>
                        <div style="font-size: 12px; margin-top: 5px;">
                            DIFAL: R$ ${resultado.difal?.toFixed(2) || '0.00'} | 
                            FCP: R$ ${resultado.fcp?.toFixed(2) || '0.00'} | 
                            Total: R$ ${resultado.total?.toFixed(2) || '0.00'}
                        </div>
                        <div style="font-size: 11px; color: #666;">${tipo.descricao}</div>
                        <button onclick="alterarTipoCalculo('${calculoId}', '${tipo.codigo}')" 
                                style="margin-top: 5px; padding: 2px 8px; font-size: 11px;">
                            Usar este tipo
                        </button>
                    </div>
                `;
            });

            html += '</div>';
            
            const detalhesContainer = document.getElementById('detalhesContainer');
            const existingComparison = detalhesContainer.querySelector('.comparacao-tipos');
            if (existingComparison) {
                existingComparison.remove();
            }
            detalhesContainer.insertAdjacentHTML('beforeend', html);
        }

        // FUN√á√ÉO MELHORADA: mostrarDetalhes com op√ß√£o de alterar tipo
        function mostrarDetalhes(calculo) {
            const detalhesContainer = document.getElementById('detalhesContainer');
            
            let html = `
                <div class="xml-info">
                    <h3>Detalhes do C√°lculo - ${calculo.fileName}</h3>
                    <div><strong>Origem:</strong> ${calculo.origem}</div>
                    <div><strong>Destino:</strong> ${calculo.destino}</div>
                    <div><strong>Tipo Destinat√°rio:</strong> ${calculo.tipoDestinatario}</div>
                    <div><strong>Status:</strong> ${calculo.aplicavel ? (calculo.difal > 0 ? 'DIFAL Aplic√°vel' : 'Isento') : 'N√£o Aplic√°vel'}</div>
                    ${calculo.motivo ? `<div><strong>Motivo:</strong> ${calculo.motivo}</div>` : ''}
                    <div><strong>Data/Hora:</strong> ${calculo.timestamp}</div>
                </div>
            `;
            
            // SELE√á√ÉO DE TIPO DE C√ÅLCULO
            html += `
                <div class="selecao-tipo-calculo">
                    <h4>üîÑ Alterar Tipo de C√°lculo</h4>
                    <div style="display: flex; gap: 5px; flex-wrap: wrap; margin: 10px 0;">
                        ${Object.values(TIPOS_CALCULO).map(tipo => `
                            <button onclick="alterarTipoCalculo('${calculo.id}', '${tipo.codigo}')" 
                                    class="tipo-calculo-badge ${tipo.cor} ${tipo.codigo === calculo.recomendacaoCalculo.tipoPrincipal.codigo ? 'active' : ''}"
                                    style="cursor: pointer; border: 2px solid ${tipo.codigo === calculo.recomendacaoCalculo.tipoPrincipal.codigo ? '#000' : 'transparent'}">
                                ${tipo.nome}
                            </button>
                        `).join('')}
                    </div>
                    <button onclick="compararTiposCalculo('${calculo.id}')" class="btn btn-info" style="padding: 5px 10px; font-size: 12px;">
                        üîç Comparar Todos os Tipos
                    </button>
                </div>
            `;
            
            // RECOMENDA√á√ÉO DE TIPO DE C√ÅLCULO
            if (calculo.recomendacaoCalculo) {
                const rec = calculo.recomendacaoCalculo;
                html += `
                    <div class="recomendacao-box">
                        <h4>üéØ Recomenda√ß√£o de Tipo de C√°lculo</h4>
                        <div style="margin: 10px 0;">
                            <span class="tipo-calculo-badge ${rec.tipoPrincipal.cor}">
                                ${rec.tipoPrincipal.nome}
                            </span>
                            <strong> (Confian√ßa: ${rec.confianca}%)</strong>
                        </div>
                        <div><strong>Motivo:</strong> ${rec.motivo}</div>
                        <div style="margin-top: 10px;">
                            <strong>Outros tipos identificados:</strong>
                            ${rec.tiposSecundarios.map(tipo => 
                                `<span class="tipo-calculo-badge ${tipo.cor}" title="${tipo.descricao}">${tipo.nome}</span>`
                            ).join(' ')}
                        </div>
                    </div>
                `;
            }
            
            // DETALHES DO C√ÅLCULO
            if (calculo.aplicavel && calculo.detalhes && calculo.detalhes.length > 0) {
                html += '<div class="resultado" style="display: block; background: #d4edda; padding: 15px; border-radius: 8px; margin-top: 10px;">';
                html += '<h4>Detalhamento do C√°lculo</h4>';
                
                calculo.detalhes.forEach(detalhe => {
                    html += `
                        <div class="detalhes-item">
                            <span>${detalhe.descricao}:</span>
                            <span>
                                ${typeof detalhe.valor === 'number' ? 
                                  (detalhe.descricao.includes('Al√≠quota') || detalhe.descricao.includes('Fundo') ? 
                                   `${detalhe.valor}%` : `R$ ${detalhe.valor.toFixed(2)}`) : 
                                  detalhe.valor}
                                ${detalhe.formula ? `<br><small style="color: #666;">${detalhe.formula}</small>` : ''}
                            </span>
                        </div>
                    `;
                });
                
                if (calculo.erro) {
                    html += `<div style="color: #dc3545; margin-top: 10px;"><strong>Erro:</strong> ${calculo.erro}</div>`;
                }
                
                html += `
                    <div class="detalhes-total">
                        <span>TOTAL A RECOLHER (DIFAL + FCP):</span>
                        <span>R$ ${calculo.total.toFixed(2)}</span>
                    </div>
                `;
                
                html += '</div>';
            }

            // GEST√ÉO DE PAGAMENTO
            if (calculo.aplicavel && calculo.difal > 0) {
                const statusPagamento = calculo.statusPagamento || 'Pendente';
                html += `
                    <div class="gestao-pagamento">
                        <h4>üí∞ Gest√£o de Pagamento</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 10px 0;">
                            <div>
                                <strong>Status:</strong> 
                                <span class="${statusPagamento === 'Pago' ? 'status-pago' : statusPagamento === 'Agendado' ? 'status-agendado' : 'status-pendente'}">
                                    ${statusPagamento}
                                </span>
                            </div>
                            <div><strong>M√™s Refer√™ncia:</strong> ${calculo.mesReferencia || 'N√£o definido'}</div>
                            <div><strong>Vencimento:</strong> ${calculo.vencimento || 'N√£o definido'}</div>
                        </div>
                        <div style="display: flex; gap: 5px;">
                            <button onclick="alterarStatusPagamento('${calculo.id}', 'Pago')" class="btn btn-success" style="padding: 5px 10px;">Marcar como Pago</button>
                            <button onclick="alterarStatusPagamento('${calculo.id}', 'Agendado')" class="btn btn-warning" style="padding: 5px 10px;">Agendar Pr√≥ximo M√™s</button>
                            <button onclick="alterarStatusPagamento('${calculo.id}', 'Pendente')" class="btn btn-secondary" style="padding: 5px 10px;">Voltar para Pendente</button>
                        </div>
                    </div>
                `;
            }
            
            detalhesContainer.innerHTML = html;
        }

        // FUN√á√ÉO: alternarModoEscuro
        function alternarModoEscuro() {
            const body = document.body;
            const container = document.querySelector('.container');
            
            body.classList.toggle('modo-escuro');
            container.classList.toggle('modo-escuro');
            
            configUsuario.modoEscuro = body.classList.contains('modo-escuro');
            salvarConfiguracoes();
        }

        // FUN√á√ÉO: gerarRelatorioPagamentos
        function gerarRelatorioPagamentos() {
            const calculosComDIFAL = todosCalculos.filter(c => c.aplicavel && c.difal > 0);
            
            if (calculosComDIFAL.length === 0) {
                alert('N√£o h√° pagamentos para gerar relat√≥rio.');
                return;
            }

            const dadosRelatorio = calculosComDIFAL.map(calculo => ({
                'NF-e': calculo.fileName,
                'UF Destino': calculo.destino,
                'Valor DIFAL': calculo.difal?.toFixed(2) || '0.00',
                'Valor FCP': calculo.fcp?.toFixed(2) || '0.00',
                'Total': calculo.total?.toFixed(2) || '0.00',
                'Status': calculo.statusPagamento || 'Pendente',
                'M√™s Refer√™ncia': calculo.mesReferencia || 'N√£o definido',
                'Vencimento': calculo.vencimento || 'N√£o definido',
                'Tipo C√°lculo': calculo.recomendacaoCalculo?.tipoPrincipal.nome || 'N/A'
            }));

            const worksheet = XLSX.utils.json_to_sheet(dadosRelatorio);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, 'Relat√≥rio Pagamentos');
            
            XLSX.writeFile(workbook, `relatorio_pagamentos_difal_${new Date().toISOString().split('T')[0]}.xlsx`);
        }

        // FUN√á√ÉO: exportarGNRE
        function exportarGNRE() {
            const calculosPendentes = todosCalculos.filter(c => 
                c.aplicavel && c.difal > 0 && (!c.statusPagamento || c.statusPagamento === 'Pendente')
            );
            
            if (calculosPendentes.length === 0) {
                alert('N√£o h√° pagamentos pendentes para exportar para GNRE.');
                return;
            }

            const dadosGNRE = calculosPendentes.map(calculo => ({
                'UF': calculo.destino,
                'Valor': calculo.total?.toFixed(2) || '0.00',
                'CNPJ Contribuinte': 'A DEFINIR',
                'Per√≠odo': new Date().toLocaleDateString('pt-BR'),
                'Tipo': 'DIFAL',
                'Detalhes': `NF-e: ${calculo.fileName}`
            }));

            const worksheet = XLSX.utils.json_to_sheet(dadosGNRE);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, 'Dados GNRE');
            
            XLSX.writeFile(workbook, `gnre_difal_${new Date().toISOString().split('T')[0]}.xlsx`);
            alert(`Arquivo GNRE gerado com ${calculosPendentes.length} registros.`);
        }

        // FUN√á√ÉO: filtrarTabelaGestao
        function filtrarTabelaGestao() {
            const filtroTexto = document.getElementById('filtroGestao').value.toLowerCase();
            const filtroMes = document.getElementById('filtroMes').value;
            const filtroAno = document.getElementById('filtroAno').value;
            
            const linhas = document.querySelectorAll('#tabelaGestao tr');
            
            linhas.forEach(linha => {
                if (linha.cells.length < 2) return;
                
                const textoLinha = linha.textContent.toLowerCase();
                const mesLinha = linha.cells[7]?.textContent || '';
                const anoLinha = linha.cells[7]?.textContent || '';
                
                const correspondeTexto = textoLinha.includes(filtroTexto);
                const correspondeMes = !filtroMes || mesLinha.includes(filtroMes);
                const correspondeAno = !filtroAno || anoLinha.includes(filtroAno);
                
                linha.style.display = (correspondeTexto && correspondeMes && correspondeAno) ? '' : 'none';
            });
        }

        // FUN√á√ÉO: inicializarTooltips
        function inicializarTooltips() {
            const tooltips = document.querySelectorAll('.tooltip');
            tooltips.forEach(tooltip => {
                tooltip.addEventListener('mouseenter', function() {
                    const tooltipText = this.querySelector('.tooltiptext');
                    if (tooltipText) {
                        tooltipText.style.visibility = 'visible';
                        tooltipText.style.opacity = '1';
                    }
                });
                
                tooltip.addEventListener('mouseleave', function() {
                    const tooltipText = this.querySelector('.tooltiptext');
                    if (tooltipText) {
                        tooltipText.style.visibility = 'hidden';
                        tooltipText.style.opacity = '0';
                    }
                });
            });
        }

    </script>
</body>
</html>
