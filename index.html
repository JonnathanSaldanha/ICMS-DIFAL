<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora DIFAL - Multi Tipos de C√°lculo 2025</title>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary: #3498db;
            --primary-dark: #2980b9;
            --secondary: #2c3e50;
            --success: #27ae60;
            --warning: #f39c12;
            --danger: #e74c3c;
            --info: #17a2b8;
            --light: #f8f9fa;
            --dark: #343a40;
            --border-radius: 10px;
            --box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            overflow: hidden;
        }

        header {
            background: linear-gradient(135deg, var(--secondary) 0%, var(--primary) 100%);
            color: white;
            padding: 25px 20px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" preserveAspectRatio="none"><path d="M0,0 L100,0 L100,100 Z" fill="rgba(255,255,255,0.1)"/></svg>');
            background-size: cover;
        }

        header h1 {
            font-size: 2em;
            margin-bottom: 8px;
            position: relative;
        }

        header p {
            font-size: 1.1em;
            opacity: 0.9;
            position: relative;
        }

        .tabs {
            display: flex;
            background: var(--light);
            border-bottom: 1px solid #dee2e6;
            overflow-x: auto;
        }

        .tab {
            padding: 14px 20px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 14px;
            font-weight: 600;
            color: #6c757d;
            transition: var(--transition);
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .tab.active {
            color: var(--primary);
            border-bottom: 3px solid var(--primary);
            background: white;
        }

        .tab:hover {
            background: #e9ecef;
        }

        .tab-content {
            display: none;
            padding: 25px;
        }

        .tab-content.active {
            display: block;
        }

        .controls {
            display: flex;
            gap: 12px;
            padding: 18px;
            background: var(--light);
            border-bottom: 1px solid #dee2e6;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 16px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-warning {
            background: var(--warning);
            color: white;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-info {
            background: var(--info);
            color: white;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            padding: 25px;
            min-height: 600px;
        }

        .section {
            background: var(--light);
            padding: 20px;
            border-radius: var(--border-radius);
            border: 1px solid #dee2e6;
            overflow-y: auto;
            height: 100%;
        }

        h2 {
            color: var(--secondary);
            margin-bottom: 18px;
            font-size: 1.4em;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        h3 {
            color: var(--secondary);
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .upload-area {
            border: 3px dashed var(--primary);
            border-radius: var(--border-radius);
            padding: 30px;
            text-align: center;
            transition: var(--transition);
            cursor: pointer;
            margin-bottom: 20px;
            background: rgba(52, 152, 219, 0.05);
        }

        .upload-area:hover {
            background: rgba(52, 152, 219, 0.1);
            border-color: var(--primary-dark);
        }

        .upload-area input {
            display: none;
        }

        .upload-placeholder {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        .upload-placeholder span {
            font-size: 18px;
            font-weight: 600;
            color: var(--primary);
        }

        .resumo {
            background: #e3f2fd;
            padding: 15px;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
            border-left: 4px solid var(--primary);
        }

        .resumo-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 10px;
        }

        .resumo-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px;
            background: white;
            border-radius: 6px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .resumo-valor {
            font-size: 18px;
            font-weight: bold;
            color: var(--secondary);
        }

        .resumo-label {
            font-size: 12px;
            color: #6c757d;
            margin-top: 4px;
        }

        .calculadora-section {
            background: white;
            padding: 20px;
            border-radius: var(--border-radius);
            border: 2px solid var(--primary);
            margin-bottom: 20px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: var(--secondary);
            font-size: 14px;
        }

        .form-group select, 
        .form-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            transition: var(--transition);
        }

        .form-group select:focus, 
        .form-group input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
            outline: none;
        }

        .nfs-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .nf-card {
            background: white;
            border-radius: var(--border-radius);
            padding: 15px;
            box-shadow: 0 3px 8px rgba(0,0,0,0.08);
            cursor: pointer;
            transition: var(--transition);
            border-left: 4px solid var(--primary);
            position: relative;
            overflow: hidden;
        }

        .nf-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--primary), var(--primary-dark));
        }

        .nf-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .nf-card.active {
            border-left-color: var(--danger);
            background: #fff8e1;
            box-shadow: 0 4px 15px rgba(231, 76, 60, 0.15);
        }

        .nf-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }

        .nf-numero {
            font-weight: bold;
            color: var(--secondary);
            font-size: 14px;
            flex: 1;
            margin-right: 10px;
            line-height: 1.3;
        }

        .nf-valor {
            font-weight: bold;
            color: var(--success);
            font-size: 14px;
            text-align: right;
            min-width: 70px;
        }

        .nf-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            font-size: 12px;
            color: #7f8c8d;
        }

        .nf-info-item {
            display: flex;
            flex-direction: column;
        }

        .nf-info-label {
            font-size: 11px;
            color: #95a5a6;
            margin-bottom: 2px;
        }

        .nf-info-value {
            font-weight: 600;
            color: var(--secondary);
            font-size: 12px;
        }

        .nf-tipo {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 20px;
            font-size: 10px;
            font-weight: bold;
            margin-top: 5px;
        }

        .detalhes-expandidos {
            background: white;
            border-radius: var(--border-radius);
            padding: 20px;
            margin-top: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            border: 2px solid var(--primary);
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .detalhes-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e9ecef;
        }

        .detalhes-titulo {
            font-size: 1.2em;
            color: var(--secondary);
            font-weight: bold;
        }

        .detalhes-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
        }

        .detalhes-item {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 6px;
            border-left: 3px solid var(--primary);
        }

        .detalhes-label {
            font-size: 11px;
            color: #6c757d;
            margin-bottom: 4px;
        }

        .detalhes-value {
            font-size: 13px;
            font-weight: 600;
            color: var(--secondary);
        }

        .tipos-calculo-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 12px;
            margin-top: 15px;
        }

        .tipo-calculo-option {
            background: white;
            border-radius: var(--border-radius);
            padding: 15px;
            cursor: pointer;
            transition: var(--transition);
            border: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .tipo-calculo-option:hover {
            border-color: var(--primary);
            background: #f0f8ff;
        }

        .tipo-calculo-option.active {
            border-color: var(--danger);
            background: #fff8e1;
            box-shadow: 0 3px 10px rgba(231, 76, 60, 0.1);
        }

        .tipo-info {
            flex-grow: 1;
        }

        .tipo-nome {
            font-weight: bold;
            margin-bottom: 4px;
            font-size: 13px;
            color: var(--secondary);
        }

        .tipo-descricao {
            font-size: 11px;
            color: #7f8c8d;
            line-height: 1.3;
        }

        .tipo-valor {
            font-weight: bold;
            font-size: 13px;
            color: var(--secondary);
            text-align: right;
            min-width: 70px;
        }

        .diferenca-valor {
            font-size: 10px;
            margin-top: 4px;
        }

        .diferenca-positiva {
            color: var(--success);
        }

        .diferenca-negativa {
            color: var(--danger);
        }

        .filtros {
            margin-bottom: 15px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .filtros input, .filtros select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            flex: 1;
            min-width: 150px;
            font-size: 13px;
        }

        .explicacao-tipos {
            background: #e8f5e9;
            padding: 20px;
            border-radius: var(--border-radius);
            margin: 20px 0;
            border-left: 4px solid #4caf50;
        }

        .explicacao-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .explicacao-item {
            background: white;
            padding: 15px;
            border-radius: var(--border-radius);
            border-left: 3px solid #4caf50;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .explicacao-titulo {
            font-weight: bold;
            color: var(--secondary);
            margin-bottom: 8px;
            font-size: 14px;
        }

        .explicacao-descricao {
            font-size: 13px;
            color: #5a6268;
            line-height: 1.4;
            margin-bottom: 10px;
        }

        .explicacao-formula {
            background: #f8f9fa;
            padding: 8px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            color: #e83e8c;
        }

        .admin-section {
            background: white;
            padding: 20px;
            border-radius: var(--border-radius);
            border: 2px solid var(--danger);
            margin-top: 20px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
        }

        .tabela-admin {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 13px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .tabela-admin th,
        .tabela-admin td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }

        .tabela-admin th {
            background: var(--secondary);
            color: white;
            font-weight: 600;
        }

        .tabela-admin tr:hover {
            background: #f8f9fa;
        }

        .gestao-pagamento {
            background: #fff3cd;
            padding: 15px;
            border-radius: var(--border-radius);
            margin: 15px 0;
            border-left: 4px solid #ffc107;
        }

        .criador-calculo {
            background: white;
            padding: 20px;
            border-radius: var(--border-radius);
            border: 2px solid #9c27b0;
            margin-top: 20px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
        }

        .formula-input {
            font-family: monospace;
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 10px;
            width: 100%;
            margin-bottom: 12px;
            font-size: 13px;
            resize: vertical;
        }

        .variaveis-disponiveis {
            background: #e3f2fd;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 15px;
            font-size: 13px;
            line-height: 1.5;
        }

        .exemplo-formula {
            background: #fff3cd;
            padding: 12px;
            border-radius: 6px;
            margin-top: 12px;
            font-size: 13px;
            line-height: 1.5;
        }

        .explicacao-calculo {
            background: #e8f5e9;
            padding: 15px;
            border-radius: var(--border-radius);
            margin: 15px 0;
            border-left: 4px solid #4caf50;
            font-size: 13px;
        }

        .passo-calculo {
            margin: 8px 0;
            padding-left: 15px;
            border-left: 2px solid #4caf50;
            font-size: 13px;
        }

        .section::-webkit-scrollbar {
            width: 8px;
        }

        .section::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .section::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }

        .section::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }

        .status-pago {
            color: var(--success);
            font-weight: bold;
        }

        .status-agendado {
            color: var(--warning);
            font-weight: bold;
        }

        .status-pendente {
            color: var(--danger);
            font-weight: bold;
        }

        .tipo-basico { background: #28a745; color: white; }
        .tipo-por-dentro { background: #17a2b8; color: white; }
        .tipo-por-dentro-base-liquida { background: #8e44ad; color: white; }
        .tipo-fcp { background: #e74c3c; color: white; }
        .tipo-importado { background: #6f42c1; color: white; }
        .tipo-st { background: #fd7e14; color: white; }
        .tipo-beneficio { background: #ffc107; color: black; }
        .tipo-personalizado { background: #9c27b0; color: white; }
        .tipo-auto { background: #2196f3; color: white; }

        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
                height: auto;
            }
            
            .controls {
                flex-direction: column;
            }
            
            .nfs-container {
                grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            }
            
            .tabs {
                flex-wrap: wrap;
            }
            
            .tab {
                padding: 10px 15px;
                font-size: 13px;
            }
        }

        @media (max-width: 768px) {
            .nfs-container {
                grid-template-columns: repeat(auto-fill, minmax(170px, 1fr));
            }
            
            .detalhes-grid {
                grid-template-columns: 1fr;
            }
            
            .tipos-calculo-container {
                grid-template-columns: 1fr;
            }
            
            .main-content {
                padding: 15px;
            }
            
            .explicacao-grid {
                grid-template-columns: 1fr;
            }
            
            .resumo-grid {
                grid-template-columns: 1fr;
            }
            
            .tab-content {
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üßÆ Calculadora DIFAL - Multi Tipos de C√°lculo 2025</h1>
            <p>Identifica√ß√£o autom√°tica do tipo de c√°lculo DIFAL conforme legisla√ß√£o 2025</p>
        </header>

        <div class="tabs">
            <button class="tab active" onclick="abrirTab('tabCalculadora')">üìä Calculadora</button>
            <button class="tab" onclick="abrirTab('tabExplicacao')">üìö Como Calcular</button>
            <button class="tab" onclick="abrirTab('tabAdmin')">‚öôÔ∏è Administrar</button>
            <button class="tab" onclick="abrirTab('tabGestao')">üí≥ Pagamentos</button>
            <button class="tab" onclick="abrirTab('tabPersonalizado')">üß© Personalizar</button>
        </div>

        <div id="tabCalculadora" class="tab-content active">
            <div class="controls">
                <button class="btn btn-primary" onclick="processarTodosXMLs()">
                    <span>üîÑ</span> Processar XMLs
                </button>
                <button class="btn btn-success" onclick="exportarExcel()">
                    <span>üìä</span> Exportar Excel
                </button>
                <button class="btn btn-info" onclick="fazerBackup()">
                    <span>üíæ</span> Backup
                </button>
                <button class="btn btn-warning" onclick="limparTudo()">
                    <span>üóëÔ∏è</span> Limpar
                </button>
            </div>

            <div class="main-content">
                <div class="section">
                    <h2>üìÅ Importar NFes (XML)</h2>
                    <div class="upload-area" id="uploadArea">
                        <input type="file" id="xmlUpload" accept=".xml" multiple>
                        <div class="upload-placeholder">
                            <span>üìÅ Arraste XMLs aqui ou clique para selecionar</span>
                            <small>Suporte para m√∫ltiplos arquivos</small>
                        </div>
                    </div>

                    <div class="resumo">
                        <h4>üìà Resumo dos C√°lculos</h4>
                        <div id="resumoCalculos" class="resumo-grid">
                            <div class="resumo-item">
                                <div class="resumo-valor">0</div>
                                <div class="resumo-label">Total NF-es</div>
                            </div>
                            <div class="resumo-item">
                                <div class="resumo-valor">R$ 0,00</div>
                                <div class="resumo-label">Total DIFAL</div>
                            </div>
                            <div class="resumo-item">
                                <div class="resumo-valor">R$ 0,00</div>
                                <div class="resumo-label">Total FCP</div>
                            </div>
                            <div class="resumo-item">
                                <div class="resumo-valor">R$ 0,00</div>
                                <div class="resumo-label">Total Geral</div>
                            </div>
                        </div>
                    </div>

                    <div class="calculadora-section">
                        <h3>üßÆ Calculadora Manual</h3>
                        <div class="form-group">
                            <label for="ufOrigem">UF de Origem:</label>
                            <select id="ufOrigem">
                                <option value="">Selecione...</option>
                                <option value="AC">AC</option>
                                <option value="AL">AL</option>
                                <option value="AP">AP</option>
                                <option value="AM">AM</option>
                                <option value="BA">BA</option>
                                <option value="CE">CE</option>
                                <option value="DF">DF</option>
                                <option value="ES">ES</option>
                                <option value="GO">GO</option>
                                <option value="MA">MA</option>
                                <option value="MT">MT</option>
                                <option value="MS">MS</option>
                                <option value="MG">MG</option>
                                <option value="PA">PA</option>
                                <option value="PB">PB</option>
                                <option value="PR">PR</option>
                                <option value="PE">PE</option>
                                <option value="PI">PI</option>
                                <option value="RJ">RJ</option>
                                <option value="RN">RN</option>
                                <option value="RS">RS</option>
                                <option value="RO">RO</option>
                                <option value="RR">RR</option>
                                <option value="SC">SC</option>
                                <option value="SP">SP</option>
                                <option value="SE">SE</option>
                                <option value="TO">TO</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="ufDestino">UF de Destino:</label>
                            <select id="ufDestino">
                                <option value="">Selecione...</option>
                                <option value="AC">AC</option>
                                <option value="AL">AL</option>
                                <option value="AP">AP</option>
                                <option value="AM">AM</option>
                                <option value="BA">BA</option>
                                <option value="CE">CE</option>
                                <option value="DF">DF</option>
                                <option value="ES">ES</option>
                                <option value="GO">GO</option>
                                <option value="MA">MA</option>
                                <option value="MT">MT</option>
                                <option value="MS">MS</option>
                                <option value="MG">MG</option>
                                <option value="PA">PA</option>
                                <option value="PB">PB</option>
                                <option value="PR">PR</option>
                                <option value="PE">PE</option>
                                <option value="PI">PI</option>
                                <option value="RJ">RJ</option>
                                <option value="RN">RN</option>
                                <option value="RS">RS</option>
                                <option value="RO">RO</option>
                                <option value="RR">RR</option>
                                <option value="SC">SC</option>
                                <option value="SP">SP</option>
                                <option value="SE">SE</option>
                                <option value="TO">TO</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="valorBase">Valor Base (R$):</label>
                            <input type="text" id="valorBase" placeholder="0,00" oninput="formatarMoeda(this)">
                        </div>

                        <div class="form-group">
                            <label for="icmsDestacado">ICMS Destacado (R$):</label>
                            <input type="text" id="icmsDestacado" placeholder="0,00" oninput="formatarMoeda(this)">
                        </div>

                        <button class="btn btn-primary" onclick="calcularManual()" style="width: 100%;">
                            <span>üßÆ</span> Calcular DIFAL
                        </button>

                        <div id="resultadoManual" style="margin-top: 15px;"></div>
                    </div>
                </div>

                <div class="section">
                    <h2>üìã NF-es Processadas</h2>
                    
                    <div class="filtros">
                        <input type="text" id="filtroTabela" placeholder="üîç Filtrar..." oninput="filtrarTabela()">
                        <select id="filtroStatus" onchange="filtrarTabela()">
                            <option value="">Todos</option>
                            <option value="Aplic√°vel">Aplic√°vel</option>
                            <option value="Isento">Isento</option>
                            <option value="N√£o Aplic√°vel">N√£o Aplic√°vel</option>
                        </select>
                    </div>

                    <div class="nfs-container" id="lista-nfes">
                        <!-- Lista de NF-es ser√° preenchida via JavaScript -->
                    </div>

                    <div id="detalhes-container">
                        <!-- Detalhes expandidos aparecer√£o aqui -->
                    </div>
                </div>
            </div>
        </div>

        <div id="tabExplicacao" class="tab-content">
            <div class="section">
                <h2>üìö Como Funciona Cada Tipo de C√°lculo</h2>
                <p>Entenda as diferen√ßas entre os m√©todos de c√°lculo do DIFAL e quando aplicar cada um.</p>
                
                <div class="explicacao-tipos">
                    <h3>üß© Tipos de C√°lculo Dispon√≠veis</h3>
                    <div class="explicacao-grid">
                        <div class="explicacao-item">
                            <div class="explicacao-titulo tipo-auto" style="padding: 6px 10px; border-radius: 4px; display: inline-block;">C√°lculo Autom√°tico por Estado</div>
                            <div class="explicacao-descricao">
                                <strong>Quando usar:</strong> Aplica automaticamente a regra espec√≠fica conforme estado destino
                            </div>
                            <div class="explicacao-formula">
                                Vari√°vel conforme estado destino
                            </div>
                            <div class="passo-calculo">
                                <strong>Exemplo:</strong> Cada estado tem f√≥rmula espec√≠fica conforme legisla√ß√£o
                            </div>
                        </div>

                        <div class="explicacao-item">
                            <div class="explicacao-titulo tipo-basico" style="padding: 6px 10px; border-radius: 4px; display: inline-block;">C√°lculo B√°sico (Por Fora)</div>
                            <div class="explicacao-descricao">
                                <strong>Quando usar:</strong> Opera√ß√µes padr√£o para consumidor final n√£o contribuinte
                            </div>
                            <div class="explicacao-formula">
                                base √ó (aliqInterna - aliqInterestadual) √∑ 100
                            </div>
                            <div class="passo-calculo">
                                <strong>Exemplo:</strong> R$ 1.000 √ó (18% - 12%) = R$ 60,00
                            </div>
                        </div>

                        <div class="explicacao-item">
                            <div class="explicacao-titulo tipo-por-dentro" style="padding: 6px 10px; border-radius: 4px; display: inline-block;">C√°lculo Por Dentro</div>
                            <div class="explicacao-descricao">
                                <strong>Quando usar:</strong> Quando o ICMS comp√µe o pre√ßo da mercadoria
                            </div>
                            <div class="explicacao-formula">
                                (base √ó diferencial √∑ 100) √∑ (1 - aliqInterna √∑ 100)
                            </div>
                            <div class="passo-calculo">
                                <strong>Exemplo:</strong> (R$ 1.000 √ó 6%) √∑ (1 - 18%) = R$ 73,17
                            </div>
                        </div>

                        <div class="explicacao-item">
                            <div class="explicacao-titulo tipo-por-dentro-base-liquida" style="padding: 6px 10px; border-radius: 4px; display: inline-block;">Por Dentro com Base L√≠quida</div>
                            <div class="explicacao-descricao">
                                <strong>Quando usar:</strong> Quando h√° ICMS destacado na NF e ele comp√µe o pre√ßo
                            </div>
                            <div class="explicacao-formula">
                                ((base - icmsDestacado) √∑ (1 - aliqInterna √∑ 100)) √ó diferencial √∑ 100
                            </div>
                            <div class="passo-calculo">
                                <strong>Exemplo:</strong> ((R$ 1.000 - R$ 120) √∑ (1 - 18%)) √ó 6% = R$ 64,39
                            </div>
                        </div>

                        <div class="explicacao-item">
                            <div class="explicacao-titulo tipo-fcp" style="padding: 6px 10px; border-radius: 4px; display: inline-block;">Com FCP</div>
                            <div class="explicacao-descricao">
                                <strong>Quando usar:</strong> Estados com adicional de Fundo de Combate √† Pobreza
                            </div>
                            <div class="explicacao-formula">
                                base √ó diferencial √∑ 100 + base √ó fcp √∑ 100
                            </div>
                            <div class="passo-calculo">
                                <strong>Exemplo:</strong> R$ 1.000 √ó 6% + R$ 1.000 √ó 2% = R$ 80,00
                            </div>
                        </div>
                    </div>
                </div>

                <div class="calculadora-section">
                    <h3>üîç Vari√°veis dos C√°lculos</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(170px, 1fr)); gap: 10px;">
                        <div class="detalhes-item">
                            <div class="detalhes-label">base</div>
                            <div class="detalhes-value">Base de c√°lculo</div>
                        </div>
                        <div class="detalhes-item">
                            <div class="detalhes-label">aliqInterna</div>
                            <div class="detalhes-value">Al√≠quota interna do estado destino</div>
                        </div>
                        <div class="detalhes-item">
                            <div class="detalhes-label">aliqInterestadual</div>
                            <div class="detalhes-value">Al√≠quota interestadual</div>
                        </div>
                        <div class="detalhes-item">
                            <div class="detalhes-label">fcp</div>
                            <div class="detalhes-value">Percentual do FCP</div>
                        </div>
                        <div class="detalhes-item">
                            <div class="detalhes-label">diferencial</div>
                            <div class="detalhes-value">aliqInterna - aliqInterestadual</div>
                        </div>
                        <div class="detalhes-item">
                            <div class="detalhes-label">icmsDestacado</div>
                            <div class="detalhes-value">Valor do ICMS destacado na NF</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="tabAdmin" class="tab-content">
            <div class="admin-section">
                <h2>üìä Administra√ß√£o de Al√≠quotas</h2>
                <p>Edite as al√≠quotas internas e FCP conforme necess√°rio. As altera√ß√µes s√£o salvas automaticamente.</p>
                
                <div class="controls">
                    <button class="btn btn-primary" onclick="adicionarEstado()">
                        <span>‚ûï</span> Adicionar Estado
                    </button>
                    <button class="btn btn-success" onclick="salvarAliquotas()">
                        <span>üíæ</span> Salvar Altera√ß√µes
                    </button>
                    <button class="btn btn-info" onclick="restaurarPadroes()">
                        <span>üîÑ</span> Restaurar Padr√µes
                    </button>
                </div>
                
                <table class="tabela-admin" id="tabela-aliquotas">
                    <thead>
                        <tr>
                            <th>UF</th>
                            <th>Al√≠quota Interna (%)</th>
                            <th>FCP (%)</th>
                            <th>Al√≠quota Interestadual (%)</th>
                            <th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody id="tabelaAdmin">
                        <!-- Dados ser√£o preenchidos via JavaScript -->
                    </tbody>
                </table>
            </div>

            <div class="admin-section">
                <h2>‚öôÔ∏è Configura√ß√µes Gerais</h2>
                <div class="form-group">
                    <label for="configArredondamento">M√©todo de Arredondamento:</label>
                    <select id="configArredondamento">
                        <option value="padrao">Padr√£o (2 casas decimais)</option>
                        <option value="paraCima">Sempre para cima</option>
                        <option value="paraBaixo">Sempre para baixo</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="configExibirDetalhes">Exibir Detalhes do C√°lculo:</label>
                    <select id="configExibirDetalhes">
                        <option value="sempre">Sempre</option>
                        <option value="somenteErros">Somente em erros</option>
                        <option value="nunca">Nunca</option>
                    </select>
                </div>
                
                <button class="btn btn-primary" onclick="salvarConfiguracoes()">
                    <span>üíæ</span> Salvar Configura√ß√µes
                </button>
            </div>
        </div>

        <div id="tabGestao" class="tab-content">
            <div class="section">
                <h2>üí≥ Gest√£o de Pagamentos</h2>
                <p>Controle o status de pagamento das NF-es e gere relat√≥rios.</p>
                
                <div class="gestao-pagamento">
                    <h3>üìã Status de Pagamento</h3>
                    <div id="resumoPagamentos" class="resumo-grid">
                        <div class="resumo-item">
                            <div class="resumo-valor status-pendente">0</div>
                            <div class="resumo-label">Pendentes</div>
                        </div>
                        <div class="resumo-item">
                            <div class="resumo-valor status-agendado">0</div>
                            <div class="resumo-label">Agendados</div>
                        </div>
                        <div class="resumo-item">
                            <div class="resumo-valor status-pago">0</div>
                            <div class="resumo-label">Pagas</div>
                        </div>
                        <div class="resumo-item">
                            <div class="resumo-valor">R$ 0,00</div>
                            <div class="resumo-label">Total a Pagar</div>
                        </div>
                    </div>
                </div>

                <div class="controls">
                    <button class="btn btn-success" onclick="marcarComoPago()">
                        <span>‚úÖ</span> Marcar como Pago
                    </button>
                    <button class="btn btn-warning" onclick="agendarPagamento()">
                        <span>üìÖ</span> Agendar Pagamento
                    </button>
                    <button class="btn btn-info" onclick="gerarRelatorioPagamentos()">
                        <span>üìÑ</span> Relat√≥rio de Pagamentos
                    </button>
                </div>

                <div id="lista-pagamentos" class="nfs-container">
                    <!-- Lista de pagamentos ser√° preenchida via JavaScript -->
                </div>
            </div>
        </div>

        <div id="tabPersonalizado" class="tab-content">
            <div class="criador-calculo">
                <h2>üß© Criador de C√°lculos Personalizados</h2>
                <p>Crie suas pr√≥prias f√≥rmulas de c√°lculo para situa√ß√µes espec√≠ficas.</p>
                
                <div class="variaveis-disponiveis">
                    <strong>Vari√°veis dispon√≠veis:</strong> base, aliqInterna, aliqInterestadual, fcp, icmsDestacado, diferencial
                </div>

                <div class="form-group">
                    <label for="nomeCalculoPersonalizado">Nome do C√°lculo:</label>
                    <input type="text" id="nomeCalculoPersonalizado" placeholder="Ex: C√°lculo com Benef√≠cio Fiscal">
                </div>

                <div class="form-group">
                    <label for="formulaPersonalizada">F√≥rmula:</label>
                    <textarea id="formulaPersonalizada" class="formula-input" rows="4" placeholder="Ex: (base * diferencial / 100) * 0.5"></textarea>
                </div>

                <div class="exemplo-formula">
                    <strong>Exemplo de f√≥rmula:</strong> (base * diferencial / 100) * 0.5<br>
                    <strong>Resultado:</strong> Calcula 50% do DIFAL padr√£o
                </div>

                <div class="form-group">
                    <label for="descricaoCalculoPersonalizado">Descri√ß√£o:</label>
                    <textarea id="descricaoCalculoPersonalizado" rows="3" placeholder="Descreva quando usar este c√°lculo..."></textarea>
                </div>

                <div class="acoes-container" style="display: flex; gap: 8px; margin-top: 10px;">
                    <button class="btn btn-primary" onclick="testarFormula()">
                        <span>üß™</span> Testar F√≥rmula
                    </button>
                    <button class="btn btn-success" onclick="salvarCalculoPersonalizado()">
                        <span>üíæ</span> Salvar C√°lculo
                    </button>
                </div>
                
                <div id="resultadoTeste" style="margin-top: 12px;"></div>
            </div>
            
            <div class="calculos-salvos" style="margin-top: 15px;">
                <h3>üìÇ C√°lculos Personalizados Salvos</h3>
                <div class="nfs-container" id="lista-calculos-personalizados">
                    <!-- Lista de c√°lculos personalizados ser√° preenchida via JavaScript -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // REGRAS ESPEC√çFICAS POR ESTADO DESTINO
        const REGRAS_ESTADO = {
            'DF': { 
                tipo: 'BASE_UNICA', 
                nome: 'DF - Base √önica',
                formula: 'base * (aliqInterna - aliqInterestadual) / 100' 
            },
            'RR': { 
                tipo: 'BASE_UNICA', 
                nome: 'RR - Base √önica',
                formula: 'base * (aliqInterna - aliqInterestadual) / 100' 
            },
            'PI': { 
                tipo: 'BASE_DUPLA_PADRAO', 
                nome: 'PI - Base Dupla Padr√£o',
                formula: '((base - icmsDestacado) / (1 - aliqInterna / 100)) * aliqInterna / 100 - (base * aliqInterestadual / 100)' 
            },
            'MA': { 
                tipo: 'BASE_DUPLA_PADRAO', 
                nome: 'MA - Base Dupla Padr√£o',
                formula: '((base - icmsDestacado) / (1 - aliqInterna / 100)) * aliqInterna / 100 - (base * aliqInterestadual / 100)' 
            },
            'AC': { 
                tipo: 'BASE_DUPLA_PADRAO', 
                nome: 'AC - Base Dupla Padr√£o',
                formula: '((base - icmsDestacado) / (1 - aliqInterna / 100)) * aliqInterna / 100 - (base * aliqInterestadual / 100)' 
            },
            'AP': { 
                tipo: 'BASE_DUPLA_PADRAO', 
                nome: 'AP - Base Dupla Padr√£o',
                formula: '((base - icmsDestacado) / (1 - aliqInterna / 100)) * aliqInterna / 100 - (base * aliqInterestadual / 100)' 
            },
            'PA': { 
                tipo: 'BASE_DUPLA_PADRAO', 
                nome: 'PA - Base Dupla Padr√£o',
                formula: '((base - icmsDestacado) / (1 - aliqInterna / 100)) * aliqInterna / 100 - (base * aliqInterestadual / 100)' 
            },
            'RO': { 
                tipo: 'BASE_DUPLA_PADRAO', 
                nome: 'RO - Base Dupla Padr√£o',
                formula: '((base - icmsDestacado) / (1 - aliqInterna / 100)) * aliqInterna / 100 - (base * aliqInterestadual / 100)' 
            },
            'SP': { 
                tipo: 'BASE_DUPLA_PADRAO', 
                nome: 'SP - Base Dupla Padr√£o',
                formula: '((base - icmsDestacado) / (1 - aliqInterna / 100)) * aliqInterna / 100 - (base * aliqInterestadual / 100)' 
            },
            'TO': { 
                tipo: 'BASE_DUPLA_PADRAO', 
                nome: 'TO - Base Dupla Padr√£o',
                formula: '((base - icmsDestacado) / (1 - aliqInterna / 100)) * aliqInterna / 100 - (base * aliqInterestadual / 100)' 
            },
            'AM': { 
                tipo: 'BASE_DUPLA_AM', 
                nome: 'AM - Base Dupla Especial',
                formula: '((base - icmsDestacado) / (1 - aliqInterna / 100)) * (aliqInterna - aliqInterestadual) / 100' 
            },
            'RS': { 
                tipo: 'BASE_DUPLA_PADRAO', 
                nome: 'RS - Base Dupla Padr√£o',
                formula: '((base - icmsDestacado) / (1 - aliqInterna / 100)) * aliqInterna / 100 - (base * aliqInterestadual / 100)' 
            },
            'SC': { 
                tipo: 'BASE_DUPLA_PADRAO', 
                nome: 'SC - Base Dupla Padr√£o',
                formula: '((base - icmsDestacado) / (1 - aliqInterna / 100)) * aliqInterna / 100 - (base * aliqInterestadual / 100)' 
            },
            'MS': { 
                tipo: 'BASE_DUPLA_PADRAO', 
                nome: 'MS - Base Dupla Padr√£o',
                formula: '((base - icmsDestacado) / (1 - aliqInterna / 100)) * aliqInterna / 100 - (base * aliqInterestadual / 100)' 
            },
            'PR': { 
                tipo: 'BASE_DUPLA_PADRAO', 
                nome: 'PR - Base Dupla Padr√£o',
                formula: '((base - icmsDestacado) / (1 - aliqInterna / 100)) * aliqInterna / 100 - (base * aliqInterestadual / 100)' 
            },
            'MT': { 
                tipo: 'BASE_DUPLA_PADRAO', 
                nome: 'MT - Base Dupla Padr√£o',
                formula: '((base - icmsDestacado) / (1 - aliqInterna / 100)) * aliqInterna / 100 - (base * aliqInterestadual / 100)' 
            },
            'ES': { 
                tipo: 'BASE_DUPLA_PADRAO', 
                nome: 'ES - Base Dupla Padr√£o',
                formula: '((base - icmsDestacado) / (1 - aliqInterna / 100)) * aliqInterna / 100 - (base * aliqInterestadual / 100)' 
            },
            'RJ': { 
                tipo: 'BASE_DUPLA_COM_FECP', 
                nome: 'RJ - Base Dupla com FECP',
                formulaDIFAL: '((base - icmsDestacado) / (1 - (aliqInterna + fecp) / 100)) * aliqInterna / 100 - (base * aliqInterestadual / 100)',
                formulaFECP: '((base - icmsDestacado) / (1 - (aliqInterna + fecp) / 100)) * fecp / 100'
            },
            'MG': { 
                tipo: 'BASE_DUPLA_PADRAO', 
                nome: 'MG - Base Dupla Padr√£o',
                formula: '((base - icmsDestacado) / (1 - aliqInterna / 100)) * aliqInterna / 100 - (base * aliqInterestadual / 100)' 
            },
            'GO': { 
                tipo: 'BASE_DUPLA_PADRAO', 
                nome: 'GO - Base Dupla Padr√£o',
                formula: '((base - icmsDestacado) / (1 - aliqInterna / 100)) * aliqInterna / 100 - (base * aliqInterestadual / 100)' 
            },
            'CE': { 
                tipo: 'BASE_UNICA_SIMPLES', 
                nome: 'CE - Base √önica Simples',
                formula: 'base * (aliqInterna - aliqInterestadual) / 100' 
            },
            'SE': { 
                tipo: 'BASE_UNICA_SE', 
                nome: 'SE - Base √önica Especial',
                formula: 'base / (1 - (aliqInterna - aliqInterestadual) / 100) * (aliqInterna - aliqInterestadual) / 100' 
            },
            'PE': { 
                tipo: 'BASE_DUPLA_PE', 
                nome: 'PE - Base Dupla Especial',
                formula: '((base - icmsDestacado) / (1 - aliqInterna / 100)) * (aliqInterna - aliqInterestadual) / 100' 
            },
            'BA': { 
                tipo: 'BASE_DUPLA_PADRAO', 
                nome: 'BA - Base Dupla Padr√£o',
                formula: '((base - icmsDestacado) / (1 - aliqInterna / 100)) * aliqInterna / 100 - (base * aliqInterestadual / 100)' 
            },
            'PB': { 
                tipo: 'BASE_DUPLA_PB', 
                nome: 'PB - Base Dupla Especial',
                formula: '((base - icmsDestacado) / (1 - aliqInterna / 100)) * (aliqInterna - aliqInterestadual) / 100' 
            },
            'RN': { 
                tipo: 'BASE_DUPLA_PADRAO', 
                nome: 'RN - Base Dupla Padr√£o',
                formula: '((base - icmsDestacado) / (1 - aliqInterna / 100)) * aliqInterna / 100 - (base * aliqInterestadual / 100)' 
            },
            'AL': { 
                tipo: 'BASE_SIMPLES_COM_FECP', 
                nome: 'AL - Base Simples com FECP',
                formulaDIFAL: 'base / (1 - (aliqInterna + fecp) / 100) * (aliqInterna - aliqInterestadual) / 100',
                formulaFECP: 'base / (1 - (aliqInterna + fecp) / 100) * fecp / 100'
            }
        };

        // TIPOS DE C√ÅLCULO DIFAL
        const TIPOS_CALCULO = {
            AUTO: {
                codigo: 'AUTO',
                nome: 'C√°lculo Autom√°tico por Estado',
                descricao: 'Aplica regra espec√≠fica conforme estado destino',
                formula: 'Vari√°vel por estado',
                cor: 'tipo-auto'
            },
            BASICO: {
                codigo: 'BASICO',
                nome: 'C√°lculo B√°sico (Por Fora)',
                descricao: 'Opera√ß√µes padr√£o para consumidor final n√£o contribuinte',
                formula: 'base * (aliqInterna - aliqInterestadual) / 100',
                cor: 'tipo-basico'
            },
            POR_DENTRO: {
                codigo: 'POR_DENTRO',
                nome: 'C√°lculo Por Dentro',
                descricao: 'Quando o ICMS comp√µe o pre√ßo da mercadoria',
                formula: '(base * (aliqInterna - aliqInterestadual) / 100) / (1 - aliqInterna / 100)',
                cor: 'tipo-por-dentro'
            },
            POR_DENTRO_BASE_LIQUIDA: {
                codigo: 'POR_DENTRO_BASE_LIQUIDA',
                nome: 'Por Dentro com Base L√≠quida',
                descricao: 'C√°lculo por dentro com ajuste da base l√≠quida (ICMS incluso no pre√ßo)',
                formula: '((base - icmsDestacado) / (1 - aliqInterna / 100)) * (aliqInterna - aliqInterestadual) / 100',
                cor: 'tipo-por-dentro-base-liquida'
            },
            COM_FCP: {
                codigo: 'COM_FCP',
                nome: 'Com FCP',
                descricao: 'Estados com adicional de Fundo de Combate √† Pobreza',
                formula: 'base * (aliqInterna - aliqInterestadual) / 100 + base * fcp / 100',
                cor: 'tipo-fcp'
            },
            IMPORTADO: {
                codigo: 'IMPORTADO',
                nome: 'Produtos Importados',
                descricao: 'Mercadorias importadas do exterior',
                formula: 'base * (aliqInterna - 4) / 100',
                cor: 'tipo-importado'
            },
            SUBSTITUICAO_TRIBUTARIA: {
                codigo: 'SUBSTITUICAO_TRIBUTARIA',
                nome: 'Substitui√ß√£o Tribut√°ria',
                descricao: 'Quando a mercadoria j√° tem ICMS-ST',
                formula: 'base * (aliqInterna - aliqInterestadual) / 100',
                cor: 'tipo-st'
            },
            BENEFICIO_FISCAL: {
                codigo: 'BENEFICIO_FISCAL',
                nome: 'Benef√≠cio Fiscal',
                descricao: 'Redu√ß√£o da base ou al√≠quota interna',
                formula: '(base * 0.7) * (aliqInterna - aliqInterestadual) / 100',
                cor: 'tipo-beneficio'
            }
        };

        // DADOS INICIAIS
        let aliquotasInternas = {
            'AC': { valor: 19, vigencia: '2024-01-01', fonte: 'Decreto Estadual' },
            'AL': { valor: 20, vigencia: '2024-01-01', fonte: 'Decreto Estadual' },
            'AP': { valor: 18, vigencia: '2024-01-01', fonte: 'Decreto Estadual' },
            'AM': { valor: 20, vigencia: '2024-01-01', fonte: 'Decreto Estadual' },
            'BA': { valor: 20.5, vigencia: '2024-01-01', fonte: 'Decreto Estadual' },
            'CE': { valor: 20, vigencia: '2024-01-01', fonte: 'Decreto Estadual' },
            'DF': { valor: 20, vigencia: '2024-01-01', fonte: 'Decreto Estadual' },
            'ES': { valor: 17, vigencia: '2024-01-01', fonte: 'Decreto Estadual' },
            'GO': { valor: 19, vigencia: '2024-01-01', fonte: 'Decreto Estadual' },
            'MA': { valor: 23, vigencia: '2024-01-01', fonte: 'Decreto Estadual' },
            'MT': { valor: 17, vigencia: '2024-01-01', fonte: 'Decreto Estadual' },
            'MS': { valor: 17, vigencia: '2024-01-01', fonte: 'Decreto Estadual' },
            'MG': { valor: 18, vigencia: '2024-01-01', fonte: 'Decreto Estadual' },
            'PA': { valor: 19, vigencia: '2024-01-01', fonte: 'Decreto Estadual' },
            'PB': { valor: 20, vigencia: '2024-01-01', fonte: 'Decreto Estadual' },
            'PR': { valor: 19.5, vigencia: '2024-01-01', fonte: 'Decreto Estadual' },
            'PE': { valor: 20.5, vigencia: '2024-01-01', fonte: 'Decreto Estadual' },
            'PI': { valor: 22.5, vigencia: '2024-01-01', fonte: 'Decreto Estadual' },
            'RJ': { valor: 22, vigencia: '2024-01-01', fonte: 'Decreto Estadual' },
            'RN': { valor: 20, vigencia: '2024-01-01', fonte: 'Decreto Estadual' },
            'RS': { valor: 17, vigencia: '2024-01-01', fonte: 'Decreto Estadual' },
            'RO': { valor: 19.5, vigencia: '2024-01-01', fonte: 'Decreto Estadual' },
            'RR': { valor: 20, vigencia: '2024-01-01', fonte: 'Decreto Estadual' },
            'SC': { valor: 17, vigencia: '2024-01-01', fonte: 'Decreto Estadual' },
            'SP': { valor: 18, vigencia: '2024-01-01', fonte: 'Decreto Estadual' },
            'SE': { valor: 20, vigencia: '2024-01-01', fonte: 'Decreto Estadual' },
            'TO': { valor: 20, vigencia: '2024-01-01', fonte: 'Decreto Estadual' }
        };

        let fundoPobreza = {
            'AC': 0, 'AL': 1, 'AP': 0, 'AM': 0, 'BA': 0, 'CE': 0, 'DF': 0, 'ES': 0, 
            'GO': 0, 'MA': 0, 'MT': 0, 'MS': 0, 'MG': 0, 'PA': 0, 'PB': 0, 'PR': 0, 
            'PE': 0, 'PI': 0, 'RJ': 2, 'RN': 0, 'RS': 0, 'RO': 0, 'RR': 0, 'SC': 0, 
            'SP': 0, 'SE': 0, 'TO': 0
        };

        // Array para armazenar todos os c√°lculos
        let todosCalculos = [];
        let nfSelecionada = null;
        let calculosPersonalizados = {};

        // FUN√á√ïES PRINCIPAIS
        function configurarUpload() {
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('xmlUpload');
            
            uploadArea.addEventListener('click', () => fileInput.click());
            
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.style.background = 'rgba(52, 152, 219, 0.15)';
            });
            
            uploadArea.addEventListener('dragleave', () => {
                uploadArea.style.background = 'rgba(52, 152, 219, 0.05)';
            });
            
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.style.background = 'rgba(52, 152, 219, 0.05)';
                
                const files = e.dataTransfer.files;
                processarArquivos(files);
            });
            
            fileInput.addEventListener('change', (e) => {
                processarArquivos(e.target.files);
            });
        }

        // CORRE√á√ÉO: Fun√ß√£o para extrair dados de todos os itens do XML
        function extrairDadosCompletosNF(xmlContent) {
            try {
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(xmlContent, "text/xml");
                
                if (xmlDoc.getElementsByTagName("parsererror").length > 0) {
                    throw new Error('XML inv√°lido ou malformado');
                }
                
                // Informa√ß√µes gerais da NF
                let numeroNF = xmlDoc.getElementsByTagName("nNF")[0]?.textContent;
                if (!numeroNF) {
                    numeroNF = xmlDoc.getElementsByTagName("numero")[0]?.textContent;
                }
                
                const ufEmitente = xmlDoc.getElementsByTagName("UF")[0]?.textContent || 
                                  xmlDoc.querySelector("emit > enderEmit > UF")?.textContent;
                
                const ufDestinatario = xmlDoc.getElementsByTagName("UF")[1]?.textContent || 
                                      xmlDoc.querySelector("dest > enderDest > UF")?.textContent;
                
                const valorTotalElem = xmlDoc.getElementsByTagName("vNF")[0];
                const valorTotal = valorTotalElem ? parseFloat(valorTotalElem.textContent) : 0;
                
                const cfopElem = xmlDoc.getElementsByTagName("CFOP")[0];
                const cfop = cfopElem ? cfopElem.textContent : "N√£o encontrado";
                
                const indicadorIEDest = xmlDoc.getElementsByTagName("indIEDest")[0]?.textContent;
                let tipoDestinatario = 'consumidor';
                if (indicadorIEDest === '1') {
                    tipoDestinatario = 'contribuinte';
                } else if (indicadorIEDest === '2' || indicadorIEDest === '9') {
                    tipoDestinatario = 'isento';
                }
                
                // CORRE√á√ÉO: Capturar todos os itens da NF
                const itens = xmlDoc.getElementsByTagName("det");
                let baseCalculoTotal = 0;
                let valorICMSTotal = 0;
                
                for (let i = 0; i < itens.length; i++) {
                    const item = itens[i];
                    
                    // Base de c√°lculo do item
                    const baseCalculoItemElem = item.getElementsByTagName("vBC")[0];
                    const baseCalculoItem = baseCalculoItemElem ? parseFloat(baseCalculoItemElem.textContent) : 0;
                    baseCalculoTotal += baseCalculoItem;
                    
                    // Valor do ICMS do item
                    const valorICMSItemElem = item.getElementsByTagName("vICMS")[0];
                    const valorICMSItem = valorICMSItemElem ? parseFloat(valorICMSItemElem.textContent) : 0;
                    valorICMSTotal += valorICMSItem;
                }
                
                // Se n√£o encontrou base de c√°lculo nos itens, usa o valor total
                if (baseCalculoTotal === 0) {
                    baseCalculoTotal = valorTotal;
                }
                
                const aplicavelDIFAL = ufEmitente !== ufDestinatario && 
                                      tipoDestinatario === 'consumidor' && 
                                      valorTotal > 0;

                return {
                    numeroNF: numeroNF || "N√∫mero n√£o encontrado",
                    ufEmitente: ufEmitente || "UF n√£o encontrada",
                    ufDestinatario: ufDestinatario || "UF n√£o encontrada",
                    valorTotal: valorTotal,
                    baseCalculoICMS: baseCalculoTotal,
                    valorICMS: valorICMSTotal,
                    cfop: cfop,
                    tipoDestinatario: tipoDestinatario,
                    aplicavelDIFAL: aplicavelDIFAL,
                    quantidadeItens: itens.length
                };
                
            } catch (error) {
                console.error("Erro ao extrair dados da NF:", error);
                throw new Error(`Falha na extra√ß√£o dos dados do XML: ${error.message}`);
            }
        }

        function determinarTipoCalculo(dadosNF) {
            // Verificar se h√° regra espec√≠fica para o estado destino
            if (REGRAS_ESTADO[dadosNF.ufDestinatario]) {
                return 'AUTO';
            }
            
            // L√≥gica anterior mantida como fallback
            if (dadosNF.valorICMS > 0) {
                return 'POR_DENTRO_BASE_LIQUIDA';
            } else if (dadosNF.ufDestinatario === 'SP' || dadosNF.ufDestinatario === 'RJ') {
                return 'COM_FCP';
            } else {
                return 'BASICO';
            }
        }

        function processarArquivos(files) {
            const xmlFiles = Array.from(files).filter(file => file.name.endsWith('.xml'));
            
            if (xmlFiles.length === 0) {
                alert('Nenhum arquivo XML encontrado.');
                return;
            }

            xmlFiles.forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const dadosNF = extrairDadosCompletosNF(e.target.result);
                        
                        const novaNF = {
                            id: Date.now() + index,
                            fileName: file.name,
                            numeroNF: dadosNF.numeroNF,
                            origem: dadosNF.ufEmitente,
                            destino: dadosNF.ufDestinatario,
                            valorTotal: dadosNF.valorTotal,
                            baseCalculo: dadosNF.baseCalculoICMS,
                            icmsDestacado: dadosNF.valorICMS,
                            cfop: dadosNF.cfop,
                            tipoDestinatario: dadosNF.tipoDestinatario,
                            status: 'Processado',
                            timestamp: new Date().toLocaleString(),
                            aplicavel: dadosNF.aplicavelDIFAL,
                            tipoCalculo: determinarTipoCalculo(dadosNF),
                            statusPagamento: 'Pendente',
                            quantidadeItens: dadosNF.quantidadeItens
                        };

                        const resultado = calcularDIFALMultiTipo(
                            novaNF.origem,
                            novaNF.destino,
                            novaNF.tipoDestinatario,
                            novaNF.baseCalculo,
                            TIPOS_CALCULO[novaNF.tipoCalculo],
                            novaNF.icmsDestacado
                        );

                        Object.assign(novaNF, resultado);
                        todosCalculos.push(novaNF);
                        
                        if (index === xmlFiles.length - 1) {
                            renderizarListaNFes();
                            atualizarResumo();
                            salvarHistorico();
                        }
                    } catch (error) {
                        console.error('Erro ao processar XML:', error);
                        alert(`Erro ao processar ${file.name}: ${error.message}`);
                    }
                };
                reader.readAsText(file);
            });

            alert(`${xmlFiles.length} arquivo(s) XML processado(s) com sucesso!`);
        }

        function calcularAliquotaInterestadual(origem, destino) {
            const estadosSulSudesteExcetoES = ['PR', 'RS', 'SC', 'SP', 'MG', 'RJ'];
            const estadosDestino7 = ['AC', 'AL', 'AP', 'AM', 'BA', 'CE', 'DF', 'ES', 'GO', 'MA', 'MT', 'MS', 'PA', 'PB', 'PE', 'PI', 'RN', 'RO', 'RR', 'SE', 'TO'];
            
            if (estadosSulSudesteExcetoES.includes(origem) && estadosDestino7.includes(destino)) {
                return 7;
            }
            
            return 12;
        }

        function calcularDIFALMultiTipo(origem, destino, tipoDestinatario, baseCalculo, tipoCalculo, icmsDestacado = 0) {
            let resultado = {
                baseCalculo: baseCalculo,
                aliqInterestadual: calcularAliquotaInterestadual(origem, destino),
                aliqInterna: aliquotasInternas[destino]?.valor || 18,
                percFCP: fundoPobreza[destino] || 0,
                tipoCalculo: tipoCalculo,
                icmsDestacado: icmsDestacado,
                detalhes: [],
                regraAplicada: 'PADR√ÉO'
            };

            const variaveis = {
                base: baseCalculo,
                aliqInterna: resultado.aliqInterna,
                aliqInterestadual: resultado.aliqInterestadual,
                fecp: resultado.percFCP,
                diferencial: resultado.aliqInterna - resultado.aliqInterestadual,
                icmsDestacado: icmsDestacado
            };

            try {
                // Verificar se h√° regra espec√≠fica para o estado destino
                const regraEstado = REGRAS_ESTADO[destino];
                
                if (regraEstado && tipoCalculo.codigo === 'AUTO') {
                    // Aplicar regra autom√°tica baseada no estado destino
                    resultado.regraAplicada = regraEstado.tipo;
                    resultado.difal = aplicarRegraEstado(regraEstado, variaveis);
                    
                    // Adicionar detalhes da regra aplicada
                    resultado.detalhes.push(`Regra aplicada: ${regraEstado.nome}`);
                } else if (tipoCalculo.codigo.startsWith('PERSONALIZADO_')) {
                    // C√°lculo personalizado
                    const calculoPersonalizado = calculosPersonalizados[tipoCalculo.codigo];
                    if (calculoPersonalizado && calculoPersonalizado.formula) {
                        resultado.difal = executarFormulaPersonalizada(calculoPersonalizado.formula, variaveis);
                        resultado.regraAplicada = 'PERSONALIZADO';
                    }
                } else {
                    // Tipos de c√°lculo padr√£o
                    resultado.difal = calcularTipoPadrao(tipoCalculo.codigo, variaveis);
                    resultado.regraAplicada = tipoCalculo.codigo;
                }

                // C√°lculo de FCP espec√≠fico para estados com FECP
                if (regraEstado && (regraEstado.tipo === 'BASE_DUPLA_COM_FECP' || regraEstado.tipo === 'BASE_SIMPLES_COM_FECP')) {
                    resultado.fcp = executarFormulaPersonalizada(regraEstado.formulaFECP, variaveis);
                } else {
                    resultado.fcp = baseCalculo * resultado.percFCP / 100;
                }

                resultado.total = (resultado.difal || 0) + (resultado.fcp || 0);

            } catch (error) {
                resultado.erro = error.message;
                resultado.difal = 0;
                resultado.fcp = 0;
                resultado.total = 0;
            }

            return resultado;
        }

        function aplicarRegraEstado(regraEstado, variaveis) {
            switch(regraEstado.tipo) {
                case 'BASE_UNICA':
                case 'BASE_UNICA_SIMPLES':
                    return executarFormulaPersonalizada(regraEstado.formula, variaveis);
                    
                case 'BASE_DUPLA_PADRAO':
                case 'BASE_DUPLA_AM':
                case 'BASE_DUPLA_PE':
                case 'BASE_DUPLA_PB':
                case 'BASE_UNICA_SE':
                    return executarFormulaPersonalizada(regraEstado.formula, variaveis);
                    
                case 'BASE_DUPLA_COM_FECP':
                    return executarFormulaPersonalizada(regraEstado.formulaDIFAL, variaveis);
                    
                case 'BASE_SIMPLES_COM_FECP':
                    return executarFormulaPersonalizada(regraEstado.formulaDIFAL, variaveis);
                    
                default:
                    return variaveis.base * (variaveis.aliqInterna - variaveis.aliqInterestadual) / 100;
            }
        }

        function calcularTipoPadrao(codigoTipo, variaveis) {
            switch (codigoTipo) {
                case 'BASICO':
                    return variaveis.base * (variaveis.aliqInterna - variaveis.aliqInterestadual) / 100;
                    
                case 'POR_DENTRO':
                    const diferencial = variaveis.aliqInterna - variaveis.aliqInterestadual;
                    const divisor = (1 - variaveis.aliqInterna / 100);
                    return (variaveis.base * diferencial / 100) / divisor;
                    
                case 'POR_DENTRO_BASE_LIQUIDA':
                    return calcularPorDentroBaseLiquida(variaveis.base, variaveis.icmsDestacado, variaveis.aliqInterna, variaveis.aliqInterestadual);
                    
                case 'COM_FCP':
                    return variaveis.base * (variaveis.aliqInterna - variaveis.aliqInterestadual) / 100;
                    
                case 'IMPORTADO':
                    return variaveis.base * (variaveis.aliqInterna - 4) / 100;
                    
                case 'SUBSTITUICAO_TRIBUTARIA':
                    return variaveis.base * (variaveis.aliqInterna - variaveis.aliqInterestadual) / 100;
                    
                case 'BENEFICIO_FISCAL':
                    const baseReduzida = variaveis.base * 0.7;
                    return baseReduzida * (variaveis.aliqInterna - variaveis.aliqInterestadual) / 100;
                    
                default:
                    return variaveis.base * (variaveis.aliqInterna - variaveis.aliqInterestadual) / 100;
            }
        }

        function calcularPorDentroBaseLiquida(baseCalculo, icmsDestacado, aliqInterna, aliqInterestadual) {
            const baseLiquida = baseCalculo - icmsDestacado;
            const baseAjustada = baseLiquida / (1 - aliqInterna / 100);
            const diferencial = aliqInterna - aliqInterestadual;
            const difal = baseAjustada * diferencial / 100;
            
            return difal;
        }

        function executarFormulaPersonalizada(formula, variaveis) {
            try {
                let formulaExecutavel = formula;
                for (const [variavel, valor] of Object.entries(variaveis)) {
                    formulaExecutavel = formulaExecutavel.replace(new RegExp(variavel, 'g'), valor);
                }
                
                if (/[^0-9+\-*/().\s]/.test(formulaExecutavel)) {
                    throw new Error('F√≥rmula cont√©m caracteres n√£o permitidos');
                }
                
                const resultado = eval(formulaExecutavel);
                
                if (isNaN(resultado) || !isFinite(resultado)) {
                    throw new Error('Resultado da f√≥rmula √© inv√°lido');
                }
                
                return resultado;
            } catch (error) {
                console.error('Erro ao executar f√≥rmula personalizada:', error);
                throw new Error(`Erro na f√≥rmula: ${error.message}`);
            }
        }

        // FUN√á√ÉO PARA RENDERIZAR CARDS
        function renderizarListaNFes() {
            const container = document.getElementById('lista-nfes');
            container.innerHTML = '';

            if (todosCalculos.length === 0) {
                container.innerHTML = '<p style="text-align: center; padding: 20px; color: #666; font-size: 11px;">Nenhuma NF-e processada. Fa√ßa upload de arquivos XML.</p>';
                return;
            }

            todosCalculos.forEach(calculo => {
                const tipo = TIPOS_CALCULO[calculo.tipoCalculo] || 
                            calculosPersonalizados[calculo.tipoCalculo] || 
                            TIPOS_CALCULO.BASICO;
                
                const displayName = calculo.numeroNF && calculo.numeroNF !== "N√∫mero n√£o encontrado" ? 
                    `NF-e ${calculo.numeroNF}` : calculo.fileName;

                const div = document.createElement('div');
                div.className = `nf-card ${calculo === nfSelecionada ? 'active' : ''}`;
                div.dataset.id = calculo.id;
                
                div.innerHTML = `
                    <div class="nf-card-header">
                        <div class="nf-numero">${displayName}</div>
                        <div class="nf-valor">R$ ${calculo.total?.toFixed(2)}</div>
                    </div>
                    <div class="nf-info">
                        <div class="nf-info-item">
                            <div class="nf-info-label">Origem ‚Üí Destino</div>
                            <div class="nf-info-value">${calculo.origem} ‚Üí ${calculo.destino}</div>
                        </div>
                        <div class="nf-info-item">
                            <div class="nf-info-label">Base</div>
                            <div class="nf-info-value">R$ ${calculo.baseCalculo?.toFixed(2)}</div>
                        </div>
                        <div class="nf-info-item">
                            <div class="nf-info-label">Itens</div>
                            <div class="nf-info-value">${calculo.quantidadeItens || 1}</div>
                        </div>
                        <div class="nf-info-item">
                            <div class="nf-info-label">Tipo</div>
                            <div class="nf-info-value">
                                <span class="nf-tipo ${tipo.cor || 'tipo-basico'}">${tipo.nome}</span>
                            </div>
                        </div>
                    </div>
                `;
                
                container.appendChild(div);
            });

            document.querySelectorAll('.nf-card').forEach(card => {
                card.addEventListener('click', function() {
                    const id = this.dataset.id;
                    nfSelecionada = todosCalculos.find(nf => nf.id == id);
                    
                    document.querySelectorAll('.nf-card').forEach(c => {
                        c.classList.remove('active');
                    });
                    this.classList.add('active');
                    
                    mostrarDetalhesExpandidos();
                });
            });

            filtrarTabela();
        }

        function mostrarDetalhesExpandidos() {
            const container = document.getElementById('detalhes-container');
            
            if (!nfSelecionada) {
                container.innerHTML = '';
                return;
            }

            const tipoAtual = TIPOS_CALCULO[nfSelecionada.tipoCalculo] || 
                             calculosPersonalizados[nfSelecionada.tipoCalculo] || 
                             TIPOS_CALCULO.BASICO;
            const valorAtual = nfSelecionada.total || 0;

            const displayName = nfSelecionada.numeroNF && nfSelecionada.numeroNF !== "N√∫mero n√£o encontrado" ? 
                `NF-e ${nfSelecionada.numeroNF}` : nfSelecionada.fileName;

            let html = `
                <div class="detalhes-expandidos">
                    <div class="detalhes-header">
                        <div class="detalhes-titulo">${displayName}</div>
                        <div style="font-weight: bold; color: #27ae60; font-size: 14px;">
                            R$ ${valorAtual.toFixed(2)}
                        </div>
                    </div>
                    
                    <div class="detalhes-grid">
                        <div class="detalhes-item">
                            <div class="detalhes-label">Origem ‚Üí Destino</div>
                            <div class="detalhes-value">${nfSelecionada.origem} ‚Üí ${nfSelecionada.destino}</div>
                        </div>
                        <div class="detalhes-item">
                            <div class="detalhes-label">Base de C√°lculo</div>
                            <div class="detalhes-value">R$ ${nfSelecionada.baseCalculo?.toFixed(2)}</div>
                        </div>
                        <div class="detalhes-item">
                            <div class="detalhes-label">CFOP</div>
                            <div class="detalhes-value">${nfSelecionada.cfop || "N√£o informado"}</div>
                        </div>
                        <div class="detalhes-item">
                            <div class="detalhes-label">Quantidade de Itens</div>
                            <div class="detalhes-value">${nfSelecionada.quantidadeItens || 1}</div>
                        </div>
                        ${nfSelecionada.icmsDestacado > 0 ? `
                        <div class="detalhes-item">
                            <div class="detalhes-label">ICMS Destacado</div>
                            <div class="detalhes-value">R$ ${nfSelecionada.icmsDestacado?.toFixed(2)}</div>
                        </div>
                        ` : ''}
                        <div class="detalhes-item">
                            <div class="detalhes-label">Tipo Atual</div>
                            <div class="detalhes-value">
                                <span class="nf-tipo ${tipoAtual.cor || 'tipo-basico'}">${tipoAtual.nome}</span>
                            </div>
                        </div>
                        <div class="detalhes-item">
                            <div class="detalhes-label">Regra Aplicada</div>
                            <div class="detalhes-value">
                                <span class="nf-tipo tipo-personalizado">${nfSelecionada.regraAplicada || 'Padr√£o'}</span>
                            </div>
                        </div>
                        <div class="detalhes-item">
                            <div class="detalhes-label">Status Pagamento</div>
                            <div class="detalhes-value">
                                <span class="nf-status status-${nfSelecionada.statusPagamento?.toLowerCase() || 'pendente'}">${nfSelecionada.statusPagamento || 'Pendente'}</span>
                            </div>
                        </div>
                    </div>

                    <h3 style="margin: 12px 0 8px 0; color: #2c3e50; font-size: 13px;">Alterar Tipo de C√°lculo</h3>
                    <div class="tipos-calculo-container" id="tipos-calculo">
            `;

            const todosTipos = {...TIPOS_CALCULO, ...calculosPersonalizados};
            
            Object.entries(todosTipos).forEach(([codigo, tipo]) => {
                const resultado = calcularDIFALMultiTipo(
                    nfSelecionada.origem,
                    nfSelecionada.destino,
                    nfSelecionada.tipoDestinatario,
                    nfSelecionada.baseCalculo,
                    tipo,
                    nfSelecionada.icmsDestacado
                );

                const diferenca = resultado.total - valorAtual;
                const isAtual = codigo === nfSelecionada.tipoCalculo;
                
                html += `
                    <div class="tipo-calculo-option ${isAtual ? 'active' : ''}" data-tipo="${codigo}">
                        <div class="tipo-info">
                            <div class="tipo-nome">${tipo.nome}</div>
                            <div class="tipo-descricao">${tipo.descricao}</div>
                        </div>
                        <div class="tipo-valor">
                            R$ ${resultado.total.toFixed(2)}
                            <div class="diferenca-valor ${diferenca > 0 ? 'diferenca-positiva' : diferenca < 0 ? 'diferenca-negativa' : ''}">
                                ${isAtual ? 'Atual' : `${diferenca > 0 ? '+' : ''} R$ ${Math.abs(diferenca).toFixed(2)}`}
                            </div>
                        </div>
                    </div>
                `;
            });

            html += `
                    </div>
                    <div style="margin-top: 12px; display: flex; gap: 8px;">
                        <button class="btn btn-primary" id="btn-aplicar" style="flex: 1;">Aplicar Altera√ß√£o</button>
                        <button class="btn btn-success" onclick="compararTiposCalculo()">Comparar Todos</button>
                    </div>
                </div>
            `;

            container.innerHTML = html;

            document.getElementById('btn-aplicar').addEventListener('click', aplicarAlteracaoTipo);

            document.querySelectorAll('.tipo-calculo-option').forEach(option => {
                option.addEventListener('click', function() {
                    document.querySelectorAll('.tipo-calculo-option').forEach(opt => {
                        opt.classList.remove('active');
                    });
                    this.classList.add('active');
                });
            });
        }

        function aplicarAlteracaoTipo() {
            if (!nfSelecionada) return;

            const tipoSelecionado = document.querySelector('.tipo-calculo-option.active')?.dataset.tipo;
            if (!tipoSelecionado || tipoSelecionado === nfSelecionada.tipoCalculo) {
                alert('Selecione um tipo de c√°lculo diferente do atual.');
                return;
            }

            const tipo = TIPOS_CALCULO[tipoSelecionado] || calculosPersonalizados[tipoSelecionado];
            const resultado = calcularDIFALMultiTipo(
                nfSelecionada.origem,
                nfSelecionada.destino,
                nfSelecionada.tipoDestinatario,
                nfSelecionada.baseCalculo,
                tipo,
                nfSelecionada.icmsDestacado
            );

            Object.assign(nfSelecionada, resultado);
            nfSelecionada.tipoCalculo = tipoSelecionado;

            renderizarListaNFes();
            mostrarDetalhesExpandidos();
            salvarHistorico();
            
            alert(`Tipo de c√°lculo alterado para: ${tipo.nome}`);
        }

        function compararTiposCalculo() {
            if (!nfSelecionada) {
                alert('Selecione uma NF-e para comparar os tipos de c√°lculo.');
                return;
            }
            
            let comparacao = `Compara√ß√£o de tipos de c√°lculo para ${nfSelecionada.fileName}:\n\n`;
            const valorAtual = nfSelecionada.total || 0;
            const todosTipos = {...TIPOS_CALCULO, ...calculosPersonalizados};
            
            Object.entries(todosTipos).forEach(([codigo, tipo]) => {
                const resultado = calcularDIFALMultiTipo(
                    nfSelecionada.origem,
                    nfSelecionada.destino,
                    nfSelecionada.tipoDestinatario,
                    nfSelecionada.baseCalculo,
                    tipo,
                    nfSelecionada.icmsDestacado
                );
                
                const diferenca = resultado.total - valorAtual;
                const seta = codigo === nfSelecionada.tipoCalculo ? '‚Üí ' : '  ';
                const diffTexto = diferenca !== 0 ? ` (${diferenca > 0 ? '+' : ''}R$ ${Math.abs(diferenca).toFixed(2)})` : '';
                
                comparacao += `${seta}${tipo.nome}: R$ ${resultado.total.toFixed(2)}${diffTexto}\n`;
            });
            
            alert(comparacao);
        }

        // FUN√á√ÉO EXPORTAR EXCEL
        function exportarExcel() {
            if (todosCalculos.length === 0) {
                alert('N√£o h√° dados para exportar.');
                return;
            }
            
            try {
                const dadosExportacao = todosCalculos.map(calculo => {
                    const tipo = TIPOS_CALCULO[calculo.tipoCalculo] || calculosPersonalizados[calculo.tipoCalculo] || TIPOS_CALCULO.BASICO;
                    
                    return {
                        'NF-e': calculo.numeroNF || calculo.fileName,
                        'Arquivo': calculo.fileName,
                        'Origem': calculo.origem,
                        'Destino': calculo.destino,
                        'Base de C√°lculo (R$)': calculo.baseCalculo?.toFixed(2) || '0.00',
                        'ICMS Destacado (R$)': calculo.icmsDestacado?.toFixed(2) || '0.00',
                        'CFOP': calculo.cfop || 'N√£o informado',
                        'Quantidade de Itens': calculo.quantidadeItens || 1,
                        'Tipo de C√°lculo': tipo.nome,
                        'Regra Aplicada': calculo.regraAplicada || 'Padr√£o',
                        'Al√≠quota Interna (%)': calculo.aliqInterna || 0,
                        'Al√≠quota Interestadual (%)': calculo.aliqInterestadual || 0,
                        'DIFAL (R$)': calculo.difal?.toFixed(2) || '0.00',
                        'FCP (R$)': calculo.fcp?.toFixed(2) || '0.00',
                        'Total (R$)': calculo.total?.toFixed(2) || '0.00',
                        'Status Pagamento': calculo.statusPagamento || 'Pendente',
                        'Data Processamento': calculo.timestamp
                    };
                });

                const ws = XLSX.utils.json_to_sheet(dadosExportacao);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "C√°lculos DIFAL");
                
                const nomeArquivo = `calculos_difal_${new Date().toISOString().slice(0, 10)}.xlsx`;
                XLSX.writeFile(wb, nomeArquivo);
                
                alert(`Exporta√ß√£o conclu√≠da! ${todosCalculos.length} registros exportados para ${nomeArquivo}`);
            } catch (error) {
                console.error('Erro ao exportar para Excel:', error);
                alert('Erro ao exportar para Excel. Verifique o console para mais detalhes.');
            }
        }

        // FUN√á√ïES EXISTENTES
        function abrirTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });

            document.getElementById(tabName).classList.add('active');
            event.currentTarget.classList.add('active');
        }

        function processarTodosXMLs() {
            if (todosCalculos.length === 0) {
                alert('N√£o h√° XMLs para processar. Importe alguns XMLs primeiro.');
                return;
            }
            
            alert(`Processamento conclu√≠do! ${todosCalculos.length} NF-es processadas.`);
        }

        function fazerBackup() {
            if (todosCalculos.length === 0) {
                alert('N√£o h√° dados para backup.');
                return;
            }

            const backupData = {
                calculos: todosCalculos,
                aliquotas: aliquotasInternas,
                fcp: fundoPobreza,
                calculosPersonalizados: calculosPersonalizados,
                regrasEstado: REGRAS_ESTADO,
                timestamp: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(backupData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `backup_difal_${new Date().toISOString().slice(0, 10)}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alert(`Backup realizado com sucesso! ${todosCalculos.length} registros salvos.`);
        }

        function limparTudo() {
            if (confirm('Tem certeza que deseja limpar todos os c√°lculos?')) {
                todosCalculos = [];
                renderizarListaNFes();
                atualizarResumo();
                document.getElementById('detalhes-container').innerHTML = '';
            }
        }

        function formatarMoeda(input) {
            let valor = input.value.replace(/\D/g, '');
            valor = (valor / 100).toFixed(2) + '';
            valor = valor.replace(".", ",");
            valor = valor.replace(/(\d)(\d{3})(\d{3}),/g, "$1.$2.$3,");
            valor = valor.replace(/(\d)(\d{3}),/g, "$1.$2,");
            input.value = valor;
        }

        function filtrarTabela() {
            const filtroTexto = document.getElementById('filtroTabela').value.toLowerCase();
            const filtroStatus = document.getElementById('filtroStatus').value;
            
            const nfItems = document.querySelectorAll('#lista-nfes .nf-card');
            
            nfItems.forEach(item => {
                const textoItem = item.textContent.toLowerCase();
                const statusItem = item.querySelector('.nf-tipo').textContent;
                
                const correspondeTexto = textoItem.includes(filtroTexto);
                const correspondeStatus = !filtroStatus || statusItem.includes(filtroStatus);
                
                item.style.display = (correspondeTexto && correspondeStatus) ? '' : 'none';
            });
        }

        function atualizarResumo() {
            const resumoDiv = document.getElementById('resumoCalculos');
            
            const totalNFes = todosCalculos.length;
            const totalValor = todosCalculos.reduce((sum, c) => sum + (c.total || 0), 0);
            const totalFCP = todosCalculos.reduce((sum, c) => sum + (c.fcp || 0), 0);
            
            resumoDiv.innerHTML = `
                <div class="resumo-item">
                    <div class="resumo-valor">${totalNFes}</div>
                    <div class="resumo-label">Total NF-es</div>
                </div>
                <div class="resumo-item">
                    <div class="resumo-valor">R$ ${totalValor.toFixed(2)}</div>
                    <div class="resumo-label">Total DIFAL</div>
                </div>
                <div class="resumo-item">
                    <div class="resumo-valor">R$ ${totalFCP.toFixed(2)}</div>
                    <div class="resumo-label">Total FCP</div>
                </div>
                <div class="resumo-item">
                    <div class="resumo-valor">R$ ${(totalValor + totalFCP).toFixed(2)}</div>
                    <div class="resumo-label">Total Geral</div>
                </div>
            `;
        }

        function salvarHistorico() {
            localStorage.setItem('historicoDIFAL', JSON.stringify(todosCalculos));
        }

        function carregarHistorico() {
            const historico = localStorage.getItem('historicoDIFAL');
            if (historico) {
                todosCalculos = JSON.parse(historico);
                renderizarListaNFes();
                atualizarResumo();
            }
        }

        // FUN√á√ïES DE ADMINISTRA√á√ÉO
        function renderizarTabelaAdmin() {
            const tbody = document.getElementById('tabelaAdmin');
            tbody.innerHTML = '';

            const estados = Object.keys(aliquotasInternas).sort();
            
            estados.forEach(estado => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><strong>${estado}</strong></td>
                    <td>
                        <input type="number" 
                               value="${aliquotasInternas[estado]?.valor || 0}" 
                               step="0.1" 
                               min="0" 
                               max="100"
                               onchange="atualizarAliquotaInterna('${estado}', this.value)"
                               style="width: 60px; padding: 3px; border: 1px solid #ddd; border-radius: 3px; text-align: center;">
                        %
                    </td>
                    <td>
                        <input type="number" 
                               value="${fundoPobreza[estado] || 0}" 
                               step="0.1" 
                               min="0" 
                               max="100"
                               onchange="atualizarFCP('${estado}', this.value)"
                               style="width: 60px; padding: 3px; border: 1px solid #ddd; border-radius: 3px; text-align: center;">
                        %
                    </td>
                    <td>${aliquotasInternas[estado]?.vigencia || '2024-01-01'}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        function atualizarAliquotaInterna(estado, valor) {
            aliquotasInternas[estado].valor = parseFloat(valor) || 0;
        }

        function atualizarFCP(estado, valor) {
            fundoPobreza[estado] = parseFloat(valor) || 0;
        }

        function salvarAliquotas() {
            const data = {
                aliquotasInternas: aliquotasInternas,
                fundoPobreza: fundoPobreza,
                timestamp: new Date().toISOString()
            };
            localStorage.setItem('aliquotasDIFAL', JSON.stringify(data));
            alert('Al√≠quotas salvas com sucesso!');
        }

        function carregarAliquotasPadrao() {
            if (confirm('Isso ir√° restaurar as al√≠quotas padr√£o. Deseja continuar?')) {
                alert('Al√≠quotas padr√£o restauradas com sucesso!');
                renderizarTabelaAdmin();
            }
        }

        function exportarAliquotas() {
            alert('Exportando al√≠quotas...');
        }

        function filtrarTabelaAdmin() {
            const filtro = document.getElementById('filtroAdmin').value.toUpperCase();
            const linhas = document.querySelectorAll('#tabelaAdmin tr');
            
            linhas.forEach(linha => {
                const estado = linha.cells[0].textContent;
                linha.style.display = estado.includes(filtro) ? '' : 'none';
            });
        }

        // FUN√á√ïES DE GEST√ÉO DE PAGAMENTOS
        function atualizarResumoPagamentos() {
            const resumoDiv = document.getElementById('resumoPagamentos');
            if (!resumoDiv) return;

            const total = todosCalculos.filter(c => c.aplicavel && c.total > 0).length;
            const pendentes = todosCalculos.filter(c => c.aplicavel && c.total > 0 && (!c.statusPagamento || c.statusPagamento === 'Pendente')).length;
            const agendados = todosCalculos.filter(c => c.statusPagamento === 'Agendado').length;
            const pagos = todosCalculos.filter(c => c.statusPagamento === 'Pago').length;
            const totalValor = todosCalculos.filter(c => c.aplicavel && c.total > 0).reduce((sum, c) => sum + (c.total || 0), 0);
            const valorPendente = todosCalculos.filter(c => c.aplicavel && c.total > 0 && (!c.statusPagamento || c.statusPagamento === 'Pendente')).reduce((sum, c) => sum + (c.total || 0), 0);

            resumoDiv.innerHTML = `
                <div class="resumo-item">
                    <div class="resumo-valor status-pendente">${pendentes}</div>
                    <div class="resumo-label">Pendentes</div>
                </div>
                <div class="resumo-item">
                    <div class="resumo-valor status-agendado">${agendados}</div>
                    <div class="resumo-label">Agendados</div>
                </div>
                <div class="resumo-item">
                    <div class="resumo-valor status-pago">${pagos}</div>
                    <div class="resumo-label">Pagas</div>
                </div>
                <div class="resumo-item">
                    <div class="resumo-valor">R$ ${valorPendente.toFixed(2)}</div>
                    <div class="resumo-label">Total a Pagar</div>
                </div>
            `;

            renderizarListaPagamentos();
        }

        function renderizarListaPagamentos() {
            const container = document.getElementById('lista-pagamentos');
            if (!container) return;

            const calculosComDIFAL = todosCalculos.filter(c => c.aplicavel && c.total > 0);
            
            if (calculosComDIFAL.length === 0) {
                container.innerHTML = '<p style="text-align: center; padding: 20px; color: #666; font-size: 11px;">Nenhum c√°lculo com DIFAL aplic√°vel</p>';
                return;
            }

            container.innerHTML = '';
            calculosComDIFAL.forEach(calculo => {
                const tipo = TIPOS_CALCULO[calculo.tipoCalculo] || calculosPersonalizados[calculo.tipoCalculo] || TIPOS_CALCULO.BASICO;
                const statusPagamento = calculo.statusPagamento || 'Pendente';
                const statusClass = statusPagamento === 'Pago' ? 'status-pago' : 
                                 statusPagamento === 'Agendado' ? 'status-agendado' : 
                                 'status-pendente';

                const displayName = calculo.numeroNF && calculo.numeroNF !== "N√∫mero n√£o encontrado" ? 
                    `NF-e ${calculo.numeroNF}` : calculo.fileName;

                const div = document.createElement('div');
                div.className = 'nf-card';
                div.innerHTML = `
                    <div class="nf-card-header">
                        <div class="nf-numero">${displayName}</div>
                        <div class="nf-valor">R$ ${calculo.total?.toFixed(2)}</div>
                        <span class="nf-status status-${statusPagamento.toLowerCase()}">${statusPagamento}</span>
                    </div>
                    <div class="nf-info">
                        <div class="nf-info-item">
                            <div class="nf-info-label">Origem ‚Üí Destino</div>
                            <div class="nf-info-value">${calculo.origem} ‚Üí ${calculo.destino}</div>
                        </div>
                        <div class="nf-info-item">
                            <div class="nf-info-label">Tipo</div>
                            <div class="nf-info-value">
                                <span class="nf-tipo ${tipo.cor || 'tipo-basico'}">${tipo.nome}</span>
                            </div>
                        </div>
                    </div>
                    <div style="margin-top: 8px; display: flex; gap: 5px;">
                        <button class="btn" onclick="alterarStatusPagamento(${calculo.id}, 'Pago')" style="padding: 4px 8px; font-size: 11px;">Pago</button>
                        <button class="btn" onclick="alterarStatusPagamento(${calculo.id}, 'Agendado')" style="padding: 4px 8px; font-size: 11px;">Agendar</button>
                        <button class="btn" onclick="alterarStatusPagamento(${calculo.id}, 'Pendente')" style="padding: 4px 8px; font-size: 11px;">Pendente</button>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function alterarStatusPagamento(calculoId, novoStatus) {
            const calculo = todosCalculos.find(c => c.id === calculoId);
            if (!calculo) return;

            calculo.statusPagamento = novoStatus;
            atualizarResumoPagamentos();
            salvarHistorico();
        }

        function marcarComoPago() {
            const selecionados = document.querySelectorAll('#lista-pagamentos .nf-card');
            if (selecionados.length === 0) {
                alert('N√£o h√° pagamentos para marcar como pagos.');
                return;
            }

            alert('Funcionalidade de marcar como pago - selecione os itens individualmente.');
        }

        function agendarParaMesSeguinte() {
            alert('Funcionalidade de agendamento para o pr√≥ximo m√™s.');
        }

        function gerarRelatorioPagamentos() {
            if (todosCalculos.length === 0) {
                alert('N√£o h√° pagamentos para gerar relat√≥rio.');
                return;
            }

            alert('Gerando relat√≥rio de pagamentos...');
        }

        // FUN√á√ïES PARA C√ÅLCULOS PERSONALIZADOS
        function testarFormula() {
            const nome = document.getElementById('nomeCalculoPersonalizado').value;
            const descricao = document.getElementById('descricaoCalculoPersonalizado').value;
            const formula = document.getElementById('formulaPersonalizada').value;
            
            if (!nome || !formula) {
                alert('Preencha o nome e a f√≥rmula para testar.');
                return;
            }
            
            const variaveisTeste = {
                base: 1000,
                aliqInterna: 18,
                aliqInterestadual: 12,
                fecp: 2,
                diferencial: 6,
                icmsDestacado: 120
            };
            
            try {
                const resultado = executarFormulaPersonalizada(formula, variaveisTeste);
                const resultadoDiv = document.getElementById('resultadoTeste');
                
                resultadoDiv.innerHTML = `
                    <div style="background: #d4edda; padding: 10px; border-radius: 6px; font-size: 11px;">
                        <h4>‚úÖ Teste Bem-Sucedido!</h4>
                        <p><strong>F√≥rmula:</strong> ${formula}</p>
                        <p><strong>Com base = R$ 1.000,00:</strong></p>
                        <p><strong>Resultado:</strong> R$ ${resultado.toFixed(2)}</p>
                        <p><small>Vari√°veis usadas: base=1000, aliqInterna=18, aliqInterestadual=12, fecp=2, diferencial=6, icmsDestacado=120</small></p>
                    </div>
                `;
            } catch (error) {
                const resultadoDiv = document.getElementById('resultadoTeste');
                resultadoDiv.innerHTML = `
                    <div style="background: #f8d7da; padding: 10px; border-radius: 6px; font-size: 11px;">
                        <h4>‚ùå Erro na F√≥rmula</h4>
                        <p><strong>Erro:</strong> ${error.message}</p>
                        <p>Verifique a sintaxe da f√≥rmula e as vari√°veis utilizadas.</p>
                    </div>
                `;
            }
        }

        function salvarCalculoPersonalizado() {
            const nome = document.getElementById('nomeCalculoPersonalizado').value;
            const descricao = document.getElementById('descricaoCalculoPersonalizado').value;
            const formula = document.getElementById('formulaPersonalizada').value;
            
            if (!nome || !formula) {
                alert('Preencha o nome e a f√≥rmula para salvar.');
                return;
            }
            
            const codigo = 'PERSONALIZADO_' + Date.now();
            
            calculosPersonalizados[codigo] = {
                codigo: codigo,
                nome: nome,
                descricao: descricao,
                formula: formula,
                cor: 'tipo-personalizado'
            };
            
            document.getElementById('nomeCalculoPersonalizado').value = '';
            document.getElementById('descricaoCalculoPersonalizado').value = '';
            document.getElementById('formulaPersonalizada').value = '';
            document.getElementById('resultadoTeste').innerHTML = '';
            
            renderizarCalculosPersonalizados();
            salvarCalculosPersonalizados();
            
            alert(`C√°lculo personalizado "${nome}" salvo com sucesso!`);
        }

        function renderizarCalculosPersonalizados() {
            const container = document.getElementById('lista-calculos-personalizados');
            container.innerHTML = '';
            
            if (Object.keys(calculosPersonalizados).length === 0) {
                container.innerHTML = '<p style="text-align: center; padding: 20px; color: #666; font-size: 11px;">Nenhum c√°lculo personalizado salvo.</p>';
                return;
            }
            
            Object.values(calculosPersonalizados).forEach(calculo => {
                const div = document.createElement('div');
                div.className = 'nf-card';
                div.innerHTML = `
                    <div class="nf-card-header">
                        <div class="nf-numero">${calculo.nome}</div>
                        <button class="btn btn-danger" onclick="excluirCalculoPersonalizado('${calculo.codigo}')" style="padding: 4px 8px; font-size: 10px;">Excluir</button>
                    </div>
                    <div class="nf-info">
                        <div class="nf-info-item">
                            <div class="nf-info-label">Descri√ß√£o</div>
                            <div class="nf-info-value">${calculo.descricao}</div>
                        </div>
                        <div class="nf-info-item">
                            <div class="nf-info-label">F√≥rmula</div>
                            <div class="nf-info-value" style="font-family: monospace; font-size: 9px;">${calculo.formula}</div>
                        </div>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function excluirCalculoPersonalizado(codigo) {
            if (confirm('Tem certeza que deseja excluir este c√°lculo personalizado?')) {
                delete calculosPersonalizados[codigo];
                renderizarCalculosPersonalizados();
                salvarCalculosPersonalizados();
            }
        }

        function salvarCalculosPersonalizados() {
            localStorage.setItem('calculosPersonalizadosDIFAL', JSON.stringify(calculosPersonalizados));
        }

        function carregarCalculosPersonalizados() {
            const calculosSalvos = localStorage.getItem('calculosPersonalizadosDIFAL');
            if (calculosSalvos) {
                calculosPersonalizados = JSON.parse(calculosSalvos);
                renderizarCalculosPersonalizados();
            }
        }

        // FUN√á√ÉO MELHORADA: C√°lculo manual
        function calcularManual() {
            const ufOrigem = document.getElementById('ufOrigem').value;
            const ufDestino = document.getElementById('ufDestino').value;
            const valorBase = parseFloat(document.getElementById('valorBase').value.replace('.', '').replace(',', '.')) || 0;
            const icmsDestacado = parseFloat(document.getElementById('icmsDestacado').value.replace('.', '').replace(',', '.')) || 0;

            if (!ufOrigem || !ufDestino || !valorBase || valorBase <= 0) {
                alert('Por favor, preencha todos os campos com valores v√°lidos.');
                return;
            }

            // Usar c√°lculo autom√°tico por estado se dispon√≠vel
            const regraEstado = REGRAS_ESTADO[ufDestino];
            const tipoCalculo = regraEstado ? TIPOS_CALCULO.AUTO : 
                               (icmsDestacado > 0 ? TIPOS_CALCULO.POR_DENTRO_BASE_LIQUIDA : TIPOS_CALCULO.BASICO);
            
            const resultado = calcularDIFALMultiTipo(ufOrigem, ufDestino, 'consumidor', valorBase, tipoCalculo, icmsDestacado);
            
            const resultadoDiv = document.getElementById('resultadoManual');
            
            let detalhesCalculo = '';
            if (regraEstado) {
                detalhesCalculo = `
                    <div class="explicacao-calculo">
                        <h4>üîç Detalhamento do C√°lculo Autom√°tico</h4>
                        <div class="passo-calculo">
                            <strong>Estado Destino:</strong> ${ufDestino} - ${regraEstado.nome}
                        </div>
                        <div class="passo-calculo">
                            <strong>Tipo de Regra:</strong> ${regraEstado.tipo}
                        </div>
                        <div class="passo-calculo">
                            <strong>F√≥rmula Aplicada:</strong> ${regraEstado.formula || regraEstado.formulaDIFAL}
                        </div>
                    </div>
                `;
            } else if (icmsDestacado > 0 && tipoCalculo.codigo === 'POR_DENTRO_BASE_LIQUIDA') {
                const baseLiquida = valorBase - icmsDestacado;
                const baseAjustada = baseLiquida / (1 - resultado.aliqInterna / 100);
                
                detalhesCalculo = `
                    <div class="explicacao-calculo">
                        <h4>üîç Detalhamento do C√°lculo "Por Dentro com Base L√≠quida"</h4>
                        <div class="passo-calculo">
                            <strong>1. Base L√≠quida:</strong> R$ ${valorBase.toFixed(2)} - R$ ${icmsDestacado.toFixed(2)} = <strong>R$ ${baseLiquida.toFixed(2)}</strong>
                        </div>
                        <div class="passo-calculo">
                            <strong>2. Base Ajustada:</strong> R$ ${baseLiquida.toFixed(2)} √∑ (1 - ${resultado.aliqInterna}%) = <strong>R$ ${baseAjustada.toFixed(2)}</strong>
                        </div>
                        <div class="passo-calculo">
                            <strong>3. DIFAL:</strong> R$ ${baseAjustada.toFixed(2)} √ó (${resultado.aliqInterna}% - ${resultado.aliqInterestadual}%) = <strong>R$ ${resultado.difal?.toFixed(2)}</strong>
                        </div>
                    </div>
                `;
            }
            
            resultadoDiv.innerHTML = `
                <div style="background: #d4edda; padding: 12px; border-radius: 6px; font-size: 11px;">
                    <h4>‚úÖ Resultado do C√°lculo DIFAL</h4>
                    <p><strong>Origem:</strong> ${ufOrigem} ‚Üí <strong>Destino:</strong> ${ufDestino}</p>
                    <p><strong>Tipo de C√°lculo:</strong> ${tipoCalculo.nome}</p>
                    <p><strong>Regra Aplicada:</strong> ${resultado.regraAplicada}</p>
                    <p><strong>Valor DIFAL:</strong> R$ ${resultado.difal?.toFixed(2) || '0.00'}</p>
                    <p><strong>Valor FCP:</strong> R$ ${resultado.fcp?.toFixed(2) || '0.00'}</p>
                    <p><strong>Total a Recolher:</strong> R$ ${resultado.total?.toFixed(2) || '0.00'}</p>
                    ${detalhesCalculo}
                </div>
            `;
        }

        // INICIALIZA√á√ÉO
        document.addEventListener('DOMContentLoaded', function() {
            configurarUpload();
            carregarHistorico();
            carregarAliquotasSalvas();
            carregarCalculosPersonalizados();
            renderizarTabelaAdmin();
            renderizarCalculosPersonalizados();
            atualizarResumoPagamentos();
        });

        function carregarAliquotasSalvas() {
            const aliquotasSalvas = localStorage.getItem('aliquotasDIFAL');
            if (aliquotasSalvas) {
                const data = JSON.parse(aliquotasSalvas);
                aliquotasInternas = data.aliquotasInternas || aliquotasInternas;
                fundoPobreza = data.fundoPobreza || fundoPobreza;
            }
        }

        // Fun√ß√µes auxiliares para as abas
        function adicionarEstado() {
            alert('Adicionar estado - funcionalidade em desenvolvimento');
        }

        function restaurarPadroes() {
            if (confirm('Restaurar al√≠quotas padr√£o?')) {
                alert('Al√≠quotas restauradas!');
            }
        }

        function salvarConfiguracoes() {
            alert('Configura√ß√µes salvas!');
        }

        function agendarPagamento() {
            alert('Agendando pagamento...');
        }
    </script>
</body>
</html>
