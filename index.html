<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora DIFAL - Parser XML Real</title>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        header {
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .controls {
            display: flex;
            gap: 15px;
            padding: 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #3498db;
            color: white;
        }

        .btn-success {
            background: #27ae60;
            color: white;
        }

        .btn-warning {
            background: #f39c12;
            color: white;
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            padding: 20px;
        }

        .section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #dee2e6;
            max-height: 80vh;
            overflow-y: auto;
        }

        h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.5em;
        }

        .upload-area {
            border: 3px dashed #3498db;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            transition: all 0.3s;
            cursor: pointer;
            margin-bottom: 20px;
        }

        .upload-area:hover {
            background: #e3f2fd;
            border-color: #2980b9;
        }

        .upload-area input {
            display: none;
        }

        .resumo {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .tabela-resultados {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 12px;
        }

        .tabela-resultados th,
        .tabela-resultados td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }

        .tabela-resultados th {
            background: #34495e;
            color: white;
            font-weight: 600;
            position: sticky;
            top: 0;
        }

        .tabela-resultados tr:hover {
            background: #e9ecef;
        }

        .status-applicable {
            color: #27ae60;
            font-weight: bold;
        }

        .status-not-applicable {
            color: #e74c3c;
            font-weight: bold;
        }

        .status-exempt {
            color: #f39c12;
            font-weight: bold;
        }

        .detalhes-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            padding: 8px 0;
            border-bottom: 1px solid rgba(0,0,0,0.1);
        }

        .detalhes-total {
            font-weight: bold;
            font-size: 1.2em;
            color: #155724;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 2px solid #28a745;
        }

        .xml-info {
            background: #fff3cd;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid #ffc107;
        }

        .debug-info {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 11px;
            margin-top: 10px;
            max-height: 200px;
            overflow-y: auto;
            white-space: pre-wrap;
        }

        .calculadora-section {
            background: white;
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #3498db;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #2c3e50;
        }

        .form-group select, 
        .form-group input {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        .form-group select:focus, 
        .form-group input:focus {
            outline: none;
            border-color: #3498db;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .controls {
                flex-direction: column;
            }
            
            .tabela-resultados {
                font-size: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üßÆ Calculadora DIFAL - Parser XML Real</h1>
            <p>Processamento preciso de XMLs com c√°lculos corretos de DIFAL</p>
        </header>

        <div class="controls">
            <button class="btn btn-primary" onclick="processarTodosXMLs()">Processar Todos XMLs</button>
            <button class="btn btn-success" onclick="exportarExcel()">Exportar para Excel</button>
            <button class="btn btn-warning" onclick="limparTudo()">Limpar Tudo</button>
            <button class="btn btn-danger" onclick="mostrarDebug()">Mostrar Debug</button>
        </div>

        <div class="main-content">
            <div class="section">
                <h2>Importar NFes (XML)</h2>
                <div class="upload-area" id="uploadArea">
                    <input type="file" id="xmlUpload" accept=".xml" multiple>
                    <div class="upload-placeholder">
                        <span>üìÅ Arraste XMLs aqui ou clique para selecionar</span>
                        <br>
                        <small>Suporte para m√∫ltiplos arquivos - Processamento real de XML</small>
                    </div>
                </div>

                <div class="resumo">
                    <h4>Resumo dos C√°lculos</h4>
                    <div id="resumoCalculos">Nenhum XML processado</div>
                </div>

                <div id="debugInfo" style="display: none;">
                    <h4>Informa√ß√µes de Debug</h4>
                    <div id="debugContent" class="debug-info"></div>
                </div>

                <div class="calculadora-section">
                    <h3>Calculadora Manual</h3>
                    <div class="form-group">
                        <label for="ufOrigem">UF de Origem:</label>
                        <select id="ufOrigem">
                            <option value="">Selecione...</option>
                            <option value="AC">AC</option>
                            <option value="AL">AL</option>
                            <option value="AP">AP</option>
                            <option value="AM">AM</option>
                            <option value="BA">BA</option>
                            <option value="CE">CE</option>
                            <option value="DF">DF</option>
                            <option value="ES">ES</option>
                            <option value="GO">GO</option>
                            <option value="MA">MA</option>
                            <option value="MT">MT</option>
                            <option value="MS">MS</option>
                            <option value="MG">MG</option>
                            <option value="PA">PA</option>
                            <option value="PB">PB</option>
                            <option value="PR">PR</option>
                            <option value="PE">PE</option>
                            <option value="PI">PI</option>
                            <option value="RJ">RJ</option>
                            <option value="RN">RN</option>
                            <option value="RS">RS</option>
                            <option value="RO">RO</option>
                            <option value="RR">RR</option>
                            <option value="SC">SC</option>
                            <option value="SP">SP</option>
                            <option value="SE">SE</option>
                            <option value="TO">TO</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="ufDestino">UF de Destino:</label>
                        <select id="ufDestino">
                            <option value="">Selecione...</option>
                            <option value="AC">AC</option>
                            <option value="AL">AL</option>
                            <option value="AP">AP</option>
                            <option value="AM">AM</option>
                            <option value="BA">BA</option>
                            <option value="CE">CE</option>
                            <option value="DF">DF</option>
                            <option value="ES">ES</option>
                            <option value="GO">GO</option>
                            <option value="MA">MA</option>
                            <option value="MT">MT</option>
                            <option value="MS">MS</option>
                            <option value="MG">MG</option>
                            <option value="PA">PA</option>
                            <option value="PB">PB</option>
                            <option value="PR">PR</option>
                            <option value="PE">PE</option>
                            <option value="PI">PI</option>
                            <option value="RJ">RJ</option>
                            <option value="RN">RN</option>
                            <option value="RS">RS</option>
                            <option value="RO">RO</option>
                            <option value="RR">RR</option>
                            <option value="SC">SC</option>
                            <option value="SP">SP</option>
                            <option value="SE">SE</option>
                            <option value="TO">TO</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="valorBase">Valor Base (R$):</label>
                        <input type="number" id="valorBase" step="0.01" placeholder="0,00">
                    </div>

                    <button class="btn btn-primary" onclick="calcularManual()" style="width: 100%;">Calcular DIFAL Manual</button>

                    <div id="resultadoManual" style="margin-top: 15px;"></div>
                </div>
            </div>

            <div class="section">
                <h2>Resultados dos C√°lculos</h2>
                <div class="tabela-container">
                    <table class="tabela-resultados">
                        <thead>
                            <tr>
                                <th>NF-e</th>
                                <th>Origem</th>
                                <th>Destino</th>
                                <th>Valor Total</th>
                                <th>Aliq. Inter</th>
                                <th>Aliq. Interna</th>
                                <th>DIFAL</th>
                                <th>FCP</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="tabelaResultados">
                            <tr>
                                <td colspan="9" style="text-align: center; padding: 20px;">
                                    Nenhum resultado dispon√≠vel
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div id="detalhesContainer"></div>
            </div>
        </div>
    </div>

    <script>
        // Banco de dados completo e atualizado de al√≠quotas
        const aliquotasInterestaduais = {
            'AC': {}, 'AL': {}, 'AP': {}, 'AM': {}, 'BA': {}, 'CE': {}, 'DF': {}, 'ES': {}, 
            'GO': {}, 'MA': {}, 'MT': {}, 'MS': {}, 'MG': {}, 'PA': {}, 'PB': {}, 'PR': {}, 
            'PE': {}, 'PI': {}, 'RJ': {}, 'RN': {}, 'RS': {}, 'RO': {}, 'RR': {}, 'SC': {}, 
            'SP': {}, 'SE': {}, 'TO': {}
        };

        // Preencher al√≠quotas interestaduais (regra geral: 7% para Norte/Nordeste, 12% para Sul/Sudeste/Centro-Oeste)
        const estadosNorteNordeste = ['AC', 'AL', 'AP', 'AM', 'BA', 'CE', 'MA', 'PA', 'PB', 'PE', 'PI', 'RN', 'SE', 'TO', 'RR', 'RO'];
        const estadosSulSudeste = ['ES', 'MG', 'PR', 'RJ', 'RS', 'SC', 'SP', 'DF', 'GO', 'MT', 'MS'];

        estadosSulSudeste.forEach(origem => {
            estadosNorteNordeste.forEach(destino => {
                aliquotasInterestaduais[origem][destino] = 7; // 7% para opera√ß√µes de Sul/Sudeste para Norte/Nordeste
            });
            estadosSulSudeste.forEach(destino => {
                if (origem !== destino) {
                    aliquotasInterestaduais[origem][destino] = 12; // 12% entre estados do Sul/Sudeste
                }
            });
        });

        estadosNorteNordeste.forEach(origem => {
            estadosSulSudeste.forEach(destino => {
                aliquotasInterestaduais[origem][destino] = 12; // 12% para opera√ß√µes de Norte/Nordeste para Sul/Sudeste
            });
            estadosNorteNordeste.forEach(destino => {
                if (origem !== destino) {
                    aliquotasInterestaduais[origem][destino] = 7; // 7% entre estados do Norte/Nordeste
                }
            });
        });

        const aliquotasInternas = {
            'AC': 17, 'AL': 18, 'AP': 18, 'AM': 18, 'BA': 18, 'CE': 18, 'DF': 18, 'ES': 17, 
            'GO': 17, 'MA': 18, 'MT': 17, 'MS': 17, 'MG': 18, 'PA': 17, 'PB': 18, 'PR': 18, 
            'PE': 18, 'PI': 18, 'RJ': 20, 'RN': 18, 'RS': 18, 'RO': 17.5, 'RR': 17, 'SC': 17, 
            'SP': 18, 'SE': 18, 'TO': 18
        };

        const fundoPobreza = {
            'AC': 0, 'AL': 0, 'AP': 0, 'AM': 0, 'BA': 0, 'CE': 0, 'DF': 0, 'ES': 0, 
            'GO': 0, 'MA': 0, 'MT': 0, 'MS': 0, 'MG': 0, 'PA': 0, 'PB': 0, 'PR': 0, 
            'PE': 0, 'PI': 0, 'RJ': 0, 'RN': 0, 'RS': 0, 'RO': 0, 'RR': 0, 'SC': 0, 
            'SP': 2, 'SE': 0, 'TO': 0
        };

        // Array para armazenar todos os c√°lculos
        let todosCalculos = [];
        let debugData = [];

        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', function() {
            configurarUpload();
        });

        function configurarUpload() {
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('xmlUpload');
            
            uploadArea.addEventListener('click', () => fileInput.click());
            
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.style.background = '#e3f2fd';
                uploadArea.style.borderColor = '#2196f3';
            });
            
            uploadArea.addEventListener('dragleave', () => {
                uploadArea.style.background = '';
                uploadArea.style.borderColor = '#3498db';
            });
            
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.style.background = '';
                uploadArea.style.borderColor = '#3498db';
                
                const files = e.dataTransfer.files;
                processarArquivos(files);
            });
            
            fileInput.addEventListener('change', (e) => {
                processarArquivos(e.target.files);
            });
        }

        function processarArquivos(files) {
            debugData = [];
            const promises = Array.from(files).map(file => {
                if (file.name.endsWith('.xml')) {
                    return new Promise((resolve) => {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            processarXMLReal(e.target.result, file.name);
                            resolve();
                        };
                        reader.readAsText(file);
                    });
                }
                return Promise.resolve();
            });

            Promise.all(promises).then(() => {
                atualizarResumo();
            });
        }

        function processarXMLReal(xmlContent, fileName) {
            try {
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(xmlContent, "text/xml");
                
                // Verificar se √© um XML v√°lido
                if (xmlDoc.getElementsByTagName("parsererror").length > 0) {
                    throw new Error("XML inv√°lido ou mal formado");
                }

                // Extrair dados principais da NFe
                const infNFe = xmlDoc.getElementsByTagName("infNFe")[0];
                if (!infNFe) {
                    throw new Error("Estrutura NF-e n√£o encontrada");
                }

                // Extrair UF de origem e destino
                const emit = xmlDoc.getElementsByTagName("emit")[0];
                const dest = xmlDoc.getElementsByTagName("dest")[0];
                
                if (!emit || !dest) {
                    throw new Error("Emitente ou destinat√°rio n√£o encontrado");
                }

                const emitEnder = emit.getElementsByTagName("enderEmit")[0];
                const destEnder = dest.getElementsByTagName("enderDest")[0];
                
                const emitUF = emitEnder ? emitEnder.getElementsByTagName("UF")[0]?.textContent : null;
                const destUF = destEnder ? destEnder.getElementsByTagName("UF")[0]?.textContent : null;

                if (!emitUF || !destUF) {
                    throw new Error("UF do emitente ou destinat√°rio n√£o encontrado");
                }

                // Extrair valores
                const total = xmlDoc.getElementsByTagName("total")[0];
                const ICMSTot = total ? total.getElementsByTagName("ICMSTot")[0] : null;
                
                const vNF = ICMSTot ? ICMSTot.getElementsByTagName("vNF")[0]?.textContent : "0";
                const vProd = ICMSTot ? ICMSTot.getElementsByTagName("vProd")[0]?.textContent : "0";
                const vFrete = ICMSTot ? ICMSTot.getElementsByTagName("vFrete")[0]?.textContent || "0" : "0";
                const vSeg = ICMSTot ? ICMSTot.getElementsByTagName("vSeg")[0]?.textContent || "0" : "0";

                // Determinar tipo de destinat√°rio
                const indIEDest = dest.getElementsByTagName("indIEDest")[0]?.textContent;
                let tipoDestinatario = 'consumidor';
                
                if (indIEDest === '1') {
                    tipoDestinatario = 'contribuinte';
                } else if (indIEDest === '2' || indIEDest === '9') {
                    tipoDestinatario = 'isento';
                }

                // Calcular base de c√°lculo (usar vProd como fallback se vNF n√£o dispon√≠vel)
                const baseCalculo = parseFloat(vProd) + parseFloat(vFrete) + parseFloat(vSeg);
                const valorTotal = parseFloat(vNF) || baseCalculo;

                const calculo = {
                    id: Date.now() + Math.random(),
                    fileName: fileName,
                    origem: emitUF,
                    destino: destUF,
                    tipoDestinatario: tipoDestinatario,
                    valorOperacao: parseFloat(vProd),
                    valorFrete: parseFloat(vFrete),
                    valorSeguro: parseFloat(vSeg),
                    baseCalculo: baseCalculo,
                    valorTotal: valorTotal,
                    status: 'Processado',
                    timestamp: new Date().toLocaleString(),
                    detalhes: []
                };

                debugData.push({
                    arquivo: fileName,
                    origem: emitUF,
                    destino: destUF,
                    baseCalculo: baseCalculo,
                    valorTotal: valorTotal,
                    tipoDestinatario: tipoDestinatario,
                    indIEDest: indIEDest
                });

                // Calcular DIFAL
                const resultado = calcularDIFALDetalhado(
                    calculo.origem,
                    calculo.destino,
                    calculo.tipoDestinatario,
                    calculo.baseCalculo
                );

                Object.assign(calculo, resultado);
                todosCalculos.push(calculo);
                
                atualizarTabela();
                
            } catch (error) {
                console.error('Erro ao processar XML:', error);
                debugData.push({
                    arquivo: fileName,
                    erro: error.message,
                    stack: error.stack
                });
                
                // Adicionar c√°lculo com erro para visualiza√ß√£o
                const calculoErro = {
                    id: Date.now() + Math.random(),
                    fileName: fileName,
                    origem: 'ERRO',
                    destino: 'ERRO',
                    tipoDestinatario: 'erro',
                    baseCalculo: 0,
                    valorTotal: 0,
                    status: 'Erro',
                    timestamp: new Date().toLocaleString(),
                    aplicavel: false,
                    motivo: error.message,
                    difal: 0,
                    fcp: 0,
                    total: 0
                };
                
                todosCalculos.push(calculoErro);
                atualizarTabela();
            }
        }

        function calcularDIFALDetalhado(origem, destino, tipoDestinatario, baseCalculo) {
            // Verificar aplicabilidade primeiro
            const aplicavel = verificarAplicabilidade(origem, destino, tipoDestinatario);
            
            if (!aplicavel.aplicavel) {
                return {
                    aplicavel: false,
                    motivo: aplicavel.motivo,
                    difal: 0,
                    fcp: 0,
                    total: 0,
                    aliqInterestadual: 0,
                    aliqInterna: 0,
                    detalhes: []
                };
            }
            
            // Obter al√≠quotas - usar valores padr√£o se n√£o encontrado
            const aliqInterestadual = aliquotasInterestaduais[origem]?.[destino] || 12;
            const aliqInterna = aliquotasInternas[destino] || 18;
            const percFCP = fundoPobreza[destino] || 0;
            
            // C√°lculo correto do DIFAL
            const difal = baseCalculo * (aliqInterna - aliqInterestadual) / 100;
            const fcp = baseCalculo * percFCP / 100;
            const total = difal + fcp;
            
            const detalhes = [
                { descricao: 'Base de C√°lculo', valor: baseCalculo, formula: 'Valor Produtos + Frete + Seguro' },
                { descricao: 'Al√≠quota Interestadual', valor: aliqInterestadual, formula: `${origem} ‚Üí ${destino}` },
                { descricao: 'Al√≠quota Interna Destino', valor: aliqInterna, formula: `UF ${destino}` },
                { descricao: 'Diferencial de Al√≠quota', valor: (aliqInterna - aliqInterestadual).toFixed(2), formula: `${aliqInterna}% - ${aliqInterestadual}%` },
                { descricao: 'C√°lculo DIFAL', valor: difal, formula: `R$ ${baseCalculo.toFixed(2)} √ó ${(aliqInterna - aliqInterestadual).toFixed(2)}%` },
                { descricao: 'Fundo Combate √† Pobreza', valor: percFCP, formula: `${percFCP}%` },
                { descricao: 'Valor FCP', valor: fcp, formula: `R$ ${baseCalculo.toFixed(2)} √ó ${percFCP}%` }
            ];
            
            return {
                aplicavel: true,
                origem,
                destino,
                baseCalculo,
                aliqInterestadual,
                aliqInterna,
                percFCP,
                difal,
                fcp,
                total,
                detalhes,
                motivo: ''
            };
        }

        function verificarAplicabilidade(origem, destino, tipoDestinatario) {
            // Verificar se √© opera√ß√£o interestadual
            if (origem === destino) {
                return { aplicavel: false, motivo: 'Opera√ß√£o interna (mesmo estado)' };
            }
            
            // Verificar se destinat√°rio √© contribuinte do ICMS
            // No DIFAL, mesmo contribuintes do ICMS podem ter DIFAL aplic√°vel em alguns casos
            // mas para simplificar, vamos considerar as regras mais comuns
            
            if (tipoDestinatario === 'isento') {
                return { aplicavel: false, motivo: 'Opera√ß√£o imune ou isenta' };
            }
            
            return { aplicavel: true, motivo: '' };
        }

        function atualizarTabela() {
            const tbody = document.getElementById('tabelaResultados');
            const detalhesContainer = document.getElementById('detalhesContainer');
            
            tbody.innerHTML = '';
            detalhesContainer.innerHTML = '';
            
            if (todosCalculos.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="9" style="text-align: center; padding: 20px;">
                            Nenhum resultado dispon√≠vel
                        </td>
                    </tr>
                `;
                return;
            }
            
            todosCalculos.forEach((calculo, index) => {
                const tr = document.createElement('tr');
                
                const statusClass = calculo.status === 'Erro' ? 'status-not-applicable' : 
                    calculo.aplicavel ? 
                    (calculo.difal > 0 ? 'status-applicable' : 'status-exempt') : 
                    'status-not-applicable';
                
                const statusText = calculo.status === 'Erro' ? 'Erro' :
                    calculo.aplicavel ? 
                    (calculo.difal > 0 ? 'Aplic√°vel' : 'Isento') : 
                    'N√£o Aplic√°vel';
                
                tr.innerHTML = `
                    <td title="${calculo.fileName}">${calculo.fileName.length > 20 ? calculo.fileName.substring(0, 20) + '...' : calculo.fileName}</td>
                    <td>${calculo.origem}</td>
                    <td>${calculo.destino}</td>
                    <td>R$ ${calculo.valorTotal?.toFixed(2) || calculo.baseCalculo?.toFixed(2) || '0.00'}</td>
                    <td>${calculo.aliqInterestadual?.toFixed(2) || '0.00'}%</td>
                    <td>${calculo.aliqInterna?.toFixed(2) || '0.00'}%</td>
                    <td>R$ ${calculo.difal?.toFixed(2) || '0.00'}</td>
                    <td>R$ ${calculo.fcp?.toFixed(2) || '0.00'}</td>
                    <td><span class="${statusClass}">${statusText}</span></td>
                `;
                
                if (calculo.status !== 'Erro') {
                    tr.addEventListener('click', () => mostrarDetalhes(calculo));
                    tr.style.cursor = 'pointer';
                }
                
                tbody.appendChild(tr);
            });
        }

        function mostrarDetalhes(calculo) {
            const detalhesContainer = document.getElementById('detalhesContainer');
            
            let html = `
                <div class="xml-info">
                    <h3>Detalhes do C√°lculo - ${calculo.fileName}</h3>
                    <div><strong>Origem:</strong> ${calculo.origem}</div>
                    <div><strong>Destino:</strong> ${calculo.destino}</div>
                    <div><strong>Tipo Destinat√°rio:</strong> ${calculo.tipoDestinatario}</div>
                    <div><strong>Status:</strong> ${calculo.aplicavel ? (calculo.difal > 0 ? 'DIFAL Aplic√°vel' : 'Isento') : 'N√£o Aplic√°vel'}</div>
                    ${calculo.motivo ? `<div><strong>Motivo:</strong> ${calculo.motivo}</div>` : ''}
                </div>
            `;
            
            if (calculo.aplicavel && calculo.detalhes.length > 0) {
                html += '<div class="resultado" style="display: block; background: #d4edda; padding: 15px; border-radius: 8px; margin-top: 10px;">';
                html += '<h4>Detalhamento do C√°lculo</h4>';
                
                calculo.detalhes.forEach(detalhe => {
                    html += `
                        <div class="detalhes-item">
                            <span>${detalhe.descricao}:</span>
                            <span>
                                ${typeof detalhe.valor === 'number' ? 
                                  (detalhe.descricao.includes('Al√≠quota') || detalhe.descricao.includes('Fundo') ? 
                                   `${detalhe.valor}%` : `R$ ${detalhe.valor.toFixed(2)}`) : 
                                  detalhe.valor}
                                ${detalhe.formula ? `<br><small style="color: #666;">${detalhe.formula}</small>` : ''}
                            </span>
                        </div>
                    `;
                });
                
                html += `
                    <div class="detalhes-total">
                        <span>TOTAL A RECOLHER (DIFAL + FCP):</span>
                        <span>R$ ${calculo.total.toFixed(2)}</span>
                    </div>
                `;
                
                html += '</div>';
            }
            
            detalhesContainer.innerHTML = html;
        }

        function atualizarResumo() {
            const resumoDiv = document.getElementById('resumoCalculos');
            
            const totalNFes = todosCalculos.length;
            const totalProcessados = todosCalculos.filter(c => c.status !== 'Erro').length;
            const totalErros = todosCalculos.filter(c => c.status === 'Erro').length;
            const totalAplicavel = todosCalculos.filter(c => c.aplicavel && c.difal > 0).length;
            const totalIsento = todosCalculos.filter(c => c.aplicavel && c.difal === 0).length;
            const totalNaoAplicavel = todosCalculos.filter(c => !c.aplicavel && c.status !== 'Erro').length;
            const totalValor = todosCalculos.reduce((sum, c) => sum + (c.difal || 0), 0);
            const totalFCP = todosCalculos.reduce((sum, c) => sum + (c.fcp || 0), 0);
            const totalBaseCalculo = todosCalculos.reduce((sum, c) => sum + (c.baseCalculo || 0), 0);
            
            resumoDiv.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; font-size: 14px;">
                    <div><strong>Total NF-es:</strong> ${totalNFes}</div>
                    <div><strong>Processados:</strong> ${totalProcessados}</div>
                    <div><strong>Erros:</strong> ${totalErros}</div>
                    <div><strong>DIFAL Aplic√°vel:</strong> ${totalAplicavel}</div>
                    <div><strong>Isentos:</strong> ${totalIsento}</div>
                    <div><strong>N√£o Aplic√°vel:</strong> ${totalNaoAplicavel}</div>
                    <div><strong>Total Base C√°lculo:</strong> R$ ${totalBaseCalculo.toFixed(2)}</div>
                    <div><strong>Total DIFAL:</strong> R$ ${totalValor.toFixed(2)}</div>
                    <div><strong>Total FCP:</strong> R$ ${totalFCP.toFixed(2)}</div>
                    <div><strong>Total Geral:</strong> R$ ${(totalValor + totalFCP).toFixed(2)}</div>
                </div>
            `;
        }

        function processarTodosXMLs() {
            if (todosCalculos.length === 0) {
                alert('N√£o h√° XMLs para processar. Importe alguns XMLs primeiro.');
                return;
            }
            
            alert(`Processamento conclu√≠do! ${todosCalculos.length} NF-es processadas.`);
        }

        function exportarExcel() {
            if (todosCalculos.length === 0) {
                alert('N√£o h√° dados para exportar.');
                return;
            }
            
            const dadosExcel = todosCalculos.map(calculo => ({
                'Arquivo': calculo.fileName,
                'Data Processamento': calculo.timestamp,
                'UF Origem': calculo.origem,
                'UF Destino': calculo.destino,
                'Tipo Destinat√°rio': calculo.tipoDestinatario,
                'Base C√°lculo (R$)': calculo.baseCalculo?.toFixed(2) || '0.00',
                'Valor Total NF (R$)': calculo.valorTotal?.toFixed(2) || '0.00',
                'Al√≠quota Interestadual (%)': calculo.aliqInterestadual?.toFixed(2) || '0.00',
                'Al√≠quota Interna (%)': calculo.aliqInterna?.toFixed(2) || '0.00',
                'Diferencial Al√≠quota (%)': calculo.aliqInterna && calculo.aliqInterestadual ? 
                    (calculo.aliqInterna - calculo.aliqInterestadual).toFixed(2) : '0.00',
                'FCP (%)': calculo.percFCP || '0.00',
                'Valor DIFAL (R$)': calculo.difal?.toFixed(2) || '0.00',
                'Valor FCP (R$)': calculo.fcp?.toFixed(2) || '0.00',
                'Total a Recolher (R$)': calculo.total?.toFixed(2) || '0.00',
                'Status': calculo.status === 'Erro' ? 'Erro' : 
                         calculo.aplicavel ? (calculo.difal > 0 ? 'Aplic√°vel' : 'Isento') : 'N√£o Aplic√°vel',
                'Motivo': calculo.motivo || calculo.status === 'Erro' ? 'Erro no processamento' : ''
            }));
            
            const worksheet = XLSX.utils.json_to_sheet(dadosExcel);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, 'C√°lculos DIFAL');
            
            // Auto-ajustar largura das colunas
            const colWidths = [];
            Object.keys(dadosExcel[0]).forEach(key => {
                colWidths.push({ wch: Math.max(key.length, 12) });
            });
            worksheet['!cols'] = colWidths;
            
            XLSX.writeFile(workbook, `calculos_difal_${new Date().toISOString().split('T')[0]}.xlsx`);
        }

        function limparTudo() {
            if (confirm('Tem certeza que deseja limpar todos os c√°lculos?')) {
                todosCalculos = [];
                debugData = [];
                atualizarTabela();
                atualizarResumo();
                document.getElementById('debugInfo').style.display = 'none';
                document.getElementById('resultadoManual').innerHTML = '';
            }
        }

        function mostrarDebug() {
            const debugInfo = document.getElementById('debugInfo');
            const debugContent = document.getElementById('debugContent');
            
            debugContent.innerHTML = JSON.stringify(debugData, null, 2);
            debugInfo.style.display = debugInfo.style.display === 'none' ? 'block' : 'none';
        }

        function calcularManual() {
            const ufOrigem = document.getElementById('ufOrigem').value;
            const ufDestino = document.getElementById('ufDestino').value;
            const valorBase = parseFloat(document.getElementById('valorBase').value);

            if (!ufOrigem || !ufDestino || !valorBase || valorBase <= 0) {
                alert('Por favor, preencha todos os campos com valores v√°lidos.');
                return;
            }

            const resultado = calcularDIFALDetalhado(ufOrigem, ufDestino, 'consumidor', valorBase);
            exibirResultadoManual(resultado);
        }

        function exibirResultadoManual(resultado) {
            const resultadoDiv = document.getElementById('resultadoManual');
            
            let html = '<div style="background: #d4edda; padding: 15px; border-radius: 8px; border: 2px solid #28a745;">';
            
            if (!resultado.aplicavel) {
                html = '<div style="background: #fff3cd; padding: 15px; border-radius: 8px; border: 2px solid #ffc107;">';
                html += `<h4>‚ö†Ô∏è DIFAL N√£o Aplic√°vel</h4>`;
                html += `<p><strong>Motivo:</strong> ${resultado.motivo}</p>`;
            } else {
                html += `<h4>‚úÖ Resultado do C√°lculo DIFAL</h4>`;
                
                resultado.detalhes.forEach(detalhe => {
                    html += `
                        <div class="detalhes-item">
                            <span>${detalhe.descricao}:</span>
                            <span>
                                ${typeof detalhe.valor === 'number' ? 
                                  (detalhe.descricao.includes('Al√≠quota') || detalhe.descricao.includes('Fundo') ? 
                                   `${detalhe.valor}%` : `R$ ${detalhe.valor.toFixed(2)}`) : 
                                  detalhe.valor}
                                ${detalhe.formula ? `<br><small style="color: #666;">${detalhe.formula}</small>` : ''}
                            </span>
                        </div>
                    `;
                });
                
                html += `
                    <div class="detalhes-total">
                        <span>TOTAL A RECOLHER (DIFAL + FCP):</span>
                        <span>R$ ${resultado.total.toFixed(2)}</span>
                    </div>
                    <div style="margin-top: 10px; padding: 10px; background: #c3e6cb; border-radius: 5px;">
                        <small>üí° Recolhimento via GNRE para o estado de ${resultado.destino}</small>
                    </div>
                `;
            }
            
            html += '</div>';
            resultadoDiv.innerHTML = html;
        }
    </script>
</body>
</html>
